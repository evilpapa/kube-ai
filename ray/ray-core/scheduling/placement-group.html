
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>占位组 &#8212; Ray 2.7.2</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/versionwarning.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../../_static/js/docsearch.js"></script>
    <script defer="defer" src="../../_static/js/csat.js"></script>
    <script defer="defer" src="../../_static/js/termynal.js"></script>
    <script defer="defer" src="../../_static/js/custom.js"></script>
    <script defer="defer" src="../../_static/js/top-navigation.js"></script>
    <script src="../../_static/js/tags.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/ray-core/scheduling/placement-group.html" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="内存管理" href="memory-management.html" />
    <link rel="prev" title="GPU 支持" href="../tasks/using-ray-with-gpus.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
  data-modal-disclaimer = "Results are automated and may be incorrect or contain inappropriate information. Do not include any personal data or confidential information."
  data-modal-title = "Ray Docs AI - Ask a Question"
  data-button-position-bottom = "60px"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 2.7.2</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    欢迎来到 Ray ！
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/index.html">
   概述「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/getting-started.html">
   入门
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/installation.html">
   安装「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/use-cases.html">
   用例「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/examples.html">
   示例库「1%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/ray-libraries.html">
   生态「3%」
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../walkthrough.html">
   Ray 核心「100%」
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../key-concepts.html">
     关键概念
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="../user-guide.html">
     用户指南
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="../tasks.html">
       任务
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../actors.html">
       Actors
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../objects.html">
       对象
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../handling-dependencies.html">
       环境依赖
      </a>
     </li>
     <li class="toctree-l3 current active has-children">
      <a class="reference internal" href="index.html">
       调度
      </a>
      <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
      <label for="toctree-checkbox-3">
       <i class="fas fa-chevron-down">
       </i>
      </label>
      <ul class="current">
       <li class="toctree-l4">
        <a class="reference internal" href="resources.html">
         资源
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="../tasks/using-ray-with-gpus.html">
         GPU 支持
        </a>
       </li>
       <li class="toctree-l4 current active">
        <a class="current reference internal" href="#">
         占位组
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="memory-management.html">
         内存管理
        </a>
       </li>
       <li class="toctree-l4">
        <a class="reference internal" href="ray-oom-prevention.html">
         预防 OOM
        </a>
       </li>
      </ul>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../fault-tolerance.html">
       容错
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../patterns/index.html">
       设计模型 及 反模式
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="../advanced-topics.html">
       高级主题
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../examples/overview.html">
     示例
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../api/index.html">
     Ray Core API
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../data/data.html">
   Ray 数据「75%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../train/train.html">
   Ray 训练「0%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tune/index.html">
   Ray 调参「0%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../serve/index.html">
   Ray Serve
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../rllib/index.html">
   Ray RLlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-more-libs/index.html">
   更多类库「40%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../cluster/getting-started.html">
   Ray 集群「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-observability/index.html">
   监控调试「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-references/api.html">
   参考「20%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-contribute/index.html">
   开发者指引「30%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-security/index.html">
   安全「100%」
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Fray-core/scheduling/placement-group.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/ray-core/scheduling/placement-group.rst"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/ray-core/scheduling/placement-group.rst.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.rst</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   关键概念
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     捆绑
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     占位组
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#actor">
   将任务和 actor 调度到占位组（使用预留资源）
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pgroup-strategy">
   占位策略
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id6">
   移除占位组（释放预留资源）
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ray-placement-group-observability-ref">
   观察并调试占位组
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     检查占位组调度状态
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id10">
   [高级] 子任务和 Actor
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id11">
   【高级】命名占位组
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#placement-group-detached">
   【高级】 分离占位组
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id13">
   [高级] 容错
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dead">
     在 Dead 节点重新调度捆绑包
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id14">
     为部分丢失的捆绑包提供资源
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id15">
     使用捆绑包的任务和 actor 的容错能力
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#api">
   API 参考
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>占位组</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id2">
   关键概念
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     捆绑
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     占位组
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#actor">
   将任务和 actor 调度到占位组（使用预留资源）
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#pgroup-strategy">
   占位策略
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id6">
   移除占位组（释放预留资源）
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ray-placement-group-observability-ref">
   观察并调试占位组
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     检查占位组调度状态
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id10">
   [高级] 子任务和 Actor
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id11">
   【高级】命名占位组
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#placement-group-detached">
   【高级】 分离占位组
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#id13">
   [高级] 容错
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dead">
     在 Dead 节点重新调度捆绑包
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id14">
     为部分丢失的捆绑包提供资源
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id15">
     使用捆绑包的任务和 actor 的容错能力
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#api">
   API 参考
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="id1">
<h1>占位组<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h1>
<p id="ray-placement-group-doc-ref">占位组允许用户原子地跨多个节点保留资源组（即，帮派调度）。
然后可以使用他们来调度尽可能靠近的 Ray 任务和 actor 以获得局部性（PACK）或分散（SPREAD）。
占位组通常用于帮派调度 actor，但也支持任务。</p>
<p>以下是一些真实用例：</p>
<ul class="simple">
<li><p><strong>分布式机器学习训练</strong> 分布式训练（诸如：<a class="reference internal" href="../../train/train.html#train-docs"><span class="std std-ref">Ray Train</span></a> 和 <a class="reference internal" href="../../tune/index.html#tune-main"><span class="std std-ref">Ray Tune</span></a>）使用占位组 API 来实现帮派调度。在这些设置中，一个试验的所有资源必须同时可用。帮派调度是实现深度学习训练的全有或全无调度的关键技术。</p></li>
<li><p><strong>分布式训练的容错能力</strong> 占位组可用于配置容错能力。在 Ray Tune 中，将单个试验的相关资源打包在一起可能是有益的，以便节点故障影响较少的试验。在支持弹性训练的库中（例如：XGBoost-Ray），将资源分布在多个节点上有助于确保即使节点死机，训练也会继续进行。</p></li>
</ul>
<section id="id2">
<h2>关键概念<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h2>
<section id="id3">
<h3>捆绑<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h3>
<p><strong>捆绑</strong> 是“资源”的结合。它可以是单个资源，<code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1}</span></code>，也可以是一组资源，<code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1,</span> <span class="pre">&quot;GPU&quot;:</span> <span class="pre">4}</span></code>。
捆绑包是占位组的预留资源。“调度捆绑包”意味着我们找到一个适合捆绑包的节点，并预留捆绑包指定的资源。
捆绑包必须能够适合 Ray 集群上的单个节点。例如，如果您只有一个 8 CPU 节点，并且您有一个需要 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">9}</span></code> 的捆绑包，那么此捆绑包无法调度。</p>
</section>
<section id="id4">
<h3>占位组<a class="headerlink" href="#id4" title="Permalink to this headline">#</a></h3>
<p><strong>占位组</strong> 会从集群预留资源。预留资源只能被使用 <a class="reference internal" href="#ray-placement-group-schedule-tasks-actors-ref"><span class="std std-ref">PlacementGroupSchedulingStrategy</span></a> 的任务或 actor 使用。</p>
<ul class="simple">
<li><p>占位组由一串捆绑包组成。例如，<code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1}</span> <span class="pre">*</span> <span class="pre">4</span></code> 意味着您想要预留 4 个 1 CPU 的捆绑包（即，它预留了 4 个 CPU）。</p></li>
<li><p>捆绑包然后根据 <a class="reference internal" href="#pgroup-strategy"><span class="std std-ref">placement strategies</span></a> 在集群的节点上放置。</p></li>
<li><p>创建占位组后，任务或 actor 可以根据占位组甚至在单个捆绑包上调度。</p></li>
</ul>
<p>Create a Placement Group (Reserve Resources)
创建占位组（预留资源）
——————————————–</p>
<p>你可以使用 <code class="xref py py-func docutils literal notranslate"><span class="pre">ray.util.placement_group()</span></code> 创建占位组。
占位组接受捆绑包列表和 <a class="reference internal" href="#pgroup-strategy"><span class="std std-ref">placement strategy</span></a>。
注意，每个捆绑包必须能够适合 Ray 集群上的单个节点。
例如，如果一个节点只有 8 个 CPU，而您有一个需要 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">9}</span></code> 的捆绑包，那么此捆绑包无法调度。</p>
<p>捆绑包由字典列表指定，例如，<code class="docutils literal notranslate"><span class="pre">[{&quot;CPU&quot;:</span> <span class="pre">1},</span> <span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1,</span> <span class="pre">&quot;GPU&quot;:</span> <span class="pre">1}]</span></code>。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">CPU</span></code> 对应于 <a class="reference internal" href="../api/doc/ray.remote.html#ray.remote" title="ray.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">ray.remote</span></code></a> 中使用的 <code class="docutils literal notranslate"><span class="pre">num_cpus</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GPU</span></code> 对应于 <a class="reference internal" href="../api/doc/ray.remote.html#ray.remote" title="ray.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">ray.remote</span></code></a> 中使用的 <code class="docutils literal notranslate"><span class="pre">num_gpus</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">memory</span></code> 对应于 <a class="reference internal" href="../api/doc/ray.remote.html#ray.remote" title="ray.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">ray.remote</span></code></a> 中使用的 <code class="docutils literal notranslate"><span class="pre">memory</span></code>。</p></li>
<li><p>其他资源对应于 <a class="reference internal" href="../api/doc/ray.remote.html#ray.remote" title="ray.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">ray.remote</span></code></a> 中使用的 <code class="docutils literal notranslate"><span class="pre">resources``（例如，``ray.init(resources={&quot;disk&quot;:</span> <span class="pre">1})</span></code> 可以有 <code class="docutils literal notranslate"><span class="pre">{&quot;disk&quot;:</span> <span class="pre">1}</span></code> 的捆绑包）。</p></li>
</ul>
<p>占位组调度是异步的。<a class="reference internal" href="../api/doc/ray.util.placement_group.html#ray.util.placement_group" title="ray.util.placement_group"><code class="xref py py-obj docutils literal notranslate"><span class="pre">ray.util.placement_group</span></code></a> 立即返回。</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-0">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Import placement group APIs.</span>
<span class="kn">from</span> <span class="nn">ray.util.placement_group</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">placement_group</span><span class="p">,</span>
    <span class="n">placement_group_table</span><span class="p">,</span>
    <span class="n">remove_placement_group</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ray.util.scheduling_strategies</span> <span class="kn">import</span> <span class="n">PlacementGroupSchedulingStrategy</span>

<span class="c1"># Initialize Ray.</span>
<span class="kn">import</span> <span class="nn">ray</span>

<span class="c1"># Create a single node Ray cluster with 2 CPUs and 2 GPUs.</span>
<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_gpus</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Reserve a placement group of 1 bundle that reserves 1 CPU and 1 GPU.</span>
<span class="n">pg</span> <span class="o">=</span> <span class="n">placement_group</span><span class="p">([{</span><span class="s2">&quot;CPU&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;GPU&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}])</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-1">
Java</label><div class="sd-tab-content docutils">
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Initialize Ray.</span><span class="w"></span>
<span class="n">Ray</span><span class="p">.</span><span class="na">init</span><span class="p">();</span><span class="w"></span>

<span class="c1">// Construct a list of bundles.</span><span class="w"></span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bundle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmutableMap</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;CPU&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span><span class="w"></span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">bundles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmutableList</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">bundle</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Make a creation option with bundles and strategy.</span><span class="w"></span>
<span class="n">PlacementGroupCreationOptions</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">PlacementGroupCreationOptions</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="na">setBundles</span><span class="p">(</span><span class="n">bundles</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="na">setStrategy</span><span class="p">(</span><span class="n">PlacementStrategy</span><span class="p">.</span><span class="na">STRICT_SPREAD</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="n">PlacementGroup</span><span class="w"> </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlacementGroups</span><span class="p">.</span><span class="na">createPlacementGroup</span><span class="p">(</span><span class="n">options</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-2" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-2">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Initialize Ray.</span>
<span class="n">ray</span><span class="o">::</span><span class="n">Init</span><span class="p">();</span><span class="w"></span>

<span class="c1">// Construct a list of bundles.</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">bundles</span><span class="p">{{{</span><span class="s">&quot;CPU&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}}};</span><span class="w"></span>

<span class="c1">// Make a creation option with bundles and strategy.</span>
<span class="n">ray</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">PlacementGroupCreationOptions</span><span class="w"> </span><span class="n">options</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;my_pg&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bundles</span><span class="p">,</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">internal</span><span class="o">::</span><span class="n">PlacementStrategy</span><span class="o">::</span><span class="n">PACK</span><span class="p">};</span><span class="w"></span>

<span class="n">ray</span><span class="o">::</span><span class="n">PlacementGroup</span><span class="w"> </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">CreatePlacementGroup</span><span class="p">(</span><span class="n">options</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>你可以使用以下两个 API 之一阻塞程序，直到占位组准备就绪：</p>
<ul class="simple">
<li><p><a class="reference internal" href="../api/doc/ray.util.placement_group.PlacementGroup.ready.html#ray.util.placement_group.PlacementGroup.ready" title="ray.util.placement_group.PlacementGroup.ready"><code class="xref py py-func docutils literal notranslate"><span class="pre">ready</span></code></a>，兼容 <code class="docutils literal notranslate"><span class="pre">ray.get</span></code></p></li>
<li><p><a class="reference internal" href="../api/doc/ray.util.placement_group.PlacementGroup.wait.html#ray.util.placement_group.PlacementGroup.wait" title="ray.util.placement_group.PlacementGroup.wait"><code class="xref py py-func docutils literal notranslate"><span class="pre">wait</span></code></a>，阻塞程序直到占位组准备就绪）</p></li>
</ul>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-3" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-3">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Wait until placement group is created.</span>
<span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">ready</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># You can also use ray.wait.</span>
<span class="n">ready</span><span class="p">,</span> <span class="n">unready</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">wait</span><span class="p">([</span><span class="n">pg</span><span class="o">.</span><span class="n">ready</span><span class="p">()],</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># You can look at placement group states using this API.</span>
<span class="nb">print</span><span class="p">(</span><span class="n">placement_group_table</span><span class="p">(</span><span class="n">pg</span><span class="p">))</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-4" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-4">
Java</label><div class="sd-tab-content docutils">
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Wait for the placement group to be ready within the specified time(unit is seconds).</span><span class="w"></span>
<span class="kt">boolean</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pg</span><span class="p">.</span><span class="na">wait</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span><span class="w"></span>
<span class="n">Assert</span><span class="p">.</span><span class="na">assertTrue</span><span class="p">(</span><span class="n">ready</span><span class="p">);</span><span class="w"></span>

<span class="c1">// You can look at placement group states using this API.</span><span class="w"></span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">PlacementGroup</span><span class="o">&gt;</span><span class="w"> </span><span class="n">allPlacementGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlacementGroups</span><span class="p">.</span><span class="na">getAllPlacementGroups</span><span class="p">();</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">PlacementGroup</span><span class="w"> </span><span class="n">group</span><span class="p">:</span><span class="w"> </span><span class="n">allPlacementGroup</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">group</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-5" name="sd-tab-set-1" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-5">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Wait for the placement group to be ready within the specified time(unit is seconds).</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">ready</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pg</span><span class="p">.</span><span class="n">Wait</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">ready</span><span class="p">);</span><span class="w"></span>

<span class="c1">// You can look at placement group states using this API.</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ray</span><span class="o">::</span><span class="n">PlacementGroup</span><span class="o">&gt;</span><span class="w"> </span><span class="n">all_placement_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">GetAllPlacementGroups</span><span class="p">();</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">PlacementGroup</span><span class="w"> </span><span class="o">&amp;</span><span class="n">group</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">all_placement_group</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">group</span><span class="p">.</span><span class="n">GetName</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<p>让我们验证占位组已成功创建。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># This API is only available when you download Ray via `pip install &quot;ray[default]&quot;`</span>
ray list placement-groups
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">========</span> List: <span class="m">2023</span>-04-07 <span class="m">01</span>:15:05.682519 <span class="o">========</span>
Stats:
------------------------------
Total: <span class="m">1</span>

Table:
------------------------------
    PLACEMENT_GROUP_ID                    NAME      CREATOR_JOB_ID  STATE
<span class="m">0</span>  3cd6174711f47c14132155039c0501000000                  <span class="m">01000000</span>  CREATED
</pre></div>
</div>
<p>占位组成功创建。在 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">2,</span> <span class="pre">&quot;GPU&quot;:</span> <span class="pre">2}</span></code> 资源中，占位组预留了 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1,</span> <span class="pre">&quot;GPU&quot;:</span> <span class="pre">1}</span></code>。
预留的资源只能在调度任务或 actor 时使用占位组。
下图展示了占位组预留的 “1 CPU 和 1 GPU” 捆绑包。</p>
<img alt="../../_images/pg_image_1.png" class="align-center" src="../../_images/pg_image_1.png" />
<p>占位组是自动创建的；如果一个捆绑包无法适合当前节点，整个占位组将无法准备就绪，也不会预留资源。
为了说明这一点，让我们创建另一个需要 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:1},</span> <span class="pre">{&quot;GPU&quot;:</span> <span class="pre">2}</span></code> 的占位组（2 个捆绑包）。</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-6" name="sd-tab-set-2" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-6">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cannot create this placement group because we</span>
<span class="c1"># cannot create a {&quot;GPU&quot;: 2} bundle.</span>
<span class="n">pending_pg</span> <span class="o">=</span> <span class="n">placement_group</span><span class="p">([{</span><span class="s2">&quot;CPU&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;GPU&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}])</span>
<span class="c1"># This raises the timeout exception!</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pending_pg</span><span class="o">.</span><span class="n">ready</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;Cannot create a placement group because &quot;</span>
        <span class="s2">&quot;{&#39;GPU&#39;: 2} bundle cannot be created.&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>你可以验证新的占位组正在等待创建。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># This API is only available when you download Ray via `pip install &quot;ray[default]&quot;`</span>
ray list placement-groups
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">========</span> List: <span class="m">2023</span>-04-07 <span class="m">01</span>:16:23.733410 <span class="o">========</span>
Stats:
------------------------------
Total: <span class="m">2</span>

Table:
------------------------------
    PLACEMENT_GROUP_ID                    NAME      CREATOR_JOB_ID  STATE
<span class="m">0</span>  3cd6174711f47c14132155039c0501000000                  <span class="m">01000000</span>  CREATED
<span class="m">1</span>  e1b043bebc751c3081bddc24834d01000000                  <span class="m">01000000</span>  PENDING &lt;---- the new placement group.
</pre></div>
</div>
<p>你还可以使用 <code class="docutils literal notranslate"><span class="pre">ray</span> <span class="pre">status</span></code> CLI 命令验证 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1,</span> <span class="pre">&quot;GPU&quot;:</span> <span class="pre">2}</span></code> 捆绑包无法分配。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ray status
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Resources
---------------------------------------------------------------
Usage:
<span class="m">0</span>.0/2.0 CPU <span class="o">(</span><span class="m">0</span>.0 used of <span class="m">1</span>.0 reserved <span class="k">in</span> placement groups<span class="o">)</span>
<span class="m">0</span>.0/2.0 GPU <span class="o">(</span><span class="m">0</span>.0 used of <span class="m">1</span>.0 reserved <span class="k">in</span> placement groups<span class="o">)</span>
0B/3.46GiB memory
0B/1.73GiB object_store_memory

Demands:
<span class="o">{</span><span class="s1">&#39;CPU&#39;</span>: <span class="m">1</span>.0<span class="o">}</span> * <span class="m">1</span>, <span class="o">{</span><span class="s1">&#39;GPU&#39;</span>: <span class="m">2</span>.0<span class="o">}</span> * <span class="m">1</span> <span class="o">(</span>PACK<span class="o">)</span>: <span class="m">1</span>+ pending placement groups &lt;--- <span class="m">1</span> placement group is pending creation.
</pre></div>
</div>
<p>当前集群有 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">2,</span> <span class="pre">&quot;GPU&quot;:</span> <span class="pre">2}</span></code>。我们已经创建了一个 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1,</span> <span class="pre">&quot;GPU&quot;:</span> <span class="pre">1}</span></code> 捆绑包，所以集群中只剩下 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1,</span> <span class="pre">&quot;GPU&quot;:</span> <span class="pre">1}</span></code>。
如果创建两个捆绑包 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1},</span> <span class="pre">{&quot;GPU&quot;:</span> <span class="pre">2}</span></code>，我们可以成功创建第一个捆绑包，但无法调度第二个捆绑包。
由于我们无法在集群上创建每个捆绑包，占位组未创建，包括 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1}</span></code> 捆绑包。</p>
<img alt="../../_images/pg_image_2.png" class="align-center" src="../../_images/pg_image_2.png" />
<p>当占位组以任何方式调度是，它被称为“不可行”。
想象一下，您调度 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">4}</span></code> 捆绑包，但您只有一个具有 2 个 CPU 的节点。在您的集群中无法创建此捆绑包。
Ray 自动调度器会自动扩展集群，以确保可以根据需要放置挂起的组。</p>
<p>如果 Ray Autoscaler 无法提供资源来调度置放组，Ray <strong>不会</strong> 打印有关不可行组以及使用这些组的任务和 actor 的警告。
你可以从 <a class="reference internal" href="#ray-placement-group-observability-ref"><span class="std std-ref">dashboard 或状态 API</span></a> 观察占位组的调度状态。</p>
</section>
</section>
<section id="actor">
<span id="ray-placement-group-schedule-tasks-actors-ref"></span><h2>将任务和 actor 调度到占位组（使用预留资源）<a class="headerlink" href="#actor" title="Permalink to this headline">#</a></h2>
<p>上一节中，我们创建了一个占位组，从一个 2 CPU 和 2 GPU 的节点中预留了 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1,</span> <span class="pre">&quot;GPU:</span> <span class="pre">1&quot;}</span></code>。</p>
<p>现在让我们将 actor 调度到占位组中。
你可以使用 <a class="reference internal" href="../api/doc/ray.util.scheduling_strategies.PlacementGroupSchedulingStrategy.html#ray.util.scheduling_strategies.PlacementGroupSchedulingStrategy" title="ray.util.scheduling_strategies.PlacementGroupSchedulingStrategy"><code class="xref py py-class docutils literal notranslate"><span class="pre">options(scheduling_strategy=PlacementGroupSchedulingStrategy(...))</span></code></a> 来调度 actor 或任务到占位组。</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-7" name="sd-tab-set-3" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-7">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Actor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="c1"># Create an actor to a placement group.</span>
<span class="n">actor</span> <span class="o">=</span> <span class="n">Actor</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
    <span class="n">scheduling_strategy</span><span class="o">=</span><span class="n">PlacementGroupSchedulingStrategy</span><span class="p">(</span>
        <span class="n">placement_group</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>

<span class="c1"># Verify the actor is scheduled.</span>
<span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">actor</span><span class="o">.</span><span class="n">ready</span><span class="o">.</span><span class="n">remote</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-8" name="sd-tab-set-3" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-8">
Java</label><div class="sd-tab-content docutils">
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Counter</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">Counter</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">initValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initValue</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">ping</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;pong&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Create GPU actors on a gpu bundle.</span><span class="w"></span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">Ray</span><span class="p">.</span><span class="na">actor</span><span class="p">(</span><span class="n">Counter</span><span class="p">::</span><span class="k">new</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="na">setPlacementGroup</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="na">remote</span><span class="p">();</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-9" name="sd-tab-set-3" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-9">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Counter</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="k">public</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="n">Counter</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">init_value</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="n">init_value</span><span class="p">){}</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">GetValue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="k">return</span><span class="w"> </span><span class="n">value</span><span class="p">;}</span><span class="w"></span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">Ping</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;pong&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="k">private</span><span class="o">:</span><span class="w"></span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">value</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="c1">// Factory function of Counter class.</span>
<span class="k">static</span><span class="w"> </span><span class="n">Counter</span><span class="w"> </span><span class="o">*</span><span class="nf">CreateCounter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Counter</span><span class="p">();</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">RAY_REMOTE</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Counter</span><span class="o">::</span><span class="n">Ping</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">Counter</span><span class="o">::</span><span class="n">GetValue</span><span class="p">,</span><span class="w"> </span><span class="n">CreateCounter</span><span class="p">);</span><span class="w"></span>

<span class="c1">// Create GPU actors on a gpu bundle.</span>
<span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">index</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="n">ray</span><span class="o">::</span><span class="n">Actor</span><span class="p">(</span><span class="n">CreateCounter</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">SetPlacementGroup</span><span class="p">(</span><span class="n">pg</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">Remote</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>但你使用带有占位组的 actor，请始终指定 <code class="docutils literal notranslate"><span class="pre">num_cpus</span></code>。</p>
<p>当你不指定（例如，<code class="docutils literal notranslate"><span class="pre">num_cpus=0</span></code>）时，占位组选项被忽略，任务和 actor 不使用预留资源。</p>
<p>注意默认的情况下（没有传递参数给 <code class="docutils literal notranslate"><span class="pre">ray.remote</span></code>），</p>
<ul class="simple">
<li><p>Ray 任务需要 1 个 CPU</p></li>
<li><p>Ray actor 需要在调度后需要 1 个 CPU。但在创建后，它占用 0 个 CPU。</p></li>
</ul>
<p>当调度一个无需资源和需要占位组的 actor，占位组必须被创建（因为它需要 1 个 CPU 来调度）。
但是，当 actor 被调度时，它会使用占位组的资源。</p>
</div>
<p>actor 现在已调度！一个捆绑包可以被多个任务和 actor 使用（即，捆绑包到任务（或 actor）是一对多的关系）。
这种情况下，由于 actor 使用 1 个 CPU，1 个 CPU 会从捆绑包被占用。你可以从 CLI 命令 <code class="docutils literal notranslate"><span class="pre">ray</span> <span class="pre">status</span></code> 验证这一点。
你能看到 1 个 CPU 被占位组预留，1.0 被使用（由我们创建的 actor）。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ray status
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Resources
---------------------------------------------------------------
Usage:
<span class="m">1</span>.0/2.0 CPU <span class="o">(</span><span class="m">1</span>.0 used of <span class="m">1</span>.0 reserved <span class="k">in</span> placement groups<span class="o">)</span> &lt;---
<span class="m">0</span>.0/2.0 GPU <span class="o">(</span><span class="m">0</span>.0 used of <span class="m">1</span>.0 reserved <span class="k">in</span> placement groups<span class="o">)</span>
0B/4.29GiB memory
0B/2.00GiB object_store_memory

Demands:
<span class="o">(</span>no resource demands<span class="o">)</span>
</pre></div>
</div>
<p>你也可以使用 <code class="docutils literal notranslate"><span class="pre">ray</span> <span class="pre">list</span> <span class="pre">actors</span></code> 验证 actor 已创建。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># This API is only available when you download Ray via `pip install &quot;ray[default]&quot;`</span>
ray list actors --detail
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>-   actor_id: b5c990f135a7b32bfbb05e1701000000
    class_name: Actor
    death_cause: null
    is_detached: <span class="nb">false</span>
    job_id: <span class="s1">&#39;01000000&#39;</span>
    name: <span class="s1">&#39;&#39;</span>
    node_id: b552ca3009081c9de857a31e529d248ba051a4d3aeece7135dde8427
    pid: <span class="m">8795</span>
    placement_group_id: d2e660ac256db230dbe516127c4a01000000 &lt;------
    ray_namespace: e5b19111-306c-4cd8-9e4f-4b13d42dff86
    repr_name: <span class="s1">&#39;&#39;</span>
    required_resources:
        CPU_group_d2e660ac256db230dbe516127c4a01000000: <span class="m">1</span>.0
    serialized_runtime_env: <span class="s1">&#39;{}&#39;</span>
    state: ALIVE
</pre></div>
</div>
<p>由于还有 1 个 GPU，让我们创建一个需要 1 个 GPU 的新 actor。
这次，我们还指定了 <code class="docutils literal notranslate"><span class="pre">placement_group_bundle_index</span></code>。在占位组中，每个捆绑包都有一个“索引”。
比如，一个包含 2 个捆绑包的占位组 <code class="docutils literal notranslate"><span class="pre">[{&quot;CPU&quot;:</span> <span class="pre">1},</span> <span class="pre">{&quot;GPU&quot;:</span> <span class="pre">1}]</span></code> 有索引 0 捆绑包 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">1}</span></code> 和索引 1 捆绑包 <code class="docutils literal notranslate"><span class="pre">{&quot;GPU&quot;:</span> <span class="pre">1}</span></code>。
由于我们只有 1 个捆绑包，我们只有索引 0。如果你不指定捆绑包，actor（或任务）将被调度到一个具有未分配预留资源的随机捆绑包。</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-10" name="sd-tab-set-4" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-10">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_gpus</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Actor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>


<span class="c1"># Create a GPU actor on the first bundle of index 0.</span>
<span class="n">actor2</span> <span class="o">=</span> <span class="n">Actor</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
    <span class="n">scheduling_strategy</span><span class="o">=</span><span class="n">PlacementGroupSchedulingStrategy</span><span class="p">(</span>
        <span class="n">placement_group</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span>
        <span class="n">placement_group_bundle_index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>

<span class="c1"># Verify that the GPU actor is scheduled.</span>
<span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">actor2</span><span class="o">.</span><span class="n">ready</span><span class="o">.</span><span class="n">remote</span><span class="p">(),</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>我们成功调度了 GPU actor！下图描述了调度到占位组中的 2 个 actor。</p>
<img alt="../../_images/pg_image_3.png" class="align-center" src="../../_images/pg_image_3.png" />
<p>你可以使用 <code class="docutils literal notranslate"><span class="pre">ray</span> <span class="pre">status</span></code> 命令验证所有预留资源都被使用。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ray status
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Resources
---------------------------------------------------------------
Usage:
<span class="m">1</span>.0/2.0 CPU <span class="o">(</span><span class="m">1</span>.0 used of <span class="m">1</span>.0 reserved <span class="k">in</span> placement groups<span class="o">)</span>
<span class="m">1</span>.0/2.0 GPU <span class="o">(</span><span class="m">1</span>.0 used of <span class="m">1</span>.0 reserved <span class="k">in</span> placement groups<span class="o">)</span> &lt;----
0B/4.29GiB memory
0B/2.00GiB object_store_memory
</pre></div>
</div>
</section>
<section id="pgroup-strategy">
<span id="id5"></span><h2>占位策略<a class="headerlink" href="#pgroup-strategy" title="Permalink to this headline">#</a></h2>
<p>占位组提供的一个功能是在捆绑包之间添加放置约束。</p>
<p>比如，你想要将捆绑包放置在同一个节点上，或者尽可能地分散到多个节点上。你可以通过 <code class="docutils literal notranslate"><span class="pre">strategy</span></code> 参数指定策略。
这样，你可以确保你的 actor 和任务可以根据某些放置约束调度进行调度。</p>
<p>这个示例使用了 <code class="docutils literal notranslate"><span class="pre">PACK</span></code> 策略创建了一个捆绑包，两个捆绑包必须在同一个节点上创建。
注意，这是一个软策略。如果捆绑包无法放置在单个节点上，它们将分散到其他节点。
如果你不想遇到这个问题，你可以使用 <code class="docutils literal notranslate"><span class="pre">STRICT_PACK</span></code> 策略，如果无法满足放置要求，它将无法创建占位组。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Reserve a placement group of 2 bundles</span>
<span class="c1"># that have to be packed on the same node.</span>
<span class="n">pg</span> <span class="o">=</span> <span class="n">placement_group</span><span class="p">([{</span><span class="s2">&quot;CPU&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;GPU&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}],</span> <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;PACK&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>下图演示了 PACK 策略。三个 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">2}</span></code> 捆绑包位于同一节点上。</p>
<img alt="../../_images/pg_image_4.png" class="align-center" src="../../_images/pg_image_4.png" />
<p>下图演示了 SPREAD 策略。三个 <code class="docutils literal notranslate"><span class="pre">{&quot;CPU&quot;:</span> <span class="pre">2}</span></code> 捆绑包位于三个不同的节点上。</p>
<img alt="../../_images/pg_image_5.png" class="align-center" src="../../_images/pg_image_5.png" />
<p>Ray 支持四种占位组策略。默认调度策略是 <code class="docutils literal notranslate"><span class="pre">PACK</span></code>。</p>
<p><strong>STRICT_PACK</strong></p>
<p>所有的捆绑包必须放置在集群上的单个节点上。当你想要最大化局部性时使用此策略。</p>
<p><strong>PACK</strong></p>
<p>所有提供的捆绑包尽可能地放置在单个节点上。
如果无法严格打包（即，某些捆绑包无法放置在节点上），捆绑包可以放置在其他节点上。</p>
<p><strong>STRICT_SPREAD</strong></p>
<p>每个捆绑包必须放置在不同的节点上。</p>
<p><strong>SPREAD</strong></p>
<p>每个捆绑包尽可能地分散到不同的节点上。
如果无法严格分散（即，某些捆绑包无法放置在不同的节点上），捆绑包可以放置在重叠的节点上。</p>
</section>
<section id="id6">
<h2>移除占位组（释放预留资源）<a class="headerlink" href="#id6" title="Permalink to this headline">#</a></h2>
<p>默认的，占位组的生命周期是由创建占位组的驱动程序控制的（除非你将其设置为 <a class="reference internal" href="#placement-group-detached"><span class="std std-ref">detached placement group</span></a>）。
当占位组是从一个 <a class="reference internal" href="../actors/named-actors.html#actor-lifetimes"><span class="std std-ref">detached actor</span></a> 创建的，生命周期是由分离的 actor 控制的。
在 Ray，驱动程序是调用 <code class="docutils literal notranslate"><span class="pre">ray.init</span></code> 的 Python 脚本。</p>
<p>当创建占位组的驱动程序或分离的 actor 退出，预留资源（捆绑包）从占位组中被释放。
要手动释放预留资源，使用 <a class="reference internal" href="../api/doc/ray.util.remove_placement_group.html#ray.util.remove_placement_group" title="ray.util.remove_placement_group"><code class="xref py py-func docutils literal notranslate"><span class="pre">remove_placement_group</span></code></a> API（这也是一个异步 API）。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>当您删除占位组时，仍然使用预留资源的 actor 或任务将被强制终止。</p>
</div>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-11" name="sd-tab-set-5" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-11">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This API is asynchronous.</span>
<span class="n">remove_placement_group</span><span class="p">(</span><span class="n">pg</span><span class="p">)</span>

<span class="c1"># Wait until placement group is killed.</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Check that the placement group has died.</span>
<span class="n">pprint</span><span class="p">(</span><span class="n">placement_group_table</span><span class="p">(</span><span class="n">pg</span><span class="p">))</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">{&#39;bundles&#39;: {0: {&#39;GPU&#39;: 1.0}, 1: {&#39;CPU&#39;: 1.0}},</span>
<span class="sd">&#39;name&#39;: &#39;unnamed_group&#39;,</span>
<span class="sd">&#39;placement_group_id&#39;: &#39;40816b6ad474a6942b0edb45809b39c3&#39;,</span>
<span class="sd">&#39;state&#39;: &#39;REMOVED&#39;,</span>
<span class="sd">&#39;strategy&#39;: &#39;PACK&#39;}</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-12" name="sd-tab-set-5" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-12">
Java</label><div class="sd-tab-content docutils">
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">PlacementGroups</span><span class="p">.</span><span class="na">removePlacementGroup</span><span class="p">(</span><span class="n">placementGroup</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w"></span>

<span class="n">PlacementGroup</span><span class="w"> </span><span class="n">removedPlacementGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlacementGroups</span><span class="p">.</span><span class="na">getPlacementGroup</span><span class="p">(</span><span class="n">placementGroup</span><span class="p">.</span><span class="na">getId</span><span class="p">());</span><span class="w"></span>
<span class="n">Assert</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="n">removedPlacementGroup</span><span class="p">.</span><span class="na">getState</span><span class="p">(),</span><span class="w"> </span><span class="n">PlacementGroupState</span><span class="p">.</span><span class="na">REMOVED</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-13" name="sd-tab-set-5" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-13">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">ray</span><span class="o">::</span><span class="n">RemovePlacementGroup</span><span class="p">(</span><span class="n">placement_group</span><span class="p">.</span><span class="n">GetID</span><span class="p">());</span><span class="w"></span>

<span class="n">ray</span><span class="o">::</span><span class="n">PlacementGroup</span><span class="w"> </span><span class="n">removed_placement_group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">GetPlacementGroup</span><span class="p">(</span><span class="n">placement_group</span><span class="p">.</span><span class="n">GetID</span><span class="p">());</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="n">removed_placement_group</span><span class="p">.</span><span class="n">GetState</span><span class="p">(),</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">PlacementGroupState</span><span class="o">::</span><span class="n">REMOVED</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="ray-placement-group-observability-ref">
<span id="id7"></span><h2>观察并调试占位组<a class="headerlink" href="#ray-placement-group-observability-ref" title="Permalink to this headline">#</a></h2>
<p>Ray 提供了几个有用的工具来检查占位组状态和资源使用。</p>
<ul class="simple">
<li><p><strong>Ray Status</strong> 是一个 CLI 工具，用于查看占位组的资源使用情况和调度资源需求。</p></li>
<li><p><strong>Ray 面板</strong> 是一个 UI 工具，用于检查占位组状态。</p></li>
<li><p><strong>Ray 状态 API</strong> 是一个 CLI，用于检查占位组状态。</p></li>
</ul>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-14" name="sd-tab-set-6" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-14">
ray status (CLI)</label><div class="sd-tab-content docutils">
<p><code class="docutils literal notranslate"><span class="pre">ray</span> <span class="pre">status</span></code> CLI 命令行工具提供集群的自动缩放状态。
它提供了未调度的占位组的“资源需求”以及资源预留状态。</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>Resources
---------------------------------------------------------------
Usage:
<span class="m">1</span>.0/2.0 CPU <span class="o">(</span><span class="m">1</span>.0 used of <span class="m">1</span>.0 reserved <span class="k">in</span> placement groups<span class="o">)</span>
<span class="m">0</span>.0/2.0 GPU <span class="o">(</span><span class="m">0</span>.0 used of <span class="m">1</span>.0 reserved <span class="k">in</span> placement groups<span class="o">)</span>
0B/4.29GiB memory
0B/2.00GiB object_store_memory
</pre></div>
</div>
</div>
<input id="sd-tab-item-15" name="sd-tab-set-6" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-15">
Dashboard</label><div class="sd-tab-content docutils">
<p><a class="reference internal" href="../../ray-observability/getting-started.html#dash-jobs-view"><span class="std std-ref">Ray 任务视图</span></a> 提供了占位组表，显示了占位组的调度状态和元数据。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ray 面板只能在您使用 <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">&quot;ray[default]&quot;</span></code> 安装 Ray 时使用。</p>
</div>
</div>
<input id="sd-tab-item-16" name="sd-tab-set-6" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-16">
Ray State API</label><div class="sd-tab-content docutils">
<p><a class="reference internal" href="../../ray-observability/user-guides/cli-sdk.html#state-api-overview-ref"><span class="std std-ref">Ray state API</span></a> 是一个 CLI 工具，用于检查 Ray 资源（任务、actor、占位组等）的状态。</p>
<p><code class="docutils literal notranslate"><span class="pre">ray</span> <span class="pre">list</span> <span class="pre">placement-groups</span></code> 提供了占位组的元数据和调度状态。
<code class="docutils literal notranslate"><span class="pre">ray</span> <span class="pre">list</span> <span class="pre">placement-groups</span> <span class="pre">--detail</span></code> 提供了更详细的统计信息和调度状态。</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>状态 API 仅在您使用 <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">&quot;ray[default]&quot;</span></code> 安装 Ray 时可用。</p>
</div>
</div>
</div>
<section id="id8">
<h3>检查占位组调度状态<a class="headerlink" href="#id8" title="Permalink to this headline">#</a></h3>
<p>通过以上工具，你可以查看占位组的状态。状态的定义在以下文件中指定：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/ray-project/ray/blob/03a9d2166988b16b7cbf51dac0e6e586455b28d8/src/ray/protobuf/gcs.proto#L579">高级 state</a></p></li>
<li><p><a class="reference external" href="https://github.com/ray-project/ray/blob/03a9d2166988b16b7cbf51dac0e6e586455b28d8/src/ray/protobuf/gcs.proto#L524">细节</a></p></li>
</ul>
<img alt="../../_images/pg_image_6.png" class="align-center" src="../../_images/pg_image_6.png" />
</section>
</section>
<section id="id10">
<h2>[高级] 子任务和 Actor<a class="headerlink" href="#id10" title="Permalink to this headline">#</a></h2>
<p>默认的，子 actor 和任务不共享父 actor 使用的占位组。
要自动将子 actor 或任务调度到相同的占位组，将 <code class="docutils literal notranslate"><span class="pre">placement_group_capture_child_tasks</span></code> 设置为 True。</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-17" name="sd-tab-set-7" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-17">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">ray.util.placement_group</span> <span class="kn">import</span> <span class="n">placement_group</span>
<span class="kn">from</span> <span class="nn">ray.util.scheduling_strategies</span> <span class="kn">import</span> <span class="n">PlacementGroupSchedulingStrategy</span>

<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># Create a placement group.</span>
<span class="n">pg</span> <span class="o">=</span> <span class="n">placement_group</span><span class="p">([{</span><span class="s2">&quot;CPU&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}])</span>
<span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">ready</span><span class="p">())</span>


<span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">child</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">time</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>


<span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">parent</span><span class="p">():</span>
    <span class="c1"># The child task is scheduled to the same placement group as its parent,</span>
    <span class="c1"># although it didn&#39;t specify the PlacementGroupSchedulingStrategy.</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">remote</span><span class="p">())</span>


<span class="c1"># Since the child and parent use 1 CPU each, the placement group</span>
<span class="c1"># bundle {&quot;CPU&quot;: 2} is fully occupied.</span>
<span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="n">parent</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
        <span class="n">scheduling_strategy</span><span class="o">=</span><span class="n">PlacementGroupSchedulingStrategy</span><span class="p">(</span>
            <span class="n">placement_group</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span> <span class="n">placement_group_capture_child_tasks</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-18" name="sd-tab-set-7" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-18">
Java</label><div class="sd-tab-content docutils">
<p>还未实现 Java API。</p>
</div>
</div>
<p>当 <code class="docutils literal notranslate"><span class="pre">placement_group_capture_child_tasks</span></code> 为 True 时，但你不想将子任务和 actor 调度到相同的占位组时，指定 <code class="docutils literal notranslate"><span class="pre">PlacementGroupSchedulingStrategy(placement_group=None)</span></code>。</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">def</span> <span class="nf">parent</span><span class="p">():</span>
    <span class="c1"># In this case, the child task isn&#39;t</span>
    <span class="c1"># scheduled with the parent&#39;s placement group.</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">child</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="n">scheduling_strategy</span><span class="o">=</span><span class="n">PlacementGroupSchedulingStrategy</span><span class="p">(</span><span class="n">placement_group</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
    <span class="p">)</span>


<span class="c1"># This times out because we cannot schedule the child task.</span>
<span class="c1"># The cluster has {&quot;CPU&quot;: 2}, and both of them are reserved by</span>
<span class="c1"># the placement group with a bundle {&quot;CPU&quot;: 2}. Since the child shouldn&#39;t</span>
<span class="c1"># be scheduled within this placement group, it cannot be scheduled because</span>
<span class="c1"># there&#39;s no available CPU resources.</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="n">scheduling_strategy</span><span class="o">=</span><span class="n">PlacementGroupSchedulingStrategy</span><span class="p">(</span>
                <span class="n">placement_group</span><span class="o">=</span><span class="n">pg</span><span class="p">,</span> <span class="n">placement_group_capture_child_tasks</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">remote</span><span class="p">(),</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t create a child task!&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id11">
<h2>【高级】命名占位组<a class="headerlink" href="#id11" title="Permalink to this headline">#</a></h2>
<p>可以给占位组一个全局唯一的名字。
这允许您从 Ray 集群中的任何作业中检索占位组。
如果您无法直接将占位组句柄传递给需要它的 actor 或任务，或者正在尝试访问另一个驱动程序启动的占位组，这可能很有用。
注意，如果占位组的生命周期不是 <code class="xref py py-obj docutils literal notranslate"><span class="pre">detached</span></code>，它仍然会被销毁。</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-19" name="sd-tab-set-8" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-19">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># first_driver.py</span>
<span class="c1"># Create a placement group with a global name.</span>
<span class="n">pg</span> <span class="o">=</span> <span class="n">placement_group</span><span class="p">([{</span><span class="s2">&quot;CPU&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;global_name&quot;</span><span class="p">)</span>
<span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">ready</span><span class="p">())</span>

<span class="c1"># second_driver.py</span>
<span class="c1"># Retrieve a placement group with a global name.</span>
<span class="n">pg</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_placement_group</span><span class="p">(</span><span class="s2">&quot;global_name&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-20" name="sd-tab-set-8" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-20">
Java</label><div class="sd-tab-content docutils">
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a placement group with a unique name.</span><span class="w"></span>
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bundle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmutableMap</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;CPU&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">);</span><span class="w"></span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">bundles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ImmutableList</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">bundle</span><span class="p">);</span><span class="w"></span>

<span class="n">PlacementGroupCreationOptions</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">  </span><span class="k">new</span><span class="w"> </span><span class="n">PlacementGroupCreationOptions</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="na">setBundles</span><span class="p">(</span><span class="n">bundles</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="na">setStrategy</span><span class="p">(</span><span class="n">PlacementStrategy</span><span class="p">.</span><span class="na">STRICT_SPREAD</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="s">&quot;global_name&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w"></span>

<span class="n">PlacementGroup</span><span class="w"> </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlacementGroups</span><span class="p">.</span><span class="na">createPlacementGroup</span><span class="p">(</span><span class="n">options</span><span class="p">);</span><span class="w"></span>
<span class="n">pg</span><span class="p">.</span><span class="na">wait</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>

<span class="c1">// Retrieve the placement group later somewhere.</span><span class="w"></span>
<span class="n">PlacementGroup</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PlacementGroups</span><span class="p">.</span><span class="na">getPlacementGroup</span><span class="p">(</span><span class="s">&quot;global_name&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">Assert</span><span class="p">.</span><span class="na">assertNotNull</span><span class="p">(</span><span class="n">group</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-21" name="sd-tab-set-8" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-21">
C++</label><div class="sd-tab-content docutils">
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a placement group with a globally unique name.</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">bundles</span><span class="p">{{{</span><span class="s">&quot;CPU&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}}};</span><span class="w"></span>

<span class="n">ray</span><span class="o">::</span><span class="n">PlacementGroupCreationOptions</span><span class="w"> </span><span class="n">options</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">true</span><span class="cm">/*global*/</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;global_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bundles</span><span class="p">,</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">PlacementStrategy</span><span class="o">::</span><span class="n">STRICT_SPREAD</span><span class="p">};</span><span class="w"></span>

<span class="n">ray</span><span class="o">::</span><span class="n">PlacementGroup</span><span class="w"> </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">CreatePlacementGroup</span><span class="p">(</span><span class="n">options</span><span class="p">);</span><span class="w"></span>
<span class="n">pg</span><span class="p">.</span><span class="n">Wait</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>

<span class="c1">// Retrieve the placement group later somewhere.</span>
<span class="n">ray</span><span class="o">::</span><span class="n">PlacementGroup</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">GetGlobalPlacementGroup</span><span class="p">(</span><span class="s">&quot;global_name&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">group</span><span class="p">.</span><span class="n">Empty</span><span class="p">());</span><span class="w"></span>
</pre></div>
</div>
<p>我们也支持 C++ 中的非全局命名的占位组，这意味着占位组名称仅在作业内有效，不能从另一个作业中访问。</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a placement group with a job-scope-unique name.</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">bundles</span><span class="p">{{{</span><span class="s">&quot;CPU&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">}}};</span><span class="w"></span>

<span class="n">ray</span><span class="o">::</span><span class="n">PlacementGroupCreationOptions</span><span class="w"> </span><span class="n">options</span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nb">false</span><span class="cm">/*non-global*/</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;non_global_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bundles</span><span class="p">,</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">PlacementStrategy</span><span class="o">::</span><span class="n">STRICT_SPREAD</span><span class="p">};</span><span class="w"></span>

<span class="n">ray</span><span class="o">::</span><span class="n">PlacementGroup</span><span class="w"> </span><span class="n">pg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">CreatePlacementGroup</span><span class="p">(</span><span class="n">options</span><span class="p">);</span><span class="w"></span>
<span class="n">pg</span><span class="p">.</span><span class="n">Wait</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span><span class="w"></span>

<span class="p">...</span><span class="w"></span>

<span class="c1">// Retrieve the placement group later somewhere in the same job.</span>
<span class="n">ray</span><span class="o">::</span><span class="n">PlacementGroup</span><span class="w"> </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ray</span><span class="o">::</span><span class="n">GetPlacementGroup</span><span class="p">(</span><span class="s">&quot;non_global_name&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">group</span><span class="p">.</span><span class="n">Empty</span><span class="p">());</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="placement-group-detached">
<span id="id12"></span><h2>【高级】 分离占位组<a class="headerlink" href="#placement-group-detached" title="Permalink to this headline">#</a></h2>
<p>默认的，占位组的生命周期属于驱动程序和 actor。</p>
<ul class="simple">
<li><p>如果占位组是从驱动程序创建的，当驱动程序终止时它将被销毁。</p></li>
<li><p>如果占位组是从一个分离的 actor 创建的，当分离的 actor 被杀死它将被杀死。</p></li>
</ul>
<p>要保持占位组的生命周期与其作业或分离的 actor 无关，请指定 <code class="docutils literal notranslate"><span class="pre">lifetime=&quot;detached&quot;</span></code>。例如：</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-22" name="sd-tab-set-9" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-22">
Python</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># driver_1.py</span>
<span class="c1"># Create a detached placement group that survives even after</span>
<span class="c1"># the job terminates.</span>
<span class="n">pg</span> <span class="o">=</span> <span class="n">placement_group</span><span class="p">([{</span><span class="s2">&quot;CPU&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}],</span> <span class="n">lifetime</span><span class="o">=</span><span class="s2">&quot;detached&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;global_name&quot;</span><span class="p">)</span>
<span class="n">ray</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">ready</span><span class="p">())</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-23" name="sd-tab-set-9" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-23">
Java</label><div class="sd-tab-content docutils">
<p>Java API 尚未实现生命周期参数。</p>
</div>
</div>
<p>让我们终止当前脚本并启动一个新的 Python 脚本。调用 <code class="docutils literal notranslate"><span class="pre">ray</span> <span class="pre">list</span> <span class="pre">placement-groups</span></code>，你会看到占位组没有被删除。</p>
<p>注意，生命周期选项与名称无关。如果我们只指定了名称而没有指定 <code class="docutils literal notranslate"><span class="pre">lifetime=&quot;detached&quot;</span></code>，那么占位组只能在原始驱动程序仍在运行时检索。
建议在创建分离的占位组时始终指定名称。</p>
</section>
<section id="id13">
<h2>[高级] 容错<a class="headerlink" href="#id13" title="Permalink to this headline">#</a></h2>
<section id="dead">
<span id="ray-placement-group-ft-ref"></span><h3>在 Dead 节点重新调度捆绑包<a class="headerlink" href="#dead" title="Permalink to this headline">#</a></h3>
<p>如果节点上包含占位组的某些捆绑包的节点死机，所有捆绑包都将通过 GCS（例如：尝试再次分配资源） 在不同的节点上重新调度。
这意味着占位组的初始创建是“原子的”，但一旦创建，可能会出现部分占位组。
重新调度捆绑包比其他占位组调度具有更高的调度优先级。</p>
</section>
<section id="id14">
<h3>为部分丢失的捆绑包提供资源<a class="headerlink" href="#id14" title="Permalink to this headline">#</a></h3>
<p>如果没有足够的资源来调度部分丢失的捆绑包，占位组将等待，假设 Ray Autoscaler 将启动一个新节点来满足资源需求。
如果无法提供额外的资源（例如，您不使用 Autoscaler 或 Autoscaler 达到资源限制），占位组将无限期地保持部分创建状态。</p>
</section>
<section id="id15">
<h3>使用捆绑包的任务和 actor 的容错能力<a class="headerlink" href="#id15" title="Permalink to this headline">#</a></h3>
<p>一旦捆绑包恢复，使用任务和 actor 的捆绑包（预留资源）将根据其 <a class="reference internal" href="../fault-tolerance.html#fault-tolerance"><span class="std std-ref">fault tolerant policy</span></a> 重新调度。</p>
</section>
</section>
<section id="api">
<h2>API 参考<a class="headerlink" href="#api" title="Permalink to this headline">#</a></h2>
<p><a class="reference internal" href="../api/scheduling.html#ray-placement-group-ref"><span class="std std-ref">占位组 API 参考</span></a></p>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="../tasks/using-ray-with-gpus.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">GPU 支持</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="memory-management.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">内存管理</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><!-- Override the footer area for the sphinx-book-theme to include the CSAT widget -->
<div id="csat">
  <div id="csat-feedback-received" class="csat-hidden">
    <span>谢谢你的反馈！</span>
  </div>
  <div id="csat-inputs">
    <span>是否能帮助到你？</span>
    <div id="csat-yes" class="csat-button">
      <svg id="csat-yes-icon" class="csat-hidden csat-icon" width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 10.172L16.1922 0.979004L17.6072 2.393L7.00023 13L0.63623 6.636L2.05023 5.222L7.00023 10.172Z" fill="black"/>
      </svg>
      <span>是<span>
    </div>
    <div id="csat-no" class="csat-button">
      <svg id="csat-no-icon" class="csat-hidden csat-icon" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 5.58599L11.9502 0.635986L13.3642 2.04999L8.41423 6.99999L13.3642 11.95L11.9502 13.364L7.00023 8.41399L2.05023 13.364L0.63623 11.95L5.58623 6.99999L0.63623 2.04999L2.05023 0.635986L7.00023 5.58599Z" fill="black"/>
      </svg>
      <span>否<span>
    </div>
  </div>
  <div id="csat-textarea-group" class="csat-hidden">
    <span id="csat-feedback-label">反馈</span>
    <textarea id="csat-textarea"></textarea>
    <div id="csat-submit">提交</div>
  </div>
</div><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2024, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>