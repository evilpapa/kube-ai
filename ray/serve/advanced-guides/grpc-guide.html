
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Set Up a gRPC Service &#8212; Ray 2.7.2</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" href="../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/versionwarning.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../../_static/js/docsearch.js"></script>
    <script defer="defer" src="../../_static/js/csat.js"></script>
    <script defer="defer" src="../../_static/js/termynal.js"></script>
    <script defer="defer" src="../../_static/js/custom.js"></script>
    <script defer="defer" src="../../_static/js/top-navigation.js"></script>
    <script src="../../_static/js/tags.js"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/design-tabs.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/serve/advanced-guides/grpc-guide.html" />
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Experimental Deployment Graphs" href="deployment-graphs.html" />
    <link rel="prev" title="Development Workflow" href="dev-workflow.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
  data-modal-disclaimer = "Results are automated and may be incorrect or contain inappropriate information. Do not include any personal data or confidential information."
  data-modal-title = "Ray Docs AI - Ask a Question"
  data-button-position-bottom = "60px"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 2.7.2</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../index.html">
                    欢迎来到 Ray ！
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/index.html">
   概述「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/getting-started.html">
   入门
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/installation.html">
   安装「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/use-cases.html">
   用例「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/examples.html">
   示例库「1%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-overview/ray-libraries.html">
   生态「3%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-core/walkthrough.html">
   Ray 核心「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../data/data.html">
   Ray 数据「75%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../train/train.html">
   Ray 训练「0%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../tune/index.html">
   Ray 调参「0%」
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../index.html">
   Ray Serve
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../getting_started.html">
     入门
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../key-concepts.html">
     关键概念
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../develop-and-deploy.html">
     开发并部署 ML 应用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../model_composition.html">
     部署模型组合
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../multi-app.html">
     部署多应用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../model-multiplexing.html">
     模型复用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../configure-serve-deployment.html">
     配置 Ray Serve 发布
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../http-guide.html">
     设置 FastAPI 及 HTTP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../production-guide/index.html">
     生产指引
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../monitoring.html">
     监控你的应用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../resource-allocation.html">
     资源分配
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../autoscaling-guide.html">
     Ray Serve 自动扩缩
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="index.html">
     高级指南
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="app-builder-guide.html">
       Pass Arguments to Applications
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="advanced-autoscaling.html">
       Advanced Ray Serve Autoscaling
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="performance.html">
       Performance Tuning
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="dyn-req-batch.html">
       Dynamic Request Batching
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="inplace-updates.html">
       Updating Applications In-Place
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="dev-workflow.html">
       Development Workflow
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Set Up a gRPC Service
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="deployment-graphs.html">
       Experimental Deployment Graphs
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="managing-java-deployments.html">
       Experimental Java API
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="deploy-vm.html">
       Deploy on VM
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../architecture.html">
     架构
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../tutorials/index.html">
     示例
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../api/index.html">
     Ray Serve API
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../rllib/index.html">
   Ray RLlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-more-libs/index.html">
   更多类库「40%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../cluster/getting-started.html">
   Ray 集群「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-observability/index.html">
   监控调试「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-references/api.html">
   参考「20%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-contribute/index.html">
   开发者指引「30%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ray-security/index.html">
   安全「100%」
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Fserve/advanced-guides/grpc-guide.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/serve/advanced-guides/grpc-guide.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../_sources/serve/advanced-guides/grpc-guide.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-a-grpc-service">
   Define a gRPC service
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#start-serve-with-grpc-enabled">
   Start Serve with gRPC enabled
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-grpc-applications">
   Deploy gRPC applications
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#send-grpc-requests-to-serve-deployments">
   Send gRPC requests to serve deployments
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#check-proxy-health">
   Check proxy health
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#work-with-grpc-metadata">
   Work with gRPC metadata
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#use-streaming-and-model-composition">
   Use streaming and model composition
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#streaming">
     Streaming
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-composition">
     Model composition
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#handle-errors">
   Handle errors
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Set Up a gRPC Service</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#define-a-grpc-service">
   Define a gRPC service
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#start-serve-with-grpc-enabled">
   Start Serve with gRPC enabled
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deploy-grpc-applications">
   Deploy gRPC applications
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#send-grpc-requests-to-serve-deployments">
   Send gRPC requests to serve deployments
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#check-proxy-health">
   Check proxy health
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#work-with-grpc-metadata">
   Work with gRPC metadata
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#use-streaming-and-model-composition">
   Use streaming and model composition
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#streaming">
     Streaming
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#model-composition">
     Model composition
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#handle-errors">
   Handle errors
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="set-up-a-grpc-service">
<span id="serve-set-up-grpc-service"></span><h1>Set Up a gRPC Service<a class="headerlink" href="#set-up-a-grpc-service" title="Permalink to this headline">#</a></h1>
<p>This section helps you understand how to:</p>
<ul class="simple">
<li><p>Build a user defined gRPC service and protobuf</p></li>
<li><p>Start Serve with gRPC enabled</p></li>
<li><p>Deploy gRPC applications</p></li>
<li><p>Send gRPC requests to Serve deployments</p></li>
<li><p>Check proxy health</p></li>
<li><p>Work with gRPC metadata</p></li>
<li><p>Use streaming and model composition</p></li>
<li><p>Handle errors</p></li>
</ul>
<section id="define-a-grpc-service">
<span id="custom-serve-grpc-service"></span><h2>Define a gRPC service<a class="headerlink" href="#define-a-grpc-service" title="Permalink to this headline">#</a></h2>
<p>Running a gRPC server starts with defining gRPC services, RPC methods, and
protobufs similar to the one below.</p>
<div class="highlight-proto notranslate"><div class="highlight"><pre><span></span><span class="c1">// user_defined_protos.proto</span>

<span class="k">syntax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;proto3&quot;</span><span class="p">;</span>

<span class="k">option</span><span class="w"> </span><span class="na">java_multiple_files</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="k">option</span><span class="w"> </span><span class="na">java_package</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;io.ray.examples.user_defined_protos&quot;</span><span class="p">;</span>
<span class="k">option</span><span class="w"> </span><span class="na">java_outer_classname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;UserDefinedProtos&quot;</span><span class="p">;</span>

<span class="kn">package</span><span class="w"> </span><span class="nn">userdefinedprotos</span><span class="p">;</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">UserDefinedMessage</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">origin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int64</span><span class="w"> </span><span class="na">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">UserDefinedResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">greeting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">int64</span><span class="w"> </span><span class="na">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">UserDefinedMessage2</span><span class="w"> </span><span class="p">{}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">UserDefinedResponse2</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">greeting</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">ImageData</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="na">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">ImageClass</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">repeated</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="na">classes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="k">repeated</span><span class="w"> </span><span class="kt">float</span><span class="w"> </span><span class="na">probabilities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">service</span><span class="w"> </span><span class="n">UserDefinedService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">rpc</span><span class="w"> </span><span class="n">__call__</span><span class="p">(</span><span class="n">UserDefinedMessage</span><span class="p">)</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">UserDefinedResponse</span><span class="p">);</span>
<span class="w">  </span><span class="k">rpc</span><span class="w"> </span><span class="n">Multiplexing</span><span class="p">(</span><span class="n">UserDefinedMessage2</span><span class="p">)</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">UserDefinedResponse2</span><span class="p">);</span>
<span class="w">  </span><span class="k">rpc</span><span class="w"> </span><span class="n">Streaming</span><span class="p">(</span><span class="n">UserDefinedMessage</span><span class="p">)</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">stream</span><span class="w"> </span><span class="n">UserDefinedResponse</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">service</span><span class="w"> </span><span class="n">ImageClassificationService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">rpc</span><span class="w"> </span><span class="n">Predict</span><span class="p">(</span><span class="n">ImageData</span><span class="p">)</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">ImageClass</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This example creates a file named <code class="docutils literal notranslate"><span class="pre">user_defined_protos.proto</span></code> with two
gRPC services: <code class="docutils literal notranslate"><span class="pre">UserDefinedService</span></code> and <code class="docutils literal notranslate"><span class="pre">ImageClassificationService</span></code>.
<code class="docutils literal notranslate"><span class="pre">UserDefinedService</span></code> has three RPC methods: <code class="docutils literal notranslate"><span class="pre">__call__</span></code>, <code class="docutils literal notranslate"><span class="pre">Multiplexing</span></code>, and <code class="docutils literal notranslate"><span class="pre">Streaming</span></code>.
<code class="docutils literal notranslate"><span class="pre">ImageClassificationService</span></code> has one RPC method: <code class="docutils literal notranslate"><span class="pre">Predict</span></code>. Their corresponding input
and output types are also defined specifically for each RPC method.</p>
<p>Once you define the <code class="docutils literal notranslate"><span class="pre">.proto</span></code> services, use <code class="docutils literal notranslate"><span class="pre">grpcio-tools</span></code> to compile python
code for those services. Example command looks like the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python -m grpc_tools.protoc -I<span class="o">=</span>. --python_out<span class="o">=</span>. --grpc_python_out<span class="o">=</span>. ./user_defined_protos.proto
</pre></div>
</div>
<p>It generates two files: <code class="docutils literal notranslate"><span class="pre">user_defined_protos_pb2.py</span></code> and
<code class="docutils literal notranslate"><span class="pre">user_defined_protos_pb2_grpc.py</span></code>.</p>
<p>For more details on <code class="docutils literal notranslate"><span class="pre">grpcio-tools</span></code> see <a class="reference external" href="https://grpc.io/docs/languages/python/basics/#generating-client-and-server-code">https://grpc.io/docs/languages/python/basics/#generating-client-and-server-code</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ensure that the generated files are in the same directory as where the Ray cluster
is running so that Serve can import them when starting the proxies.</p>
</div>
</section>
<section id="start-serve-with-grpc-enabled">
<span id="start-serve-with-grpc-proxy"></span><h2>Start Serve with gRPC enabled<a class="headerlink" href="#start-serve-with-grpc-enabled" title="Permalink to this headline">#</a></h2>
<p>The <a class="reference external" href="https://docs.ray.io/en/releases-2.7.0/serve/api/index.html#serve-start">Serve start</a> CLI,
<a class="reference external" href="https://docs.ray.io/en/releases-2.7.0/serve/api/doc/ray.serve.start.html#ray.serve.start"><code class="docutils literal notranslate"><span class="pre">ray.serve.start</span></code></a> API,
and <a class="reference external" href="https://docs.ray.io/en/releases-2.7.0/serve/production-guide/config.html#serve-config-files-serve-build">Serve config files</a>
all support starting Serve with a gRPC proxy. Two options are related to Serve’s
gRPC proxy: <code class="docutils literal notranslate"><span class="pre">grpc_port</span></code> and <code class="docutils literal notranslate"><span class="pre">grpc_servicer_functions</span></code>. <code class="docutils literal notranslate"><span class="pre">grpc_port</span></code> is the port for gRPC
proxies to listen to. It defaults to 9000. <code class="docutils literal notranslate"><span class="pre">grpc_servicer_functions</span></code> is a list of import
paths for gRPC <code class="docutils literal notranslate"><span class="pre">add_servicer_to_server</span></code> functions to add to a gRPC proxy. It also
serves as the flag to determine whether to start gRPC server. The default is an empty
list, meaning no gRPC server is started.</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-0">
CLI</label><div class="sd-tab-content docutils">
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ray start --head
serve start <span class="se">\</span>
  --grpc-port <span class="m">9000</span> <span class="se">\</span>
  --grpc-servicer-functions user_defined_protos_pb2_grpc.add_UserDefinedServiceServicer_to_server <span class="se">\</span>
  --grpc-servicer-functions user_defined_protos_pb2_grpc.add_ImageClassificationServiceServicer_to_server
</pre></div>
</div>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-1">
Python API</label><div class="sd-tab-content docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve.config</span> <span class="kn">import</span> <span class="n">gRPCOptions</span>


<span class="n">grpc_port</span> <span class="o">=</span> <span class="mi">9000</span>
<span class="n">grpc_servicer_functions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;user_defined_protos_pb2_grpc.add_UserDefinedServiceServicer_to_server&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_defined_protos_pb2_grpc.add_ImageClassificationServiceServicer_to_server&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">serve</span><span class="o">.</span><span class="n">start</span><span class="p">(</span>
    <span class="n">grpc_options</span><span class="o">=</span><span class="n">gRPCOptions</span><span class="p">(</span>
        <span class="n">port</span><span class="o">=</span><span class="n">grpc_port</span><span class="p">,</span>
        <span class="n">grpc_servicer_functions</span><span class="o">=</span><span class="n">grpc_servicer_functions</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-2" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-2">
Serve config file</label><div class="sd-tab-content docutils">
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># config.yaml</span><span class="w"></span>
<span class="nt">grpc_options</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9000</span><span class="w"></span>
<span class="w">  </span><span class="nt">grpc_servicer_functions</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user_defined_protos_pb2_grpc.add_UserDefinedServiceServicer_to_server</span><span class="w"></span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user_defined_protos_pb2_grpc.add_ImageClassificationServiceServicer_to_server</span><span class="w"></span>

<span class="nt">applications</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app1</span><span class="w"></span>
<span class="w">    </span><span class="nt">route_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/app1</span><span class="w"></span>
<span class="w">    </span><span class="nt">import_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_deployment_v2:g</span><span class="w"></span>
<span class="w">    </span><span class="nt">runtime_env</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"></span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app2</span><span class="w"></span>
<span class="w">    </span><span class="nt">route_prefix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/app2</span><span class="w"></span>
<span class="w">    </span><span class="nt">import_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test_deployment_v2:g2</span><span class="w"></span>
<span class="w">    </span><span class="nt">runtime_env</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start Serve with above config file.</span>
serve run config.yaml
</pre></div>
</div>
</div>
</div>
</section>
<section id="deploy-grpc-applications">
<span id="deploy-serve-grpc-applications"></span><h2>Deploy gRPC applications<a class="headerlink" href="#deploy-grpc-applications" title="Permalink to this headline">#</a></h2>
<p>gRPC applications in Serve works similarly to HTTP applications. The only difference is
that the input and output of the methods need to match with what’s defined in the <code class="docutils literal notranslate"><span class="pre">.proto</span></code>
file and that the method of the application needs to be an exact match (case sensitive)
with the predefined RPC methods. For example, if we want to deploy <code class="docutils literal notranslate"><span class="pre">UserDefinedService</span></code>
with <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method, the method name needs to be <code class="docutils literal notranslate"><span class="pre">__call__</span></code>, the input type needs to
be <code class="docutils literal notranslate"><span class="pre">UserDefinedMessage</span></code>, and the output type needs to be <code class="docutils literal notranslate"><span class="pre">UserDefinedResponse</span></code>. Serve
passes the protobuf object into the method and expects the protobuf object back
from the method.</p>
<p>Example deployment:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generator</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">UserDefinedMessage</span><span class="p">,</span>
    <span class="n">UserDefinedMessage2</span><span class="p">,</span>
    <span class="n">UserDefinedResponse</span><span class="p">,</span>
    <span class="n">UserDefinedResponse2</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">GrpcDeployment</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_message</span><span class="p">:</span> <span class="n">UserDefinedMessage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserDefinedResponse</span><span class="p">:</span>
        <span class="n">greeting</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hello </span><span class="si">{</span><span class="n">user_message</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">user_message</span><span class="o">.</span><span class="n">origin</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">user_message</span><span class="o">.</span><span class="n">num</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">user_response</span> <span class="o">=</span> <span class="n">UserDefinedResponse</span><span class="p">(</span>
            <span class="n">greeting</span><span class="o">=</span><span class="n">greeting</span><span class="p">,</span>
            <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">user_response</span>

    <span class="nd">@serve</span><span class="o">.</span><span class="n">multiplexed</span><span class="p">(</span><span class="n">max_num_models_per_replica</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;loading model: </span><span class="si">{</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">Multiplexing</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">user_message</span><span class="p">:</span> <span class="n">UserDefinedMessage2</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">UserDefinedResponse2</span><span class="p">:</span>
        <span class="n">model_id</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">get_multiplexed_model_id</span><span class="p">()</span>
        <span class="n">model</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
        <span class="n">user_response</span> <span class="o">=</span> <span class="n">UserDefinedResponse2</span><span class="p">(</span>
            <span class="n">greeting</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Method2 called model, </span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">user_response</span>

    <span class="k">def</span> <span class="nf">Streaming</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">user_message</span><span class="p">:</span> <span class="n">UserDefinedMessage</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">UserDefinedResponse</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">greeting</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: Hello </span><span class="si">{</span><span class="n">user_message</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">user_message</span><span class="o">.</span><span class="n">origin</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">user_message</span><span class="o">.</span><span class="n">num</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span>
            <span class="n">user_response</span> <span class="o">=</span> <span class="n">UserDefinedResponse</span><span class="p">(</span>
                <span class="n">greeting</span><span class="o">=</span><span class="n">greeting</span><span class="p">,</span>
                <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">yield</span> <span class="n">user_response</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>


<span class="n">g</span> <span class="o">=</span> <span class="n">GrpcDeployment</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
</pre></div>
</div>
<p>Deploy the application:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">app1</span> <span class="o">=</span> <span class="s2">&quot;app1&quot;</span>
<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">app1</span><span class="p">,</span> <span class="n">route_prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">app1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">route_prefix</span></code> is still a required field as of Ray 2.7.0 due to a shared code path with
HTTP. Future releases will make it optional for gRPC.</p>
</div>
</section>
<section id="send-grpc-requests-to-serve-deployments">
<span id="send-serve-grpc-proxy-request"></span><h2>Send gRPC requests to serve deployments<a class="headerlink" href="#send-grpc-requests-to-serve-deployments" title="Permalink to this headline">#</a></h2>
<p>Sending a gRPC request to a Serve deployment is similar to sending a gRPC request to
any other gRPC server. Create a gRPC channel and stub, then call the RPC
method on the stub with the appropriate input. The output is the protobuf object
that your Serve application returns.</p>
<p>Sending a gRPC request:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2_grpc</span> <span class="kn">import</span> <span class="n">UserDefinedServiceStub</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2</span> <span class="kn">import</span> <span class="n">UserDefinedMessage</span>


<span class="n">channel</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="s2">&quot;localhost:9000&quot;</span><span class="p">)</span>
<span class="n">stub</span> <span class="o">=</span> <span class="n">UserDefinedServiceStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">UserDefinedMessage</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>

<span class="n">response</span><span class="p">,</span> <span class="n">call</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="fm">__call__</span><span class="o">.</span><span class="n">with_call</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status code: </span><span class="si">{</span><span class="n">call</span><span class="o">.</span><span class="n">code</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># grpc.StatusCode.OK</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;greeting: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">greeting</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;Hello foo from bar&quot;</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;num: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 60</span>
</pre></div>
</div>
<p>Read more about gRPC clients in Python: <a class="reference external" href="https://grpc.io/docs/languages/python/basics/#client">https://grpc.io/docs/languages/python/basics/#client</a></p>
</section>
<section id="check-proxy-health">
<span id="serve-grpc-proxy-health-checks"></span><h2>Check proxy health<a class="headerlink" href="#check-proxy-health" title="Permalink to this headline">#</a></h2>
<p>Similar to HTTP <code class="docutils literal notranslate"><span class="pre">/-/routes</span></code> and <code class="docutils literal notranslate"><span class="pre">/-/healthz</span></code> endpoints, Serve also provides gRPC
service method to be used in health check.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/ray.serve.RayServeAPIService/ListApplications</span></code> is used to list all applications
deployed in Serve.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/ray.serve.RayServeAPIService/Healthz</span></code> is used to check the health of the proxy.
It returns <code class="docutils literal notranslate"><span class="pre">OK</span></code> status and “success” message if the proxy is healthy.</p></li>
</ul>
<p>The service method and protobuf are defined as below:</p>
<div class="highlight-proto notranslate"><div class="highlight"><pre><span></span><span class="kd">message</span><span class="w"> </span><span class="nc">ListApplicationsRequest</span><span class="w"> </span><span class="p">{}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">ListApplicationsResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">repeated</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="na">application_names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">HealthzRequest</span><span class="w"> </span><span class="p">{}</span>

<span class="kd">message</span><span class="w"> </span><span class="nc">HealthzResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="kd">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">service</span><span class="w"> </span><span class="n">RayServeAPIService</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">rpc</span><span class="w"> </span><span class="n">ListApplications</span><span class="p">(</span><span class="n">ListApplicationsRequest</span><span class="p">)</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">ListApplicationsResponse</span><span class="p">);</span>
<span class="w">  </span><span class="k">rpc</span><span class="w"> </span><span class="n">Healthz</span><span class="p">(</span><span class="n">HealthzRequest</span><span class="p">)</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="p">(</span><span class="n">HealthzResponse</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can call the service method with the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">from</span> <span class="nn">ray.serve.generated.serve_pb2_grpc</span> <span class="kn">import</span> <span class="n">RayServeAPIServiceStub</span>
<span class="kn">from</span> <span class="nn">ray.serve.generated.serve_pb2</span> <span class="kn">import</span> <span class="n">HealthzRequest</span><span class="p">,</span> <span class="n">ListApplicationsRequest</span>


<span class="n">channel</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="s2">&quot;localhost:9000&quot;</span><span class="p">)</span>
<span class="n">stub</span> <span class="o">=</span> <span class="n">RayServeAPIServiceStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">ListApplicationsRequest</span><span class="p">()</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">ListApplications</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applications: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">application_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># [&quot;app1&quot;]</span>

<span class="n">request</span> <span class="o">=</span> <span class="n">HealthzRequest</span><span class="p">()</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">Healthz</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Health: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;success&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Serve provides the <code class="docutils literal notranslate"><span class="pre">RayServeAPIServiceStub</span></code> stub, and <code class="docutils literal notranslate"><span class="pre">HealthzRequest</span></code> and
<code class="docutils literal notranslate"><span class="pre">ListApplicationsRequest</span></code> protobufs for you to use. You don’t need to generate them
from the proto file. They are available for your reference.</p>
</div>
</section>
<section id="work-with-grpc-metadata">
<span id="serve-grpc-metadata"></span><h2>Work with gRPC metadata<a class="headerlink" href="#work-with-grpc-metadata" title="Permalink to this headline">#</a></h2>
<p>Just like HTTP headers, gRPC also supports metadata to pass request related information.
You can pass metadata to Serve’s gRPC proxy and Serve knows how to parse and use
them. Serve also passes trailing metadata back to the client.</p>
<p>List of Serve accepted metadata keys:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">application</span></code>: The name of the Serve application to route to. If not passed and only
one application is deployed, serve routes to the only deployed app automatically.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">request_id</span></code>: The request ID to track the request.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">multiplexed_model_id</span></code>: The model ID to do model multiplexing.</p></li>
</ul>
<p>List of Serve returned trailing metadata keys:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">request_id</span></code>: The request ID to track the request.</p></li>
</ul>
<p>Example of using metadata:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2_grpc</span> <span class="kn">import</span> <span class="n">UserDefinedServiceStub</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2</span> <span class="kn">import</span> <span class="n">UserDefinedMessage2</span>


<span class="n">channel</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="s2">&quot;localhost:9000&quot;</span><span class="p">)</span>
<span class="n">stub</span> <span class="o">=</span> <span class="n">UserDefinedServiceStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">UserDefinedMessage2</span><span class="p">()</span>
<span class="n">app_name</span> <span class="o">=</span> <span class="s2">&quot;app1&quot;</span>
<span class="n">request_id</span> <span class="o">=</span> <span class="s2">&quot;123&quot;</span>
<span class="n">multiplexed_model_id</span> <span class="o">=</span> <span class="s2">&quot;999&quot;</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="n">app_name</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;request_id&quot;</span><span class="p">,</span> <span class="n">request_id</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;multiplexed_model_id&quot;</span><span class="p">,</span> <span class="n">multiplexed_model_id</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">response</span><span class="p">,</span> <span class="n">call</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">Multiplexing</span><span class="o">.</span><span class="n">with_call</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;greeting: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">greeting</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;Method2 called model, loading model: 999&quot;</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">call</span><span class="o">.</span><span class="n">trailing_metadata</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;trailing metadata key: </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">, value </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># &quot;request_id: 123&quot;</span>
</pre></div>
</div>
</section>
<section id="use-streaming-and-model-composition">
<span id="serve-grpc-proxy-more-examples"></span><h2>Use streaming and model composition<a class="headerlink" href="#use-streaming-and-model-composition" title="Permalink to this headline">#</a></h2>
<p>gRPC proxy remains at feature parity with HTTP proxy. Here are more examples of using
gRPC proxy for getting streaming response as well as doing model composition.</p>
<section id="streaming">
<h3>Streaming<a class="headerlink" href="#streaming" title="Permalink to this headline">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">Steaming</span></code> method is deployed with the app named “app1” above. The following code
gets a streaming response.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2_grpc</span> <span class="kn">import</span> <span class="n">UserDefinedServiceStub</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2</span> <span class="kn">import</span> <span class="n">UserDefinedMessage</span>


<span class="n">channel</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="s2">&quot;localhost:9000&quot;</span><span class="p">)</span>
<span class="n">stub</span> <span class="o">=</span> <span class="n">UserDefinedServiceStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">UserDefinedMessage</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="s2">&quot;app1&quot;</span><span class="p">),)</span>

<span class="n">responses</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">Streaming</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
<span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;greeting: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">greeting</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># greeting: n: Hello foo from bar</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;num: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">num</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># num: 60 + n</span>
</pre></div>
</div>
</section>
<section id="model-composition">
<h3>Model composition<a class="headerlink" href="#model-composition" title="Permalink to this headline">#</a></h3>
<p>Assuming we have the below deployments. <code class="docutils literal notranslate"><span class="pre">ImageDownloader</span></code> and <code class="docutils literal notranslate"><span class="pre">DataPreprocessor</span></code> are two
separate steps to download and process the image before PyTorch can run inference.
The <code class="docutils literal notranslate"><span class="pre">ImageClassifier</span></code> deployment initializes the model, calls both
<code class="docutils literal notranslate"><span class="pre">ImageDownloader</span></code> and <code class="docutils literal notranslate"><span class="pre">DataPreprocessor</span></code>, and feed into the resnet model to get the
classes and probabilities of the given image.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ImageClass</span><span class="p">,</span>
    <span class="n">ImageData</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve.handle</span> <span class="kn">import</span> <span class="n">RayServeDeploymentHandle</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">ImageClassifier</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">_image_downloader</span><span class="p">:</span> <span class="n">RayServeDeploymentHandle</span><span class="p">,</span>
        <span class="n">_data_preprocessor</span><span class="p">:</span> <span class="n">RayServeDeploymentHandle</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_image_downloader</span> <span class="o">=</span> <span class="n">_image_downloader</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_preprocessor</span> <span class="o">=</span> <span class="n">_data_preprocessor</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">hub</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="s2">&quot;pytorch/vision:v0.10.0&quot;</span><span class="p">,</span> <span class="s2">&quot;resnet18&quot;</span><span class="p">,</span> <span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_labels</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_image_labels</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;https://raw.githubusercontent.com/pytorch/hub/master/imagenet_classes.txt&quot;</span>
        <span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">categories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">categories</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">Predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_data</span><span class="p">:</span> <span class="n">ImageData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ImageClass</span><span class="p">:</span>
        <span class="c1"># Download image</span>
        <span class="n">image</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_image_downloader</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">image_data</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>

        <span class="c1"># Preprocess image</span>
        <span class="n">input_batch</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_preprocessor</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="c1"># Predict image</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_batch</span><span class="p">)</span>

        <span class="n">probabilities</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_model_outputs</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_model_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ImageClass</span><span class="p">:</span>
        <span class="n">image_classes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">image_probabilities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Show top categories per image</span>
        <span class="n">top5_prob</span><span class="p">,</span> <span class="n">top5_catid</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">probabilities</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">top5_prob</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)):</span>
            <span class="n">image_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categories</span><span class="p">[</span><span class="n">top5_catid</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">image_probabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">top5_prob</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">ImageClass</span><span class="p">(</span>
            <span class="n">classes</span><span class="o">=</span><span class="n">image_classes</span><span class="p">,</span>
            <span class="n">probabilities</span><span class="o">=</span><span class="n">image_probabilities</span><span class="p">,</span>
        <span class="p">)</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">ImageDownloader</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">image_bytes</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">image_url</span><span class="p">)</span><span class="o">.</span><span class="n">content</span>
        <span class="k">return</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">image_bytes</span><span class="p">))</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">DataPreprocessor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">CenterCrop</span><span class="p">(</span><span class="mi">224</span><span class="p">),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                <span class="n">transforms</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span>
                    <span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">0.485</span><span class="p">,</span> <span class="mf">0.456</span><span class="p">,</span> <span class="mf">0.406</span><span class="p">],</span> <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">0.229</span><span class="p">,</span> <span class="mf">0.224</span><span class="p">,</span> <span class="mf">0.225</span><span class="p">]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">:</span> <span class="n">Image</span><span class="p">):</span>
        <span class="n">input_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">input_tensor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># create a mini-batch as expected by the model</span>


<span class="n">image_downloader</span> <span class="o">=</span> <span class="n">ImageDownloader</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
<span class="n">data_preprocessor</span> <span class="o">=</span> <span class="n">DataPreprocessor</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
<span class="n">g2</span> <span class="o">=</span> <span class="n">ImageClassifier</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;grpc-image-classifier&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
    <span class="n">image_downloader</span><span class="p">,</span> <span class="n">data_preprocessor</span>
<span class="p">)</span>
</pre></div>
</div>
<p>We can deploy the application with the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">app2</span> <span class="o">=</span> <span class="s2">&quot;app2&quot;</span>
<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">g2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">app2</span><span class="p">,</span> <span class="n">route_prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">app2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The client code to call the application looks like the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2_grpc</span> <span class="kn">import</span> <span class="n">ImageClassificationServiceStub</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2</span> <span class="kn">import</span> <span class="n">ImageData</span>


<span class="n">channel</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="s2">&quot;localhost:9000&quot;</span><span class="p">)</span>
<span class="n">stub</span> <span class="o">=</span> <span class="n">ImageClassificationServiceStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">ImageData</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://github.com/pytorch/hub/raw/master/images/dog.jpg&quot;</span><span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;application&quot;</span><span class="p">,</span> <span class="s2">&quot;app2&quot;</span><span class="p">),)</span>  <span class="c1"># Make sure application metadata is passed.</span>

<span class="n">response</span><span class="p">,</span> <span class="n">call</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="n">Predict</span><span class="o">.</span><span class="n">with_call</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status code: </span><span class="si">{</span><span class="n">call</span><span class="o">.</span><span class="n">code</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># grpc.StatusCode.OK</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Classes: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">classes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># [&#39;Samoyed&#39;, ...]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Probabilities: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">probabilities</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># [0.8846230506896973, ...]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>At this point, two applications are running on Serve, “app1” and “app2”. If more
than one application is running, you need to pass <code class="docutils literal notranslate"><span class="pre">application</span></code> to the
metadata so Serve knows which application to route to.</p>
</div>
</section>
</section>
<section id="handle-errors">
<span id="serve-grpc-proxy-error-handling"></span><h2>Handle errors<a class="headerlink" href="#handle-errors" title="Permalink to this headline">#</a></h2>
<p>Similar to any other gRPC server, request throws a <code class="docutils literal notranslate"><span class="pre">grpc.RpcError</span></code> when the response
code is not “OK”. Put your request code in a try-except block and handle
the error accordingly.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">grpc</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2_grpc</span> <span class="kn">import</span> <span class="n">UserDefinedServiceStub</span>
<span class="kn">from</span> <span class="nn">user_defined_protos_pb2</span> <span class="kn">import</span> <span class="n">UserDefinedMessage</span>


<span class="n">channel</span> <span class="o">=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">insecure_channel</span><span class="p">(</span><span class="s2">&quot;localhost:9000&quot;</span><span class="p">)</span>
<span class="n">stub</span> <span class="o">=</span> <span class="n">UserDefinedServiceStub</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">UserDefinedMessage</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">stub</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
<span class="k">except</span> <span class="n">grpc</span><span class="o">.</span><span class="n">RpcError</span> <span class="k">as</span> <span class="n">rpc_error</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;status code: </span><span class="si">{</span><span class="n">rpc_error</span><span class="o">.</span><span class="n">code</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># StatusCode.NOT_FOUND</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;details: </span><span class="si">{</span><span class="n">rpc_error</span><span class="o">.</span><span class="n">details</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># Application metadata not set...</span>
</pre></div>
</div>
<p>Serve uses the following gRPC error codes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">NOT_FOUND</span></code>: When multiple applications are deployed to Serve and the application is
not passed in metadata or passed but no matching application.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UNAVAILABLE</span></code>: Only on the health check methods when the proxy is in draining state.
When the health check is throwing <code class="docutils literal notranslate"><span class="pre">UNAVAILABLE</span></code>, it means the health check failed on
this node and you should no longer route to this node.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CANCELLED</span></code>: The request took longer than the timeout setting and got cancelled.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">INTERNAL</span></code>: Other unhandled errors during the request.</p></li>
</ul>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="dev-workflow.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Development Workflow</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="deployment-graphs.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Experimental Deployment Graphs</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><!-- Override the footer area for the sphinx-book-theme to include the CSAT widget -->
<div id="csat">
  <div id="csat-feedback-received" class="csat-hidden">
    <span>谢谢你的反馈！</span>
  </div>
  <div id="csat-inputs">
    <span>是否能帮助到你？</span>
    <div id="csat-yes" class="csat-button">
      <svg id="csat-yes-icon" class="csat-hidden csat-icon" width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 10.172L16.1922 0.979004L17.6072 2.393L7.00023 13L0.63623 6.636L2.05023 5.222L7.00023 10.172Z" fill="black"/>
      </svg>
      <span>是<span>
    </div>
    <div id="csat-no" class="csat-button">
      <svg id="csat-no-icon" class="csat-hidden csat-icon" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 5.58599L11.9502 0.635986L13.3642 2.04999L8.41423 6.99999L13.3642 11.95L11.9502 13.364L7.00023 8.41399L2.05023 13.364L0.63623 11.95L5.58623 6.99999L0.63623 2.04999L2.05023 0.635986L7.00023 5.58599Z" fill="black"/>
      </svg>
      <span>否<span>
    </div>
  </div>
  <div id="csat-textarea-group" class="csat-hidden">
    <span id="csat-feedback-label">反馈</span>
    <textarea id="csat-textarea"></textarea>
    <div id="csat-submit">提交</div>
  </div>
</div><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2024, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>