
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>设置 FastAPI 及 HTTP &#8212; Ray 2.7.2</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/versionwarning.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../_static/js/docsearch.js"></script>
    <script defer="defer" src="../_static/js/csat.js"></script>
    <script defer="defer" src="../_static/js/termynal.js"></script>
    <script defer="defer" src="../_static/js/custom.js"></script>
    <script defer="defer" src="../_static/js/top-navigation.js"></script>
    <script src="../_static/js/tags.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/serve/http-guide.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Production Guide" href="production-guide/index.html" />
    <link rel="prev" title="配置 Ray Serve 发布" href="configure-serve-deployment.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
  data-modal-disclaimer = "Results are automated and may be incorrect or contain inappropriate information. Do not include any personal data or confidential information."
  data-modal-title = "Ray Docs AI - Ask a Question"
  data-button-position-bottom = "60px"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 2.7.2</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    欢迎来到 Ray ！
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/index.html">
   概述「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/getting-started.html">
   入门
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/installation.html">
   安装「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/use-cases.html">
   用例「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/examples.html">
   示例库「1%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/ray-libraries.html">
   生态「3%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-core/walkthrough.html">
   Ray 核心「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/data.html">
   Ray 数据「75%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../train/train.html">
   Ray 训练「0%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tune/index.html">
   Ray 调参「0%」
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Ray Serve
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="getting_started.html">
     入门
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="key-concepts.html">
     关键概念
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="develop-and-deploy.html">
     开发并部署 ML 应用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="model_composition.html">
     部署模型组合
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="multi-app.html">
     部署多应用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="model-multiplexing.html">
     模型复用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="configure-serve-deployment.html">
     配置 Ray Serve 发布
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     设置 FastAPI 及 HTTP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="production-guide/index.html">
     生产指引
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="monitoring.html">
     监控你的应用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="resource-allocation.html">
     资源分配
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="autoscaling-guide.html">
     Ray Serve 自动扩缩
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="advanced-guides/index.html">
     高级指南
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="architecture.html">
     架构
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tutorials/index.html">
     示例
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="api/index.html">
     Ray Serve API
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../rllib/index.html">
   Ray RLlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-more-libs/index.html">
   更多类库「40%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../cluster/getting-started.html">
   Ray 集群「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-observability/index.html">
   监控调试「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-references/api.html">
   参考「20%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-contribute/index.html">
   开发者指引「30%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-security/index.html">
   安全「100%」
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Fserve/http-guide.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/serve/http-guide.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/serve/http-guide.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#choosing-the-right-http-feature">
   Choosing the right HTTP feature
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calling-deployments-via-http">
   Calling Deployments via HTTP
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#request-cancellation">
     Request cancellation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fastapi-http-deployments">
   FastAPI HTTP Deployments
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#websockets">
     WebSockets
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#streaming-responses">
   Streaming Responses
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#terminating-the-stream-when-a-client-disconnects">
     Terminating the stream when a client disconnects
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-keep-alive-timeout">
   Set keep alive timeout
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>设置 FastAPI 及 HTTP</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#choosing-the-right-http-feature">
   Choosing the right HTTP feature
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#calling-deployments-via-http">
   Calling Deployments via HTTP
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#request-cancellation">
     Request cancellation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fastapi-http-deployments">
   FastAPI HTTP Deployments
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#websockets">
     WebSockets
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#streaming-responses">
   Streaming Responses
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#terminating-the-stream-when-a-client-disconnects">
     Terminating the stream when a client disconnects
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-keep-alive-timeout">
   Set keep alive timeout
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="fastapi-http">
<span id="serve-set-up-fastapi-http"></span><h1>设置 FastAPI 及 HTTP<a class="headerlink" href="#fastapi-http" title="Permalink to this headline">#</a></h1>
<p>This section helps you understand how to:</p>
<ul class="simple">
<li><p>Send HTTP requests to Serve deployments</p></li>
<li><p>Use Ray Serve to integrate with FastAPI</p></li>
<li><p>Use customized HTTP adapters</p></li>
<li><p>Choose which feature to use for your use case</p></li>
<li><p>Set up keep alive timeout</p></li>
</ul>
<section id="choosing-the-right-http-feature">
<h2>Choosing the right HTTP feature<a class="headerlink" href="#choosing-the-right-http-feature" title="Permalink to this headline">#</a></h2>
<p>Serve offers a layered approach to expose your model with the right HTTP API.</p>
<p>Considering your use case, you can choose the right level of abstraction:</p>
<ul class="simple">
<li><p>If you are comfortable working with the raw request object, use <a class="reference internal" href="#serve-http"><span class="std std-ref"><code class="docutils literal notranslate"><span class="pre">starlette.request.Requests</span></code> API</span></a>.</p></li>
<li><p>If you want a fully fledged API server with validation and doc generation, use the <a class="reference internal" href="#serve-fastapi-http"><span class="std std-ref">FastAPI integration</span></a>.</p></li>
</ul>
</section>
<section id="calling-deployments-via-http">
<span id="serve-http"></span><h2>Calling Deployments via HTTP<a class="headerlink" href="#calling-deployments-via-http" title="Permalink to this headline">#</a></h2>
<p>When you deploy a Serve application, the <a class="reference internal" href="key-concepts.html#serve-key-concepts-ingress-deployment"><span class="std std-ref">ingress deployment</span></a> (the one passed to <code class="docutils literal notranslate"><span class="pre">serve.run</span></code>) is exposed over HTTP.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">starlette.requests</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Counter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">starlette</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">Request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span>


<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Counter</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000?a=b&amp;c=d&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="s2">&quot;d&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Requests to the Serve HTTP server at <code class="docutils literal notranslate"><span class="pre">/</span></code> are routed to the deployment’s <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method with a <a class="reference external" href="https://www.starlette.io/requests/">Starlette Request object</a> as the sole argument. The <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method can return any JSON-serializable object or a <a class="reference external" href="https://www.starlette.io/responses/">Starlette Response object</a> (e.g., to return a custom status code or custom headers). A Serve app’s route prefix can be changed from <code class="docutils literal notranslate"><span class="pre">/</span></code> to another string by setting <code class="docutils literal notranslate"><span class="pre">route_prefix</span></code> in <code class="docutils literal notranslate"><span class="pre">serve.run()</span></code> or the Serve config file.</p>
<section id="request-cancellation">
<span id="serve-request-cancellation-http"></span><h3>Request cancellation<a class="headerlink" href="#request-cancellation" title="Permalink to this headline">#</a></h3>
<p>When processing a request takes longer than the <a class="reference internal" href="advanced-guides/performance.html#serve-performance-e2e-timeout"><span class="std std-ref">end-to-end timeout</span></a> or an HTTP client disconnects before receiving a response, Serve cancels the in-flight request:</p>
<ul class="simple">
<li><p>If the proxy hasn’t yet sent the request to a replica, Serve simply drops the request.</p></li>
<li><p>If the request has been sent to a replica, Serve attempts to interrupt the replica and cancel the request. The <code class="docutils literal notranslate"><span class="pre">asyncio.Task</span></code> running the handler on the replica is cancelled, raising an <code class="docutils literal notranslate"><span class="pre">asyncio.CancelledError</span></code> the next time it enters an <code class="docutils literal notranslate"><span class="pre">await</span></code> statement. See <a class="reference external" href="https://docs.python.org/3/library/asyncio-task.html#task-cancellation">the asyncio docs</a> for more info. Handle this exception in a try-except block to customize your deployment’s behavior when a request is cancelled:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">startled</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Replica received request!&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
        <span class="c1"># Add custom behavior that should run</span>
        <span class="c1"># upon cancellation here.</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Request got cancelled!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If no <code class="docutils literal notranslate"><span class="pre">await</span></code> statements are left in the deployment’s code before the request completes, the replica processes the request as usual, sends the response back to the proxy, and the proxy discards the response. Use <code class="docutils literal notranslate"><span class="pre">await</span></code> statements for blocking operations in a deployment, so Serve can cancel in-flight requests without waiting for the blocking operation to complete.</p>
<p>Cancellation cascades to any downstream deployment handle, task, or actor calls that were spawned in the deployment’s request-handling method. These can handle the <code class="docutils literal notranslate"><span class="pre">asyncio.CancelledError</span></code> in the same way as the ingress deployment.</p>
<p>To prevent an async call from being interrupted by <code class="docutils literal notranslate"><span class="pre">asyncio.CancelledError</span></code>, use <code class="docutils literal notranslate"><span class="pre">asyncio.shield()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">SnoringSleeper</span><span class="p">:</span>
    
    <span class="k">async</span> <span class="k">def</span> <span class="nf">snore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ZZZ&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SnoringSleeper received request!&quot;</span><span class="p">)</span>

            <span class="c1"># Prevent the snore() method from being cancelled</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">shield</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">snore</span><span class="p">())</span>

        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SnoringSleeper&#39;s request was cancelled!&quot;</span><span class="p">)</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">SnoringSleeper</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
</pre></div>
</div>
<p>When the request is cancelled, a cancellation error is raised inside the <code class="docutils literal notranslate"><span class="pre">SnoringSleeper</span></code> deployment’s <code class="docutils literal notranslate"><span class="pre">__call__()</span></code> method. However, the cancellation is not raised inside the <code class="docutils literal notranslate"><span class="pre">snore()</span></code> call, so <code class="docutils literal notranslate"><span class="pre">ZZZ</span></code> is printed even if the request is cancelled. Note that <code class="docutils literal notranslate"><span class="pre">asyncio.shield</span></code> cannot be used on a <code class="docutils literal notranslate"><span class="pre">DeploymentHandle</span></code> call to prevent the downstream handler from being cancelled. You need to explicitly handle the cancellation error in that handler as well.</p>
</section>
</section>
<section id="fastapi-http-deployments">
<span id="serve-fastapi-http"></span><h2>FastAPI HTTP Deployments<a class="headerlink" href="#fastapi-http-deployments" title="Permalink to this headline">#</a></h2>
<p>If you want to define more complex HTTP handling logic, Serve integrates with <a class="reference external" href="https://fastapi.tiangolo.com/">FastAPI</a>. This allows you to define a Serve deployment using the <code class="xref py py-mod docutils literal notranslate"><span class="pre">&#64;serve.ingress</span></code> decorator that wraps a FastAPI app with its full range of features. The most basic example of this is shown below, but for more details on all that FastAPI has to offer such as variable routes, automatic type validation, dependency injection (e.g., for database connections), and more, please check out <a class="reference external" href="https://fastapi.tiangolo.com/">their documentation</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="nd">@serve</span><span class="o">.</span><span class="n">ingress</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyFastAPIDeployment</span><span class="p">:</span>
    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Hello, world!&quot;</span>


<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">MyFastAPIDeployment</span><span class="o">.</span><span class="n">bind</span><span class="p">(),</span> <span class="n">route_prefix</span><span class="o">=</span><span class="s2">&quot;/hello&quot;</span><span class="p">)</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000/hello&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Hello, world!&quot;</span>
</pre></div>
</div>
<p>Now if you send a request to <code class="docutils literal notranslate"><span class="pre">/hello</span></code>, this will be routed to the <code class="docutils literal notranslate"><span class="pre">root</span></code> method of our deployment. We can also easily leverage FastAPI to define multiple routes with different HTTP methods:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="nd">@serve</span><span class="o">.</span><span class="n">ingress</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MyFastAPIDeployment</span><span class="p">:</span>
    <span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Hello, world!&quot;</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/</span><span class="si">{subpath}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Hello from </span><span class="si">{</span><span class="n">subpath</span><span class="si">}</span><span class="s2">!&quot;</span>


<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">MyFastAPIDeployment</span><span class="o">.</span><span class="n">bind</span><span class="p">(),</span> <span class="n">route_prefix</span><span class="o">=</span><span class="s2">&quot;/hello&quot;</span><span class="p">)</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000/hello/Serve&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Hello from Serve!&quot;</span>
</pre></div>
</div>
<p>You can also pass in an existing FastAPI app to a deployment to serve it as-is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;Hello from the root!&quot;</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="nd">@serve</span><span class="o">.</span><span class="n">ingress</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">FastAPIWrapper</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">FastAPIWrapper</span><span class="o">.</span><span class="n">bind</span><span class="p">(),</span> <span class="n">route_prefix</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000/&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Hello from the root!&quot;</span>
</pre></div>
</div>
<p>This is useful for scaling out an existing FastAPI app with no modifications necessary.
Existing middlewares, <strong>automatic OpenAPI documentation generation</strong>, and other advanced FastAPI features should work as-is.</p>
<section id="websockets">
<h3>WebSockets<a class="headerlink" href="#websockets" title="Permalink to this headline">#</a></h3>
<p>Serve supports WebSockets via FastAPI:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">WebSocket</span><span class="p">,</span> <span class="n">WebSocketDisconnect</span>

<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="nd">@serve</span><span class="o">.</span><span class="n">ingress</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">EchoServer</span><span class="p">:</span>
    <span class="nd">@app</span><span class="o">.</span><span class="n">websocket</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">echo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ws</span><span class="p">:</span> <span class="n">WebSocket</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">receive_text</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">ws</span><span class="o">.</span><span class="n">send_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">WebSocketDisconnect</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Client disconnected.&quot;</span><span class="p">)</span>


<span class="n">serve_app</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">EchoServer</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>
</pre></div>
</div>
<p>Decorate the function that handles WebSocket requests with <code class="docutils literal notranslate"><span class="pre">&#64;app.websocket</span></code>. Read more about FastAPI WebSockets in the <a class="reference external" href="https://fastapi.tiangolo.com/advanced/websockets/">FastAPI documentation</a>.</p>
<p>Query the deployment using the <code class="docutils literal notranslate"><span class="pre">websockets</span></code> package (<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">websockets</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">websockets.sync.client</span> <span class="kn">import</span> <span class="n">connect</span>

<span class="k">with</span> <span class="n">connect</span><span class="p">(</span><span class="s2">&quot;ws://localhost:8000&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">websocket</span><span class="p">:</span>
    <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Eureka!&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Eureka!&quot;</span>

    <span class="n">websocket</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;I&#39;ve found it!&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">websocket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;I&#39;ve found it!&quot;</span>
</pre></div>
</div>
</section>
</section>
<section id="streaming-responses">
<span id="serve-http-streaming-response"></span><h2>Streaming Responses<a class="headerlink" href="#streaming-responses" title="Permalink to this headline">#</a></h2>
<p>Some applications must stream incremental results back to the caller.
This is common for text generation using large language models (LLMs) or video processing applications.
The full forward pass may take multiple seconds, so providing incremental results as they’re available provides a much better user experience.</p>
<p>To use HTTP response streaming, return a <a class="reference external" href="https://www.starlette.io/responses/#streamingresponse">StreamingResponse</a> that wraps a generator from your HTTP handler.
This is supported for basic HTTP ingress deployments using a <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method and when using the <a class="reference internal" href="#serve-fastapi-http"><span class="std std-ref">FastAPI integration</span></a>.</p>
<p>The code below defines a Serve application that incrementally streams numbers up to a provided <code class="docutils literal notranslate"><span class="pre">max</span></code>.
The client-side code is also updated to handle the streaming outputs.
This code uses the <code class="docutils literal notranslate"><span class="pre">stream=True</span></code> option to the <a class="reference external" href="https://requests.readthedocs.io/en/latest/user/advanced/#streaming-requests">requests</a> library.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generator</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">starlette.responses</span> <span class="kn">import</span> <span class="n">StreamingResponse</span>
<span class="kn">from</span> <span class="nn">starlette.requests</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">StreamingResponder</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">generate_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">max</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">):</span>
            <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StreamingResponse</span><span class="p">:</span>
        <span class="nb">max</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="s2">&quot;25&quot;</span><span class="p">)</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_numbers</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span><span class="p">)</span>


<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">StreamingResponder</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000?max=10&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decode_unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got result </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">s after start: &#39;</span><span class="si">{</span><span class="n">chunk</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Save this code in <code class="docutils literal notranslate"><span class="pre">stream.py</span></code> and run it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python stream.py
<span class="o">[</span><span class="m">2023</span>-05-25 <span class="m">10</span>:44:23<span class="o">]</span>  INFO ray._private.worker::Started a <span class="nb">local</span> Ray instance. View the dashboard at http://127.0.0.1:8265
<span class="o">(</span>ServeController <span class="nv">pid</span><span class="o">=</span><span class="m">40401</span><span class="o">)</span> INFO <span class="m">2023</span>-05-25 <span class="m">10</span>:44:25,296 controller <span class="m">40401</span> deployment_state.py:1259 - Deploying new version of deployment default_StreamingResponder.
<span class="o">(</span>HTTPProxyActor <span class="nv">pid</span><span class="o">=</span><span class="m">40403</span><span class="o">)</span> INFO:     Started server process <span class="o">[</span><span class="m">40403</span><span class="o">]</span>
<span class="o">(</span>ServeController <span class="nv">pid</span><span class="o">=</span><span class="m">40401</span><span class="o">)</span> INFO <span class="m">2023</span>-05-25 <span class="m">10</span>:44:25,333 controller <span class="m">40401</span> deployment_state.py:1498 - Adding <span class="m">1</span> replica to deployment default_StreamingResponder.
Got result <span class="m">0</span>.0s after start: <span class="s1">&#39;0&#39;</span>
Got result <span class="m">0</span>.1s after start: <span class="s1">&#39;1&#39;</span>
Got result <span class="m">0</span>.2s after start: <span class="s1">&#39;2&#39;</span>
Got result <span class="m">0</span>.3s after start: <span class="s1">&#39;3&#39;</span>
Got result <span class="m">0</span>.4s after start: <span class="s1">&#39;4&#39;</span>
Got result <span class="m">0</span>.5s after start: <span class="s1">&#39;5&#39;</span>
Got result <span class="m">0</span>.6s after start: <span class="s1">&#39;6&#39;</span>
Got result <span class="m">0</span>.7s after start: <span class="s1">&#39;7&#39;</span>
Got result <span class="m">0</span>.8s after start: <span class="s1">&#39;8&#39;</span>
Got result <span class="m">0</span>.9s after start: <span class="s1">&#39;9&#39;</span>
<span class="o">(</span>ServeReplica:default_StreamingResponder <span class="nv">pid</span><span class="o">=</span><span class="m">41052</span><span class="o">)</span> INFO <span class="m">2023</span>-05-25 <span class="m">10</span>:49:52,230 default_StreamingResponder default_StreamingResponder#qlZFCa yomKnJifNJ / default replica.py:634 - __CALL__ OK <span class="m">1017</span>.6ms
</pre></div>
</div>
<section id="terminating-the-stream-when-a-client-disconnects">
<h3>Terminating the stream when a client disconnects<a class="headerlink" href="#terminating-the-stream-when-a-client-disconnects" title="Permalink to this headline">#</a></h3>
<p>In some cases, you may want to cease processing a request when the client disconnects before the full stream has been returned.
If you pass an async generator to <code class="docutils literal notranslate"><span class="pre">StreamingResponse</span></code>, it is cancelled and raises an <code class="docutils literal notranslate"><span class="pre">asyncio.CancelledError</span></code> when the client disconnects.
Note that you must <code class="docutils literal notranslate"><span class="pre">await</span></code> at some point in the generator for the cancellation to occur.</p>
<p>In the example below, the generator streams responses forever until the client disconnects, then it prints that it was cancelled and exits. Save this code in <code class="docutils literal notranslate"><span class="pre">stream.py</span></code> and run it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">AsyncGenerator</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">starlette.responses</span> <span class="kn">import</span> <span class="n">StreamingResponse</span>
<span class="kn">from</span> <span class="nn">starlette.requests</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">StreamingResponder</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">generate_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cancelled! Exiting.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">StreamingResponse</span><span class="p">:</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_forever</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">StreamingResponse</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="s2">&quot;text/plain&quot;</span><span class="p">)</span>


<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">StreamingResponder</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000?max=10&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">iter_content</span><span class="p">(</span><span class="n">chunk_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decode_unicode</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got result </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2">s after start: &#39;</span><span class="si">{</span><span class="n">chunk</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Client disconnecting&quot;</span><span class="p">)</span>
        <span class="k">break</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python stream.py
<span class="o">[</span><span class="m">2023</span>-07-10 <span class="m">16</span>:08:41<span class="o">]</span>  INFO ray._private.worker::Started a <span class="nb">local</span> Ray instance. View the dashboard at http://127.0.0.1:8265
<span class="o">(</span>ServeController <span class="nv">pid</span><span class="o">=</span><span class="m">50801</span><span class="o">)</span> INFO <span class="m">2023</span>-07-10 <span class="m">16</span>:08:42,296 controller <span class="m">40401</span> deployment_state.py:1259 - Deploying new version of deployment default_StreamingResponder.
<span class="o">(</span>HTTPProxyActor <span class="nv">pid</span><span class="o">=</span><span class="m">50803</span><span class="o">)</span> INFO:     Started server process <span class="o">[</span><span class="m">50803</span><span class="o">]</span>
<span class="o">(</span>ServeController <span class="nv">pid</span><span class="o">=</span><span class="m">50805</span><span class="o">)</span> INFO <span class="m">2023</span>-07-10 <span class="m">16</span>:08:42,963 controller <span class="m">50805</span> deployment_state.py:1586 - Adding <span class="m">1</span> replica to deployment default_StreamingResponder.
Got result <span class="m">0</span>.0s after start: <span class="s1">&#39;0&#39;</span>
Got result <span class="m">0</span>.1s after start: <span class="s1">&#39;1&#39;</span>
Got result <span class="m">0</span>.2s after start: <span class="s1">&#39;2&#39;</span>
Got result <span class="m">0</span>.3s after start: <span class="s1">&#39;3&#39;</span>
Got result <span class="m">0</span>.4s after start: <span class="s1">&#39;4&#39;</span>
Got result <span class="m">0</span>.5s after start: <span class="s1">&#39;5&#39;</span>
Got result <span class="m">0</span>.6s after start: <span class="s1">&#39;6&#39;</span>
Got result <span class="m">0</span>.7s after start: <span class="s1">&#39;7&#39;</span>
Got result <span class="m">0</span>.8s after start: <span class="s1">&#39;8&#39;</span>
Got result <span class="m">0</span>.9s after start: <span class="s1">&#39;9&#39;</span>
Got result <span class="m">1</span>.0s after start: <span class="s1">&#39;10&#39;</span>
Client disconnecting
<span class="o">(</span>ServeReplica:default_StreamingResponder <span class="nv">pid</span><span class="o">=</span><span class="m">50842</span><span class="o">)</span> Cancelled! Exiting.
<span class="o">(</span>ServeReplica:default_StreamingResponder <span class="nv">pid</span><span class="o">=</span><span class="m">50842</span><span class="o">)</span> INFO <span class="m">2023</span>-07-10 <span class="m">16</span>:08:45,756 default_StreamingResponder default_StreamingResponder#cmpnmF ahteNDQSWx / default replica.py:691 - __CALL__ OK <span class="m">1019</span>.1ms
</pre></div>
</div>
</section>
</section>
<section id="set-keep-alive-timeout">
<span id="serve-http-guide-keep-alive-timeout"></span><h2>Set keep alive timeout<a class="headerlink" href="#set-keep-alive-timeout" title="Permalink to this headline">#</a></h2>
<p>Serve uses a Uvicorn HTTP server internally to serve HTTP requests. By default, Uvicorn
keeps HTTP connections alive for 5 seconds between requests. Modify the keep-alive
timeout by setting the <code class="docutils literal notranslate"><span class="pre">keep_alive_timeout_s</span></code> in the <code class="docutils literal notranslate"><span class="pre">http_options</span></code> field of the Serve
config files. This config is global to your Ray cluster, and you can’t update it during
runtime. You can also set the <code class="docutils literal notranslate"><span class="pre">RAY_SERVE_HTTP_KEEP_ALIVE_TIMEOUT_S</span></code> environment variable to
set the keep alive timeout. <code class="docutils literal notranslate"><span class="pre">RAY_SERVE_HTTP_KEEP_ALIVE_TIMEOUT_S</span></code> takes
precedence over the <code class="docutils literal notranslate"><span class="pre">keep_alive_timeout_s</span></code> config if both are set. See
Uvicorn’s keep alive timeout <a class="reference external" href="https://www.uvicorn.org/server-behavior/#timeouts">guide</a> for more information.</p>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="configure-serve-deployment.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">配置 Ray Serve 发布</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="production-guide/index.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Production Guide</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><!-- Override the footer area for the sphinx-book-theme to include the CSAT widget -->
<div id="csat">
  <div id="csat-feedback-received" class="csat-hidden">
    <span>谢谢你的反馈！</span>
  </div>
  <div id="csat-inputs">
    <span>是否能帮助到你？</span>
    <div id="csat-yes" class="csat-button">
      <svg id="csat-yes-icon" class="csat-hidden csat-icon" width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 10.172L16.1922 0.979004L17.6072 2.393L7.00023 13L0.63623 6.636L2.05023 5.222L7.00023 10.172Z" fill="black"/>
      </svg>
      <span>是<span>
    </div>
    <div id="csat-no" class="csat-button">
      <svg id="csat-no-icon" class="csat-hidden csat-icon" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 5.58599L11.9502 0.635986L13.3642 2.04999L8.41423 6.99999L13.3642 11.95L11.9502 13.364L7.00023 8.41399L2.05023 13.364L0.63623 11.95L5.58623 6.99999L0.63623 2.04999L2.05023 0.635986L7.00023 5.58599Z" fill="black"/>
      </svg>
      <span>否<span>
    </div>
  </div>
  <div id="csat-textarea-group" class="csat-hidden">
    <span id="csat-feedback-label">反馈</span>
    <textarea id="csat-textarea"></textarea>
    <div id="csat-submit">提交</div>
  </div>
</div><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2024, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>