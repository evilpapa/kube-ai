
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>部署模型组合 &#8212; Ray 2.7.2</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/versionwarning.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../_static/js/docsearch.js"></script>
    <script defer="defer" src="../_static/js/csat.js"></script>
    <script defer="defer" src="../_static/js/termynal.js"></script>
    <script defer="defer" src="../_static/js/custom.js"></script>
    <script defer="defer" src="../_static/js/top-navigation.js"></script>
    <script src="../_static/js/tags.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/serve/model_composition.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="部署多应用" href="multi-app.html" />
    <link rel="prev" title="开发并部署 ML 应用" href="develop-and-deploy.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
  data-modal-disclaimer = "Results are automated and may be incorrect or contain inappropriate information. Do not include any personal data or confidential information."
  data-modal-title = "Ray Docs AI - Ask a Question"
  data-button-position-bottom = "60px"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 2.7.2</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    欢迎来到 Ray ！
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/index.html">
   概述「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/getting-started.html">
   入门
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/installation.html">
   安装「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/use-cases.html">
   用例「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/examples.html">
   示例库「1%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/ray-libraries.html">
   生态「3%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-core/walkthrough.html">
   Ray 核心「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/data.html">
   Ray 数据「75%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../train/train.html">
   Ray 训练「0%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tune/index.html">
   Ray 调参「0%」
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Ray Serve
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="getting_started.html">
     入门
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="key-concepts.html">
     关键概念
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="develop-and-deploy.html">
     开发并部署 ML 应用
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     部署模型组合
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="multi-app.html">
     部署多应用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="model-multiplexing.html">
     模型复用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="configure-serve-deployment.html">
     配置 Ray Serve 发布
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="http-guide.html">
     设置 FastAPI 及 HTTP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="production-guide/index.html">
     生产指引
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="monitoring.html">
     监控你的应用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="resource-allocation.html">
     资源分配
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="autoscaling-guide.html">
     Ray Serve 自动扩缩
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="advanced-guides/index.html">
     高级指南
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="architecture.html">
     架构
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tutorials/index.html">
     示例
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="api/index.html">
     Ray Serve API
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../rllib/index.html">
   Ray RLlib
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-more-libs/index.html">
   更多类库「40%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../cluster/getting-started.html">
   Ray 集群「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-observability/index.html">
   监控调试「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-references/api.html">
   参考「20%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-contribute/index.html">
   开发者指引「30%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-security/index.html">
   安全「100%」
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Fserve/model_composition.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/serve/model_composition.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/serve/model_composition.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compose-deployments-using-deploymenthandles">
   Compose deployments using DeploymentHandles
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#basic-deploymenthandle-example">
   Basic DeploymentHandle example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#chaining-deploymenthandle-calls">
   Chaining DeploymentHandle calls
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#streaming-deploymenthandle-calls">
   Streaming DeploymentHandle calls
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#advanced-pass-a-deploymentresponse-by-reference">
   Advanced: Pass a DeploymentResponse “by reference”
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#advanced-convert-a-deploymentresponse-to-a-ray-objectref">
   Advanced: Convert a DeploymentResponse to a Ray ObjectRef
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>部署模型组合</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#compose-deployments-using-deploymenthandles">
   Compose deployments using DeploymentHandles
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#basic-deploymenthandle-example">
   Basic DeploymentHandle example
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#chaining-deploymenthandle-calls">
   Chaining DeploymentHandle calls
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#streaming-deploymenthandle-calls">
   Streaming DeploymentHandle calls
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#advanced-pass-a-deploymentresponse-by-reference">
   Advanced: Pass a DeploymentResponse “by reference”
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#advanced-convert-a-deploymentresponse-to-a-ray-objectref">
   Advanced: Convert a DeploymentResponse to a Ray ObjectRef
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="serve-model-composition">
<span id="id1"></span><h1>部署模型组合<a class="headerlink" href="#serve-model-composition" title="Permalink to this headline">#</a></h1>
<p>With this guide, you can:</p>
<ul class="simple">
<li><p>Compose multiple <a class="reference internal" href="key-concepts.html#serve-key-concepts-deployment"><span class="std std-ref">deployments</span></a> containing ML models or business logic into a single <a class="reference internal" href="key-concepts.html#serve-key-concepts-application"><span class="std std-ref">application</span></a></p></li>
<li><p>Independently scale and configure each of your ML models and business logic steps</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Ray 2.7 introduced a new <a class="reference internal" href="api/doc/ray.serve.handle.DeploymentHandle.html#ray.serve.handle.DeploymentHandle" title="ray.serve.handle.DeploymentHandle"><code class="xref py py-mod docutils literal notranslate"><span class="pre">DeploymentHandle</span></code></a> API that replaces the <code class="docutils literal notranslate"><span class="pre">RayServeHandle</span></code> and <code class="docutils literal notranslate"><span class="pre">RayServeSyncHandle</span></code> APIs.
Your existing code with <code class="docutils literal notranslate"><span class="pre">RayServeHandle</span></code> and <code class="docutils literal notranslate"><span class="pre">RayServeSyncHandle</span></code> API calls continues to work, but the recommendation is to opt-in to the newer API to avoid breakages in the future.
To opt into the new API, you can either use <code class="docutils literal notranslate"><span class="pre">handle.options(use_new_handle_api=True)</span></code> on each handle or set it globally by setting this environment variable: <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">RAY_SERVE_ENABLE_NEW_HANDLE_API=1</span></code>.</p>
</div>
<section id="compose-deployments-using-deploymenthandles">
<h2>Compose deployments using DeploymentHandles<a class="headerlink" href="#compose-deployments-using-deploymenthandles" title="Permalink to this headline">#</a></h2>
<p>When building an application, you can <code class="docutils literal notranslate"><span class="pre">.bind()</span></code> multiple deployments and pass them to each other’s constructors.
At runtime, inside the deployment code Ray Serve substitutes the bound deployments with
<a class="reference internal" href="key-concepts.html#serve-key-concepts-deployment-handle"><span class="std std-ref">DeploymentHandles</span></a> that you can use to call methods of other deployments.
This capability lets you divide your application’s steps, such as preprocessing, model inference, and post-processing, into independent deployments that you can independently scale and configure.</p>
<p>Use <a class="reference internal" href="api/doc/ray.serve.handle.DeploymentHandle.html#ray.serve.handle.DeploymentHandle.remote" title="ray.serve.handle.DeploymentHandle.remote"><code class="xref py py-mod docutils literal notranslate"><span class="pre">handle.remote</span></code></a> to send requests to a deployment.
These requests can contain ordinary Python args and kwargs, which DeploymentHandles can pass  directly to the method.
The method call returns a <a class="reference internal" href="api/doc/ray.serve.handle.DeploymentResponse.html#ray.serve.handle.DeploymentResponse" title="ray.serve.handle.DeploymentResponse"><code class="xref py py-mod docutils literal notranslate"><span class="pre">DeploymentResponse</span></code></a> that represents a future to the output.
You can <code class="docutils literal notranslate"><span class="pre">await</span></code> the response to retrieve its result or pass it to another downstream <a class="reference internal" href="api/doc/ray.serve.handle.DeploymentHandle.html#ray.serve.handle.DeploymentHandle" title="ray.serve.handle.DeploymentHandle"><code class="xref py py-mod docutils literal notranslate"><span class="pre">DeploymentHandle</span></code></a> call.</p>
</section>
<section id="basic-deploymenthandle-example">
<span id="serve-model-composition-deployment-handles"></span><h2>Basic DeploymentHandle example<a class="headerlink" href="#basic-deploymenthandle-example" title="Permalink to this headline">#</a></h2>
<p>This example has two deployments:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1"># File name: hello.py</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">ray.serve.handle</span> <span class="kn">import</span> <span class="n">DeploymentHandle</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="linenos"> 7</span><span class="k">class</span> <span class="nc">LanguageClassifer</span><span class="p">:</span>
<span class="linenos"> 8</span>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spanish_responder</span><span class="p">,</span> <span class="n">french_responder</span><span class="p">):</span>
<span class="linenos"> 9</span>        <span class="bp">self</span><span class="o">.</span><span class="n">spanish_responder</span><span class="p">:</span> <span class="n">DeploymentHandle</span> <span class="o">=</span> <span class="n">spanish_responder</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
<span class="linenos">10</span>            <span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">11</span>        <span class="p">)</span>
<span class="linenos">12</span>        <span class="bp">self</span><span class="o">.</span><span class="n">french_responder</span> <span class="o">=</span> <span class="n">french_responder</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
<span class="linenos">13</span>            <span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="linenos">14</span>        <span class="p">)</span>
<span class="linenos">15</span>
<span class="linenos">16</span>    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">http_request</span><span class="p">):</span>
<span class="linenos">17</span>        <span class="n">request</span> <span class="o">=</span> <span class="k">await</span> <span class="n">http_request</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="linenos">18</span>        <span class="n">language</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s2">&quot;language&quot;</span><span class="p">],</span> <span class="n">request</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<span class="linenos">19</span>
<span class="linenos">20</span>        <span class="k">if</span> <span class="n">language</span> <span class="o">==</span> <span class="s2">&quot;spanish&quot;</span><span class="p">:</span>
<span class="linenos">21</span>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spanish_responder</span><span class="o">.</span><span class="n">say_hello</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos">22</span>        <span class="k">elif</span> <span class="n">language</span> <span class="o">==</span> <span class="s2">&quot;french&quot;</span><span class="p">:</span>
<span class="linenos">23</span>            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">french_responder</span><span class="o">.</span><span class="n">say_hello</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<span class="linenos">24</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">25</span>            <span class="k">return</span> <span class="s2">&quot;Please try again.&quot;</span>
<span class="linenos">26</span>
<span class="linenos">27</span>        <span class="k">return</span> <span class="k">await</span> <span class="n">response</span>
<span class="linenos">28</span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="linenos">31</span><span class="k">class</span> <span class="nc">SpanishResponder</span><span class="p">:</span>
<span class="linenos">32</span>    <span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">33</span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Hola </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">34</span>
<span class="linenos">35</span>
<span class="linenos">36</span><span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="linenos">37</span><span class="k">class</span> <span class="nc">FrenchResponder</span><span class="p">:</span>
<span class="linenos">38</span>    <span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="linenos">39</span>        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Bonjour </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="linenos">40</span>
<span class="linenos">41</span>
<span class="linenos">42</span><span class="n">spanish_responder</span> <span class="o">=</span> <span class="n">SpanishResponder</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
<span class="linenos">43</span><span class="n">french_responder</span> <span class="o">=</span> <span class="n">FrenchResponder</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
<span class="linenos">44</span><span class="n">language_classifier</span> <span class="o">=</span> <span class="n">LanguageClassifer</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">spanish_responder</span><span class="p">,</span> <span class="n">french_responder</span><span class="p">)</span>
</pre></div>
</div>
<p>In line 44, the <code class="docutils literal notranslate"><span class="pre">LanguageClassifier</span></code> deployment takes in the <code class="docutils literal notranslate"><span class="pre">spanish_responder</span></code> and <code class="docutils literal notranslate"><span class="pre">french_responder</span></code> as constructor arguments. At runtime, Ray Serve converts these arguments into <code class="docutils literal notranslate"><span class="pre">DeploymentHandles</span></code>. <code class="docutils literal notranslate"><span class="pre">LanguageClassifier</span></code> can then call the <code class="docutils literal notranslate"><span class="pre">spanish_responder</span></code> and <code class="docutils literal notranslate"><span class="pre">french_responder</span></code>’s deployment methods using this handle.</p>
<p>For example, the <code class="docutils literal notranslate"><span class="pre">LanguageClassifier</span></code>’s <code class="docutils literal notranslate"><span class="pre">__call__</span></code> method uses the HTTP request’s values to decide whether to respond in Spanish or French. It then forwards the request’s name to the <code class="docutils literal notranslate"><span class="pre">spanish_responder</span></code> or the <code class="docutils literal notranslate"><span class="pre">french_responder</span></code> on lines 20 and 23 using the <code class="docutils literal notranslate"><span class="pre">DeploymentHandle</span></code>s. The format of the calls is as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">response</span><span class="p">:</span> <span class="n">DeploymentResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spanish_responder</span><span class="o">.</span><span class="n">say_hello</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>This call has a few parts:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">self.spanish_responder</span></code> is the <code class="docutils literal notranslate"><span class="pre">SpanishResponder</span></code> handle taken in through the constructor.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">say_hello</span></code> is the <code class="docutils literal notranslate"><span class="pre">SpanishResponder</span></code> method to invoke.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">remote</span></code> indicates that this is a <code class="docutils literal notranslate"><span class="pre">DeploymentHandle</span></code> call to another deployment.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> is the argument for <code class="docutils literal notranslate"><span class="pre">say_hello</span></code>. You can pass any number of arguments or keyword arguments here.</p></li>
</ul>
<p>This call returns a <code class="docutils literal notranslate"><span class="pre">DeploymentResponse</span></code> object, which is a reference to the result, rather than the result itself.
This pattern allows the call to execute asynchronously.
To get the actual result, <code class="docutils literal notranslate"><span class="pre">await</span></code> the response.
<code class="docutils literal notranslate"><span class="pre">await</span></code> blocks until the asynchronous call executes and then returns the result.
In this example, line 23 calls <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">response</span></code> and returns the resulting string.</p>
<div class="admonition warning" id="serve-model-composition-await-warning">
<p class="admonition-title">Warning</p>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">response.result()</span></code> method to get the return value of remote <code class="docutils literal notranslate"><span class="pre">DeploymentHandle</span></code> calls.
However, avoid calling <code class="docutils literal notranslate"><span class="pre">.result()</span></code> from inside a deployment because it blocks the deployment from executing any other code until the remote method call finishes.
Using <code class="docutils literal notranslate"><span class="pre">await</span></code> lets the deployment process other requests while waiting for the remote method call to finish.
You should use <code class="docutils literal notranslate"><span class="pre">await</span></code> instead of <code class="docutils literal notranslate"><span class="pre">.result()</span></code> inside deployments.</p>
</div>
<p>You can copy the preceding <code class="docutils literal notranslate"><span class="pre">hello.py</span></code> script and run it with <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code>. Make sure to run the command from a directory containing <code class="docutils literal notranslate"><span class="pre">hello.py</span></code>, so it can locate the script:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>serve run hello:language_classifier
</pre></div>
</div>
<p>You can use this client script to interact with the example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File name: hello_client.py</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;spanish&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dora&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="n">greeting</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span>
<span class="nb">print</span><span class="p">(</span><span class="n">greeting</span><span class="p">)</span>
</pre></div>
</div>
<p>While the <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code> command is running, open a separate terminal window and run the script:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python hello_client.py

<span class="go">Hola Dora</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Composition lets you break apart your application and independently scale each part. For instance, suppose this <code class="docutils literal notranslate"><span class="pre">LanguageClassifier</span></code> application’s requests were 75% Spanish and 25% French. You could scale your <code class="docutils literal notranslate"><span class="pre">SpanishResponder</span></code> to have 3 replicas and your <code class="docutils literal notranslate"><span class="pre">FrenchResponder</span></code> to have 1 replica, so you can meet your workload’s demand. This flexibility also applies to reserving resources like CPUs and GPUs, as well as any other configurations you can set for each deployment.</p>
<p>With composition, you can avoid application-level bottlenecks when serving models and business logic steps that use different types and amounts of resources.</p>
</div>
</section>
<section id="chaining-deploymenthandle-calls">
<h2>Chaining DeploymentHandle calls<a class="headerlink" href="#chaining-deploymenthandle-calls" title="Permalink to this headline">#</a></h2>
<p>Ray Serve can directly pass the <code class="docutils literal notranslate"><span class="pre">DeploymentResponse</span></code> object that a <code class="docutils literal notranslate"><span class="pre">DeploymentHandle</span></code> returns, to another <code class="docutils literal notranslate"><span class="pre">DeploymentHandle</span></code> call to chain together multiple stages of a pipeline.
You don’t need to <code class="docutils literal notranslate"><span class="pre">await</span></code> the first response, Ray Serve
manages the <code class="docutils literal notranslate"><span class="pre">await</span></code> behavior under the hood. When the first call finishes, Ray Serve passes the output of the first call, instead of the <code class="docutils literal notranslate"><span class="pre">DeploymentResponse</span></code> object, directly to the second call.</p>
<p>For example, the code sample below defines three deployments in an application:</p>
<ul class="simple">
<li><p>An <code class="docutils literal notranslate"><span class="pre">Adder</span></code> deployment that increments a value by its configured increment.</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">Multiplier</span></code> deployment that multiplies a value by its configured multiple.</p></li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">Ingress</span></code> deployment that chains calls to the adder and multiplier together and returns the final response.</p></li>
</ul>
<p>Note how the response from the <code class="docutils literal notranslate"><span class="pre">Adder</span></code> handle passes directly to the <code class="docutils literal notranslate"><span class="pre">Multiplier</span></code> handle, but inside the multiplier, the input argument resolves to the output of the <code class="docutils literal notranslate"><span class="pre">Adder</span></code> call.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File name: chain.py</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve.handle</span> <span class="kn">import</span> <span class="n">DeploymentHandle</span><span class="p">,</span> <span class="n">DeploymentResponse</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Adder</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">increment</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_increment</span> <span class="o">=</span> <span class="n">increment</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_increment</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Multiplier</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multiple</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multiple</span> <span class="o">=</span> <span class="n">multiple</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">val</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multiple</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Ingress</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">adder</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adder</span><span class="p">:</span> <span class="n">DeploymentHandle</span> <span class="o">=</span> <span class="n">adder</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multiplier</span><span class="p">:</span> <span class="n">DeploymentHandle</span> <span class="o">=</span> <span class="n">multiplier</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">adder_response</span><span class="p">:</span> <span class="n">DeploymentResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adder</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="c1"># Pass the adder response directly into the multipler (no `await` needed).</span>
        <span class="n">multiplier_response</span><span class="p">:</span> <span class="n">DeploymentResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multiplier</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
            <span class="n">adder_response</span>
        <span class="p">)</span>
        <span class="c1"># `await` the final chained response.</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">multiplier_response</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Ingress</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
    <span class="n">Adder</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">increment</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">Multiplier</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">multiple</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">handle</span><span class="p">:</span> <span class="n">DeploymentHandle</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="o">==</span> <span class="mi">12</span><span class="p">,</span> <span class="s2">&quot;(5 + 1) * 2 = 12&quot;</span>
</pre></div>
</div>
</section>
<section id="streaming-deploymenthandle-calls">
<h2>Streaming DeploymentHandle calls<a class="headerlink" href="#streaming-deploymenthandle-calls" title="Permalink to this headline">#</a></h2>
<p>You can also use <code class="docutils literal notranslate"><span class="pre">DeploymentHandles</span></code> to make streaming method calls that return multiple outputs.
To make a streaming call, the method must be a generator and you must set <code class="docutils literal notranslate"><span class="pre">handle.options(stream=True)</span></code>.
Then, the handle call returns a <a class="reference internal" href="api/doc/ray.serve.handle.DeploymentResponseGenerator.html#ray.serve.handle.DeploymentResponseGenerator" title="ray.serve.handle.DeploymentResponseGenerator"><code class="xref py py-mod docutils literal notranslate"><span class="pre">DeploymentResponseGenerator</span></code></a> instead of a unary <code class="docutils literal notranslate"><span class="pre">DeploymentResponse</span></code>.
You can use <code class="docutils literal notranslate"><span class="pre">DeploymentResponseGenerators</span></code> as a sync or async generator, like in an <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">for</span></code> code block.
Similar to <code class="docutils literal notranslate"><span class="pre">DeploymentResponse.result()</span></code>, avoid using a <code class="docutils literal notranslate"><span class="pre">DeploymentResponseGenerator</span></code> as a sync generator within a deployment, as that blocks other requests from executing concurrently on that replica.
Note that you can’t pass <code class="docutils literal notranslate"><span class="pre">DeploymentResponseGenerators</span></code> to other handle calls.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File name: stream.py</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">AsyncGenerator</span><span class="p">,</span> <span class="n">Generator</span>

<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve.handle</span> <span class="kn">import</span> <span class="n">DeploymentHandle</span><span class="p">,</span> <span class="n">DeploymentResponseGenerator</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Streamer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">limit</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">i</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Caller</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">streamer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_streamer</span><span class="p">:</span> <span class="n">DeploymentHandle</span> <span class="o">=</span> <span class="n">streamer</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="c1"># Must set `stream=True` on the handle, then the output will be a</span>
            <span class="c1"># response generator.</span>
            <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="c1"># Response generator can be used in an `async for` block.</span>
        <span class="n">r</span><span class="p">:</span> <span class="n">DeploymentResponseGenerator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_streamer</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">i</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Caller</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">Streamer</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>

<span class="n">handle</span><span class="p">:</span> <span class="n">DeploymentHandle</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
    <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Response generator can also be used as a regular generator in a sync context.</span>
<span class="n">r</span><span class="p">:</span> <span class="n">DeploymentResponseGenerator</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="advanced-pass-a-deploymentresponse-by-reference">
<h2>Advanced: Pass a DeploymentResponse “by reference”<a class="headerlink" href="#advanced-pass-a-deploymentresponse-by-reference" title="Permalink to this headline">#</a></h2>
<p>By default, when you pass a <code class="docutils literal notranslate"><span class="pre">DeploymentResponse</span></code> to another <code class="docutils literal notranslate"><span class="pre">DeploymentHandle</span></code> call, Ray Serve passes the result of the <code class="docutils literal notranslate"><span class="pre">DeploymentResponse</span></code> directly to the downstream method once it’s ready.
However, in some cases you might want to start executing the downstream call before the result is ready. For example, to do some preprocessing or fetch a file from remote storage.
To accomplish this behavior, pass the <code class="docutils literal notranslate"><span class="pre">DeploymentResponse</span></code> “by reference” by embedding it in another Python object, such as a list or dictionary.
When you pass responses by reference, Ray Serve replaces them with Ray <code class="docutils literal notranslate"><span class="pre">ObjectRef</span></code>s instead of the resulting value and they can start executing before the result is ready.</p>
<p>The example below has two deployments: a preprocessor and a downstream model that takes the output of the preprocessor.
The downstream model has two methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pass_by_value</span></code> takes the output of the preprocessor “by value,” so it doesn’t execute until the preprocessor finishes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pass_by_reference</span></code> takes the output “by reference,” so it gets an <code class="docutils literal notranslate"><span class="pre">ObjectRef</span></code> and executes eagerly.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File name: response_to_object_ref.py</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">ObjectRef</span>

<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve.handle</span> <span class="kn">import</span> <span class="n">DeploymentHandle</span><span class="p">,</span> <span class="n">DeploymentResponse</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Preprocessor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Hello from preprocessor!&quot;</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">DownstreamModel</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">pass_by_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Got result by value: &#39;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">pass_by_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wrapped_result</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">ObjectRef</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="c1"># Do some preprocessing work before fetching the result.</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="k">await</span> <span class="n">wrapped_result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Got result by reference: &#39;</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&#39;&quot;</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Ingress</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preprocessor</span><span class="p">,</span> <span class="n">downstream</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="p">:</span> <span class="n">DeploymentHandle</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_downstream</span><span class="p">:</span> <span class="n">DeploymentHandle</span> <span class="o">=</span> <span class="n">downstream</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
            <span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">preprocessor_response</span><span class="p">:</span> <span class="n">DeploymentResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preprocessor</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;by_value&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_downstream</span><span class="o">.</span><span class="n">pass_by_value</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">preprocessor_response</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_downstream</span><span class="o">.</span><span class="n">pass_by_reference</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span>
                <span class="p">[</span><span class="n">preprocessor_response</span><span class="p">]</span>
            <span class="p">)</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Ingress</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">Preprocessor</span><span class="o">.</span><span class="n">bind</span><span class="p">(),</span> <span class="n">DownstreamModel</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>
<span class="n">handle</span><span class="p">:</span> <span class="n">DeploymentHandle</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">by_value_result</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;by_value&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">by_value_result</span> <span class="o">==</span> <span class="s2">&quot;Got result by value: &#39;Hello from preprocessor!&#39;&quot;</span>

<span class="n">by_reference_result</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;by_reference&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
<span class="k">assert</span> <span class="n">by_reference_result</span> <span class="o">==</span> <span class="s2">&quot;Got result by reference: &#39;Hello from preprocessor!&#39;&quot;</span>
</pre></div>
</div>
</section>
<section id="advanced-convert-a-deploymentresponse-to-a-ray-objectref">
<h2>Advanced: Convert a DeploymentResponse to a Ray ObjectRef<a class="headerlink" href="#advanced-convert-a-deploymentresponse-to-a-ray-objectref" title="Permalink to this headline">#</a></h2>
<p>Under the hood, each <code class="docutils literal notranslate"><span class="pre">DeploymentResponse</span></code> corresponds to a Ray <code class="docutils literal notranslate"><span class="pre">ObjectRef</span></code>, or a <code class="docutils literal notranslate"><span class="pre">StreamingObjectRefGenerator</span></code> for streaming calls.
To compose <code class="docutils literal notranslate"><span class="pre">DeploymentHandle</span></code> calls with Ray Actors or Tasks, you may want to resolve the response to its <code class="docutils literal notranslate"><span class="pre">ObjectRef</span></code>.
For this purpose, you can use the <a class="reference internal" href="api/doc/ray.serve.handle.DeploymentResponse.html#ray.serve.handle.DeploymentResponse" title="ray.serve.handle.DeploymentResponse"><code class="xref py py-mod docutils literal notranslate"><span class="pre">DeploymentResponse._to_object_ref</span></code></a> and <a class="reference internal" href="api/doc/ray.serve.handle.DeploymentResponse.html#ray.serve.handle.DeploymentResponse" title="ray.serve.handle.DeploymentResponse"><code class="xref py py-mod docutils literal notranslate"><span class="pre">DeploymentResponse._to_object_ref_sync</span></code></a> developer APIs.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File name: response_to_object_ref.py</span>
<span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve.handle</span> <span class="kn">import</span> <span class="n">DeploymentHandle</span><span class="p">,</span> <span class="n">DeploymentResponse</span>


<span class="nd">@ray</span><span class="o">.</span><span class="n">remote</span>
<span class="k">def</span> <span class="nf">say_hi_task</span><span class="p">(</span><span class="n">inp</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Ray task got message: &#39;</span><span class="si">{</span><span class="n">inp</span><span class="si">}</span><span class="s2">&#39;&quot;</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">SayHi</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Hi from Serve deployment&quot;</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Ingress</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">say_hi</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_say_hi</span><span class="p">:</span> <span class="n">DeploymentHandle</span> <span class="o">=</span> <span class="n">say_hi</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Make a call to the SayHi deployment and pass the result ref to</span>
        <span class="c1"># a downstream Ray task.</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">DeploymentResponse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_say_hi</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span>
        <span class="n">response_obj_ref</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span> <span class="o">=</span> <span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">_to_object_ref</span><span class="p">()</span>
        <span class="n">final_obj_ref</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">ObjectRef</span> <span class="o">=</span> <span class="n">say_hi_task</span><span class="o">.</span><span class="n">remote</span><span class="p">(</span><span class="n">response_obj_ref</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">final_obj_ref</span>


<span class="n">app</span> <span class="o">=</span> <span class="n">Ingress</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">SayHi</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>
<span class="n">handle</span><span class="p">:</span> <span class="n">DeploymentHandle</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">app</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">use_new_handle_api</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">handle</span><span class="o">.</span><span class="n">remote</span><span class="p">()</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Ray task got message: &#39;Hi from Serve deployment&#39;&quot;</span>
</pre></div>
</div>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="develop-and-deploy.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">开发并部署 ML 应用</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="multi-app.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">部署多应用</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><!-- Override the footer area for the sphinx-book-theme to include the CSAT widget -->
<div id="csat">
  <div id="csat-feedback-received" class="csat-hidden">
    <span>谢谢你的反馈！</span>
  </div>
  <div id="csat-inputs">
    <span>是否能帮助到你？</span>
    <div id="csat-yes" class="csat-button">
      <svg id="csat-yes-icon" class="csat-hidden csat-icon" width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 10.172L16.1922 0.979004L17.6072 2.393L7.00023 13L0.63623 6.636L2.05023 5.222L7.00023 10.172Z" fill="black"/>
      </svg>
      <span>是<span>
    </div>
    <div id="csat-no" class="csat-button">
      <svg id="csat-no-icon" class="csat-hidden csat-icon" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 5.58599L11.9502 0.635986L13.3642 2.04999L8.41423 6.99999L13.3642 11.95L11.9502 13.364L7.00023 8.41399L2.05023 13.364L0.63623 11.95L5.58623 6.99999L0.63623 2.04999L2.05023 0.635986L7.00023 5.58599Z" fill="black"/>
      </svg>
      <span>否<span>
    </div>
  </div>
  <div id="csat-textarea-group" class="csat-hidden">
    <span id="csat-feedback-label">反馈</span>
    <textarea id="csat-textarea"></textarea>
    <div id="csat-submit">提交</div>
  </div>
</div><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2024, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>