
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>监控你的应用 &#8212; Ray 2.7.2</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/versionwarning.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../_static/js/docsearch.js"></script>
    <script defer="defer" src="../_static/js/csat.js"></script>
    <script defer="defer" src="../_static/js/termynal.js"></script>
    <script defer="defer" src="../_static/js/custom.js"></script>
    <script defer="defer" src="../_static/js/top-navigation.js"></script>
    <script src="../_static/js/tags.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/serve/monitoring.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="资源分配" href="resource-allocation.html" />
    <link rel="prev" title="Best practices in production" href="production-guide/best-practices.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
  data-modal-disclaimer = "Results are automated and may be incorrect or contain inappropriate information. Do not include any personal data or confidential information."
  data-modal-title = "Ray Docs AI - Ask a Question"
  data-button-position-bottom = "60px"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 2.7.2</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    欢迎来到 Ray ！
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/index.html">
   概述「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/getting-started.html">
   入门「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/installation.html">
   安装「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/use-cases.html">
   用例「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/examples.html">
   示例库「1%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/ray-libraries.html">
   生态「3%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-core/walkthrough.html">
   Ray 核心「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/data.html">
   Ray 数据「85%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../train/train.html">
   Ray 训练「95%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tune/index.html">
   Ray 调参「0%」
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Ray Serve「1%」
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="getting_started.html">
     入门
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="key-concepts.html">
     关键概念
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="develop-and-deploy.html">
     开发并部署 ML 应用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="model_composition.html">
     部署模型组合
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="multi-app.html">
     部署多应用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="model-multiplexing.html">
     模型复用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="configure-serve-deployment.html">
     配置 Ray Serve 发布
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="http-guide.html">
     设置 FastAPI 及 HTTP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="production-guide/index.html">
     生产指引
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     监控你的应用
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="resource-allocation.html">
     资源分配
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="autoscaling-guide.html">
     Ray Serve 自动扩缩
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="advanced-guides/index.html">
     高级指南
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="architecture.html">
     架构
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="tutorials/index.html">
     示例
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="api/index.html">
     Ray Serve API
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../rllib/index.html">
   Ray RLlib「0%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-more-libs/index.html">
   更多类库「40%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../cluster/getting-started.html">
   Ray 集群「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-observability/index.html">
   监控调试「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-references/api.html">
   参考「20%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-contribute/index.html">
   开发者指引「30%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-security/index.html">
   安全「100%」
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Fserve/monitoring.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/serve/monitoring.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/serve/monitoring.md.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ray-dashboard">
   Ray Dashboard
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inspect-applications-with-the-serve-cli">
   Inspect applications with the Serve CLI
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-application-details-in-python">
   Get application details in Python
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ray-logging">
   Ray logging
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#json-logging-format">
     JSON logging format
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-request-id">
     Set Request ID
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#filtering-logs-with-loki">
     Filtering logs with Loki
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#built-in-ray-serve-metrics">
   Built-in Ray Serve metrics
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#profiling-memory">
   Profiling memory
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exporting-metrics-into-arize">
   Exporting metrics into Arize
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>监控你的应用</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ray-dashboard">
   Ray Dashboard
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inspect-applications-with-the-serve-cli">
   Inspect applications with the Serve CLI
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#get-application-details-in-python">
   Get application details in Python
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#ray-logging">
   Ray logging
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#json-logging-format">
     JSON logging format
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#set-request-id">
     Set Request ID
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#filtering-logs-with-loki">
     Filtering logs with Loki
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#built-in-ray-serve-metrics">
   Built-in Ray Serve metrics
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#profiling-memory">
   Profiling memory
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exporting-metrics-into-arize">
   Exporting metrics into Arize
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="serve-monitoring">
<span id="id1"></span><h1>监控你的应用<a class="headerlink" href="#serve-monitoring" title="Permalink to this headline">#</a></h1>
<p>This section helps you debug and monitor your Serve applications by:</p>
<ul class="simple">
<li><p>viewing the Ray dashboard</p></li>
<li><p>viewing the <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">status</span></code> output</p></li>
<li><p>using Ray logging and Loki</p></li>
<li><p>inspecting built-in Ray Serve metrics</p></li>
<li><p>exporting metrics into Arize platform</p></li>
</ul>
<section id="ray-dashboard">
<h2>Ray Dashboard<a class="headerlink" href="#ray-dashboard" title="Permalink to this headline">#</a></h2>
<p>You can use the Ray dashboard to get a high-level overview of your Ray cluster and Ray Serve application’s states.
This includes details such as:</p>
<ul class="simple">
<li><p>the number of deployment replicas currently running</p></li>
<li><p>logs for your Serve controller, deployment replicas, and proxies</p></li>
<li><p>the Ray nodes (i.e. machines) running in your Ray cluster.</p></li>
</ul>
<p>You can access the Ray dashboard at port 8265 at your cluster’s URI.
For example, if you’re running Ray Serve locally, you can access the dashboard by going to <code class="docutils literal notranslate"><span class="pre">http://localhost:8265</span></code> in your browser.</p>
<p>View important information about your application by accessing the <a class="reference internal" href="../ray-observability/getting-started.html#dash-serve-view"><span class="std std-ref">Serve page</span></a>.</p>
<img alt="https://raw.githubusercontent.com/ray-project/Images/master/docs/new-dashboard-v2/serve.png" class="align-center" src="https://raw.githubusercontent.com/ray-project/Images/master/docs/new-dashboard-v2/serve.png" />
<p>This example has a single-node cluster running a deployment named <code class="docutils literal notranslate"><span class="pre">Translator</span></code>. This deployment has 2 replicas.</p>
<p>View details of these replicas by browsing the Serve page. On the details page of each replica. From there, you can view metadata about the replica and the logs of the replicas, including the <code class="docutils literal notranslate"><span class="pre">logging</span></code> and <code class="docutils literal notranslate"><span class="pre">print</span></code> statements generated by the replica process.</p>
<p>Another useful view is the <a class="reference internal" href="../ray-observability/getting-started.html#dash-actors-view"><span class="std std-ref">Actors view</span></a>. This example Serve application uses four <a class="reference internal" href="../ray-core/actors.html#actor-guide"><span class="std std-ref">Ray actors</span></a>:</p>
<ul class="simple">
<li><p>1 Serve controller</p></li>
<li><p>1 HTTP proxy</p></li>
<li><p>2 <code class="docutils literal notranslate"><span class="pre">Translator</span></code> deployment replicas</p></li>
</ul>
<p>You can see the details of these entities throughout the Serve page and in the actor’s page.
This page includes additional useful information like each actor’s process ID (PID) and a link to each actor’s logs. You can also see whether any particular actor is alive or dead to help you debug potential cluster failures.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>To learn more about the Serve controller actor, the HTTP proxy actor(s), the deployment replicas, and how they all work together, check out the <a class="reference internal" href="architecture.html#serve-architecture"><span class="std std-ref">Serve Architecture</span></a> documentation.</p>
</div>
<p>For a detailed overview of the Ray dashboard, see the <a class="reference internal" href="../ray-observability/getting-started.html#observability-getting-started"><span class="std std-ref">dashboard documentation</span></a>.</p>
</section>
<section id="inspect-applications-with-the-serve-cli">
<span id="serve-in-production-inspecting"></span><h2>Inspect applications with the Serve CLI<a class="headerlink" href="#inspect-applications-with-the-serve-cli" title="Permalink to this headline">#</a></h2>
<p>Two Serve CLI commands help you inspect a Serve application in production: <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">config</span></code> and <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">status</span></code>.
If you have a remote cluster, <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">config</span></code> and <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">status</span></code> also has an <code class="docutils literal notranslate"><span class="pre">--address/-a</span></code> argument to access the cluster. See <a class="reference internal" href="advanced-guides/deploy-vm.html#serve-in-production-remote-cluster"><span class="std std-ref">VM deployment</span></a> for more information on this argument.</p>
<p><code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">config</span></code> gets the latest config file that the Ray Cluster received. This config file represents the Serve application’s goal state. The Ray Cluster constantly strives to reach and maintain this state by deploying deployments, and recovering failed replicas, and performing other relevant actions.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">serve_config.yaml</span></code> example from <a class="reference internal" href="production-guide/config.html#production-config-yaml"><span class="std std-ref">the production guide</span></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ray start --head
<span class="gp">$ </span>serve deploy serve_config.yaml
<span class="go">...</span>

<span class="gp">$ </span>serve config
<span class="go">name: default</span>
<span class="go">route_prefix: /</span>
<span class="go">import_path: text_ml:app</span>
<span class="go">runtime_env:</span>
<span class="go">  pip:</span>
<span class="go">    - torch</span>
<span class="go">    - transformers</span>
<span class="go">deployments:</span>
<span class="go">- name: Translator</span>
<span class="go">  num_replicas: 1</span>
<span class="go">  user_config:</span>
<span class="go">    language: french</span>
<span class="go">- name: Summarizer</span>
<span class="go">  num_replicas: 1</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">status</span></code> gets your Serve application’s current status. This command reports the status of the <code class="docutils literal notranslate"><span class="pre">proxies</span></code> and the <code class="docutils literal notranslate"><span class="pre">applications</span></code> running on the Ray cluster.</p>
<p><code class="docutils literal notranslate"><span class="pre">proxies</span></code> lists each proxy’s status. Each proxy is identified by the node ID of the node that it runs on. A proxy has three possible statuses:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">STARTING</span></code>: The proxy is starting up and is not yet ready to serve requests.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">HEALTHY</span></code>: The proxy is capable of serving requests. It is behaving normally.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UNHEALTHY</span></code>: The proxy has failed its health-checks. It will be killed, and a new proxy will be started on that node.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DRAINING</span></code>: The proxy is healthy but is closed to new requests. It may contain pending requests that are still being processed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">DRAINED</span></code>: The proxy is closed to new requests. There are no pending requests.</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">applications</span></code> contains a list of applications, their overall statuses, and their deployments’ statuses. Each entry in <code class="docutils literal notranslate"><span class="pre">applications</span></code> maps an application’s name to four fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">status</span></code>: A Serve application has four possible overall statuses:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;NOT_STARTED&quot;</span></code>: No application has been deployed on this cluster.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;DEPLOYING&quot;</span></code>: The application is currently carrying out a <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">deploy</span></code> request. It is deploying new deployments or updating existing ones.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;RUNNING&quot;</span></code>: The application is at steady-state. It has finished executing any previous <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">deploy</span></code> requests, and is attempting to maintain the goal state set by the latest <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">deploy</span></code> request.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;DEPLOY_FAILED&quot;</span></code>: The latest <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">deploy</span></code> request has failed.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">message</span></code>: Provides context on the current status.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deployment_timestamp</span></code>: A UNIX timestamp of when Serve received the last <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">deploy</span></code> request. The timestamp is calculated using the <code class="docutils literal notranslate"><span class="pre">ServeController</span></code>’s local clock.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">deployments</span></code>: A list of entries representing each deployment’s status. Each entry maps a deployment’s name to three fields:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">status</span></code>: A Serve deployment has three possible statuses:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;UPDATING&quot;</span></code>: The deployment is updating to meet the goal state set by a previous <code class="docutils literal notranslate"><span class="pre">deploy</span></code> request.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;HEALTHY&quot;</span></code>: The deployment achieved the latest requests goal state.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&quot;UNHEALTHY&quot;</span></code>: The deployment has either failed to update, or has updated and has become unhealthy afterwards. This condition may be due to an error in the deployment’s constructor, a crashed replica, or a general system or machine error.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">replica_states</span></code>: A list of the replicas’ states and the number of replicas in that state. Each replica has five possible states:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">STARTING</span></code>: The replica is starting and not yet ready to serve requests.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">UPDATING</span></code>: The replica is undergoing a <code class="docutils literal notranslate"><span class="pre">reconfigure</span></code> update.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RECOVERING</span></code>: The replica is recovering its state.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RUNNING</span></code>: The replica is running normally and able to serve requests.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">STOPPING</span></code>: The replica is being stopped.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">message</span></code>: Provides context on the current status.</p></li>
</ul>
</li>
</ul>
<p>Use the <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">status</span></code> command to inspect your deployments after they are deployed and throughout their lifetime.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">serve_config.yaml</span></code> example from <a class="reference internal" href="production-guide/config.html#production-config-yaml"><span class="std std-ref">an earlier section</span></a>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ray start --head
<span class="gp">$ </span>serve deploy serve_config.yaml
<span class="go">...</span>

<span class="gp">$ </span>serve status
<span class="go">proxies:</span>
<span class="go">  cef533a072b0f03bf92a6b98cb4eb9153b7b7c7b7f15954feb2f38ec: HEALTHY</span>
<span class="go">applications:</span>
<span class="go">  default:</span>
<span class="go">    status: RUNNING</span>
<span class="go">    message: &#39;&#39;</span>
<span class="go">    last_deployed_time_s: 1694041157.2211847</span>
<span class="go">    deployments:</span>
<span class="go">      Translator:</span>
<span class="go">        status: HEALTHY</span>
<span class="go">        replica_states:</span>
<span class="go">          RUNNING: 1</span>
<span class="go">        message: &#39;&#39;</span>
<span class="go">      Summarizer:</span>
<span class="go">        status: HEALTHY</span>
<span class="go">        replica_states:</span>
<span class="go">          RUNNING: 1</span>
<span class="go">        message: &#39;&#39;</span>
</pre></div>
</div>
<p>For Kubernetes deployments with KubeRay, tighter integrations of <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">status</span></code> with Kubernetes are available. See <a class="reference internal" href="production-guide/kubernetes.html#serve-getting-status-kubernetes"><span class="std std-ref">Getting the status of Serve applications in Kubernetes</span></a>.</p>
</section>
<section id="get-application-details-in-python">
<h2>Get application details in Python<a class="headerlink" href="#get-application-details-in-python" title="Permalink to this headline">#</a></h2>
<p>Call the <code class="docutils literal notranslate"><span class="pre">serve.status()</span></code> API to get Serve application details in Python. <code class="docutils literal notranslate"><span class="pre">serve.status()</span></code> returns the same information as the <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">status</span></code> CLI command inside a <code class="docutils literal notranslate"><span class="pre">dataclass</span></code>. Use this method inside a deployment or a Ray driver script to obtain live information about the Serve applications on the Ray cluster. For example, this <code class="docutils literal notranslate"><span class="pre">monitoring_app</span></code> reports all the <code class="docutils literal notranslate"><span class="pre">RUNNING</span></code> Serve applications on the cluster:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve.schema</span> <span class="kn">import</span> <span class="n">ServeStatus</span><span class="p">,</span> <span class="n">ApplicationStatusOverview</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">def</span> <span class="nf">get_healthy_apps</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">serve_status</span><span class="p">:</span> <span class="n">ServeStatus</span> <span class="o">=</span> <span class="n">serve</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
    <span class="n">app_statuses</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ApplicationStatusOverview</span><span class="p">]</span> <span class="o">=</span> <span class="n">serve_status</span><span class="o">.</span><span class="n">applications</span>

    <span class="n">running_apps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">app_status</span> <span class="ow">in</span> <span class="n">app_statuses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">app_status</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;RUNNING&quot;</span><span class="p">:</span>
            <span class="n">running_apps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">running_apps</span>


<span class="n">monitoring_app</span> <span class="o">=</span> <span class="n">get_healthy_apps</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="ray-logging">
<span id="serve-logging"></span><h2>Ray logging<a class="headerlink" href="#ray-logging" title="Permalink to this headline">#</a></h2>
<p>To understand system-level behavior and to surface application-level details during runtime, you can leverage Ray logging.</p>
<p>Ray Serve uses Python’s standard <code class="docutils literal notranslate"><span class="pre">logging</span></code> module with a logger named <code class="docutils literal notranslate"><span class="pre">&quot;ray.serve&quot;</span></code>.
By default, logs are emitted from actors both to <code class="docutils literal notranslate"><span class="pre">stderr</span></code> and on disk on each node at <code class="docutils literal notranslate"><span class="pre">/tmp/ray/session_latest/logs/serve/</span></code>.
This includes both system-level logs from the Serve controller and proxy as well as access logs and custom user logs produced from within deployment replicas.</p>
<p>In development, logs are streamed to the driver Ray program (the Python script that calls <code class="docutils literal notranslate"><span class="pre">serve.run()</span></code> or the <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code> CLI command), so it’s convenient to keep the driver running while debugging.</p>
<p>For example, let’s run a basic Serve application and view the logs that it emits.</p>
<p>First, let’s create a simple deployment that logs a custom log message when it’s queried:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># File name: monitoring.py</span>

<span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">starlette.requests</span> <span class="kn">import</span> <span class="n">Request</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ray.serve&quot;</span><span class="p">)</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">SayHello</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Hello world!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;hi&quot;</span>


<span class="n">say_hello</span> <span class="o">=</span> <span class="n">SayHello</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
</pre></div>
</div>
<p>Run this deployment using the <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code> CLI command:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>serve run monitoring:say_hello

<span class="go">2023-04-10 15:57:32,100	INFO scripts.py:380 -- Deploying from import path: &quot;monitoring:say_hello&quot;.</span>
<span class="go">[2023-04-10 15:57:33]  INFO ray._private.worker::Started a local Ray instance. View the dashboard at http://127.0.0.1:8265 </span>
<span class="gp gp-VirtualEnv">(ServeController pid=63503)</span> <span class="go">INFO 2023-04-10 15:57:35,822 controller 63503 deployment_state.py:1168 - Deploying new version of deployment SayHello.</span>
<span class="gp gp-VirtualEnv">(HTTPProxyActor pid=63513)</span> <span class="go">INFO:     Started server process [63513]</span>
<span class="gp gp-VirtualEnv">(ServeController pid=63503)</span> <span class="go">INFO 2023-04-10 15:57:35,882 controller 63503 deployment_state.py:1386 - Adding 1 replica to deployment SayHello.</span>
<span class="go">2023-04-10 15:57:36,840	SUCC scripts.py:398 -- Deployed Serve app successfully.</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code> prints a few log messages immediately. Note that a few of these messages start with identifiers such as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">ServeController</span> <span class="n">pid</span><span class="o">=</span><span class="mi">63881</span><span class="p">)</span>
</pre></div>
</div>
<p>These messages are logs from Ray Serve <a class="reference internal" href="../ray-core/actors.html#actor-guide"><span class="std std-ref">actors</span></a>. They describe which actor (Serve controller, proxy, or deployment replica) created the log and what its process ID is (which is useful when distinguishing between different deployment replicas or proxies). The rest of these log messages are the actual log statements generated by the actor.</p>
<p>While <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code> is running, we can query the deployment in a separate terminal window:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span>
</pre></div>
</div>
<p>This causes the HTTP proxy and deployment replica to print log statements to the terminal running <code class="docutils literal notranslate"><span class="pre">serve</span> <span class="pre">run</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp gp-VirtualEnv">(ServeReplica:SayHello pid=63520)</span> <span class="go">INFO 2023-04-10 15:59:45,403 SayHello SayHello#kTBlTj HzIYOzaEgN / monitoring.py:16 - Hello world!</span>
<span class="gp gp-VirtualEnv">(ServeReplica:SayHello pid=63520)</span> <span class="go">INFO 2023-04-10 15:59:45,403 SayHello SayHello#kTBlTj HzIYOzaEgN / replica.py:527 - __CALL__ OK 0.5ms</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Log messages include the logging level, timestamp, deployment name, replica tag, request ID, route, file name, and line number.</p>
</div>
<p>Find a copy of these logs at <code class="docutils literal notranslate"><span class="pre">/tmp/ray/session_latest/logs/serve/</span></code>. You can parse these stored logs with a logging stack such as ELK or <a class="reference internal" href="#serve-logging-loki"><span class="std std-ref">Loki</span></a> to be able to search by deployment or replica.</p>
<p>Serve supports <a class="reference internal" href="../ray-observability/user-guides/configure-logging.html#log-rotation"><span class="std std-ref">Log Rotation</span></a> of these logs through setting the environment variables <code class="docutils literal notranslate"><span class="pre">RAY_ROTATION_MAX_BYTES</span></code> and <code class="docutils literal notranslate"><span class="pre">RAY_ROTATION_BACKUP_COUNT</span></code>.</p>
<p>To silence the replica-level logs or otherwise configure logging, configure the <code class="docutils literal notranslate"><span class="pre">&quot;ray.serve&quot;</span></code> logger <strong>inside the deployment constructor</strong>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ray.serve&quot;</span><span class="p">)</span>

<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Silenced</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</pre></div>
</div>
<p>This controls which logs are written to STDOUT or files on disk.
In addition to the standard Python logger, Serve supports custom logging. Custom logging lets you control what messages are written to STDOUT/STDERR, files on disk, or both.</p>
<p>For a detailed overview of logging in Ray, see <a class="reference internal" href="../ray-observability/user-guides/configure-logging.html#configure-logging"><span class="std std-ref">Ray Logging</span></a>.</p>
<section id="json-logging-format">
<h3>JSON logging format<a class="headerlink" href="#json-logging-format" title="Permalink to this headline">#</a></h3>
<p>You can enable JSON-formatted logging in the Serve log file by setting the environment variable <code class="docutils literal notranslate"><span class="pre">RAY_SERVE_ENABLE_JSON_LOGGING=1</span></code>. After setting this environment variable, the logs have the following format:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="nt">&quot;levelname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;asctime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-07-17 10:34:25,425&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;deployment&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;replica&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api#bFDOnw&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;request_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGIVJJJPRb&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;route&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/app1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;application&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;replica.py:664 - Started executing request OGIVJJJPRb&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;levelname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;asctime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-07-17 10:34:25,425&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;deployment&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;replica&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api#bFDOnw&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;request_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;OGIVJJJPRb&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;route&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/app1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;application&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;replica.py:691 - __CALL__ OK 0.1ms&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;levelname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;asctime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-07-17 10:34:25,433&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;deployment&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;replica&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api#bFDOnw&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;request_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BULmoMIYRD&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;route&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/app1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;application&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;replica.py:664 - Started executing request BULmoMIYRD&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;levelname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;asctime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-07-17 10:34:25,433&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;deployment&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;replica&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api#bFDOnw&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;request_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BULmoMIYRD&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;route&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/app1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;application&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;replica.py:691 - __CALL__ OK 0.2ms&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;levelname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;asctime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-07-17 10:34:25,440&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;deployment&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;replica&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api#bFDOnw&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;request_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jLTczxOqme&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;route&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/app1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;application&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;replica.py:664 - Started executing request jLTczxOqme&quot;</span><span class="p">}</span><span class="w"></span>
<span class="p">{</span><span class="nt">&quot;levelname&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;asctime&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2023-07-17 10:34:25,441&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;deployment&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;replica&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default_api#bFDOnw&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;request_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;jLTczxOqme&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;route&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/app1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;application&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;default&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;replica.py:691 - __CALL__ OK 0.1ms&quot;</span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="set-request-id">
<h3>Set Request ID<a class="headerlink" href="#set-request-id" title="Permalink to this headline">#</a></h3>
<p>You can set a custom request ID for each HTTP request by including <code class="docutils literal notranslate"><span class="pre">X-Request-ID</span></code> in the request header and retrieve request ID from response. For example</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>

<span class="kn">import</span> <span class="nn">requests</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Model</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span>


<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">Model</span><span class="o">.</span><span class="n">bind</span><span class="p">())</span>
<span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;X-Request-ID&quot;</span><span class="p">:</span> <span class="s2">&quot;123-234&quot;</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Request-ID&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>The custom request ID <code class="docutils literal notranslate"><span class="pre">123-234</span></code> can be seen in the access logs that are printed to the HTTP Proxy log files and deployment log files.</p>
<p>HTTP proxy log file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">INFO</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">20</span> <span class="mi">13</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">54</span><span class="p">,</span><span class="mi">221</span> <span class="n">http_proxy</span> <span class="mf">127.0.0.1</span> <span class="mi">123</span><span class="o">-</span><span class="mi">234</span> <span class="o">/</span> <span class="n">default</span> <span class="n">http_proxy</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">538</span> <span class="o">-</span> <span class="n">GET</span> <span class="mi">200</span> <span class="mf">8.9</span><span class="n">ms</span>
</pre></div>
</div>
<p>Deployment log file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">ServeReplica</span><span class="p">:</span><span class="n">default_Model</span> <span class="n">pid</span><span class="o">=</span><span class="mi">84006</span><span class="p">)</span> <span class="n">INFO</span> <span class="mi">2023</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">20</span> <span class="mi">13</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">54</span><span class="p">,</span><span class="mi">218</span> <span class="n">default_Model</span> <span class="n">default_Model</span><span class="c1">#yptKoo 123-234 / default replica.py:691 - __CALL__ OK 0.2ms</span>
</pre></div>
</div>
</section>
<section id="filtering-logs-with-loki">
<span id="serve-logging-loki"></span><h3>Filtering logs with Loki<a class="headerlink" href="#filtering-logs-with-loki" title="Permalink to this headline">#</a></h3>
<p>You can explore and filter your logs using <a class="reference external" href="https://grafana.com/oss/loki/">Loki</a>.
Setup and configuration are straightforward on Kubernetes, but as a tutorial, let’s set up Loki manually.</p>
<p>For this walkthrough, you need both Loki and Promtail, which are both supported by <a class="reference external" href="https://grafana.com">Grafana Labs</a>. Follow the installation instructions at Grafana’s website to get executables for <a class="reference external" href="https://grafana.com/docs/loki/latest/installation/">Loki</a> and <a class="reference external" href="https://grafana.com/docs/loki/latest/clients/promtail/">Promtail</a>.
For convenience, save the Loki and Promtail executables in the same directory, and then navigate to this directory in your terminal.</p>
<p>Now let’s get your logs into Loki using Promtail.</p>
<p>Save the following file as <code class="docutils literal notranslate"><span class="pre">promtail-local-config.yaml</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">server</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">http_listen_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">9080</span><span class="w"></span>
<span class="w">  </span><span class="nt">grpc_listen_port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w"></span>

<span class="nt">positions</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">filename</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/positions.yaml</span><span class="w"></span>

<span class="nt">clients</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http://localhost:3100/loki/api/v1/push</span><span class="w"></span>

<span class="nt">scrape_configs</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">job_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ray</span><span class="w"></span>
<span class="w">    </span><span class="nt">static_configs</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">labels</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">job</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ray</span><span class="w"></span>
<span class="w">        </span><span class="nt">__path__</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/ray/session_latest/logs/serve/*.*</span><span class="w"></span>
</pre></div>
</div>
<p>The relevant part for Ray Serve is the <code class="docutils literal notranslate"><span class="pre">static_configs</span></code> field, where we have indicated the location of our log files with <code class="docutils literal notranslate"><span class="pre">__path__</span></code>.
The expression <code class="docutils literal notranslate"><span class="pre">*.*</span></code> will match all files, but it won’t match directories since they cause an error with Promtail.</p>
<p>We’ll run Loki locally.  Grab the default config file for Loki with the following command in your terminal:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>wget https://raw.githubusercontent.com/grafana/loki/v2.1.0/cmd/loki/loki-local-config.yaml
</pre></div>
</div>
<p>Now start Loki:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./loki-darwin-amd64 -config.file<span class="o">=</span>loki-local-config.yaml
</pre></div>
</div>
<p>Here you may need to replace <code class="docutils literal notranslate"><span class="pre">./loki-darwin-amd64</span></code> with the path to your Loki executable file, which may have a different name depending on your operating system.</p>
<p>Start Promtail and pass in the path to the config file we saved earlier:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>./promtail-darwin-amd64 -config.file<span class="o">=</span>promtail-local-config.yaml
</pre></div>
</div>
<p>Once again, you may need to replace <code class="docutils literal notranslate"><span class="pre">./promtail-darwin-amd64</span></code> with your Promtail executable.</p>
<p>Run the following Python script to deploy a basic Serve deployment with a Serve deployment logger and to make some requests:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;ray.serve&quot;</span><span class="p">)</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">Counter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;count: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">}</span>


<span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://127.0.0.1:8000/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now <a class="reference external" href="https://grafana.com/docs/grafana/latest/installation/">install and run Grafana</a> and navigate to <code class="docutils literal notranslate"><span class="pre">http://localhost:3000</span></code>, where you can log in with default credentials:</p>
<ul class="simple">
<li><p>Username: admin</p></li>
<li><p>Password: admin</p></li>
</ul>
<p>On the welcome page, click “Add your first data source” and click “Loki” to add Loki as a data source.</p>
<p>Now click “Explore” in the left-side panel.  You are ready to run some queries!</p>
<p>To filter all these Ray logs for the ones relevant to our deployment, use the following <a class="reference external" href="https://grafana.com/docs/loki/latest/logql/">LogQL</a> query:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="o">{</span><span class="nv">job</span><span class="o">=</span><span class="s2">&quot;ray&quot;</span><span class="o">}</span> <span class="p">|</span><span class="o">=</span> <span class="s2">&quot;Counter&quot;</span>
</pre></div>
</div>
<p>You should see something similar to the following:</p>
<img alt="https://raw.githubusercontent.com/ray-project/Images/master/docs/serve/loki-serve.png" class="align-center" src="https://raw.githubusercontent.com/ray-project/Images/master/docs/serve/loki-serve.png" />
<p>You can use Loki to filter your Ray Serve logs and gather insights quicker.</p>
</section>
</section>
<section id="built-in-ray-serve-metrics">
<span id="serve-production-monitoring-metrics"></span><h2>Built-in Ray Serve metrics<a class="headerlink" href="#built-in-ray-serve-metrics" title="Permalink to this headline">#</a></h2>
<p>You can leverage built-in Ray Serve metrics to get a closer look at your application’s performance.</p>
<p>Ray Serve exposes important system metrics like the number of successful and
failed requests through the <a class="reference internal" href="../ray-observability/getting-started.html#dash-metrics-view"><span class="std std-ref">Ray metrics monitoring infrastructure</span></a>. By default, the metrics are exposed in Prometheus format on each node.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Different metrics are collected when Deployments are called
via Python <code class="docutils literal notranslate"><span class="pre">DeploymentHandle</span></code> and when they are called via HTTP.</p>
<p>See the list of metrics below marked for each.</p>
</div>
<p>The following metrics are exposed by Ray Serve:</p>
<table class="table">
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Fields</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_deployment_request_counter</span></code> [**]</p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>route</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of queries that have been processed in this replica.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_deployment_error_counter</span></code> [**]</p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>route</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of exceptions that have occurred in the deployment.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_deployment_replica_starts</span></code> [**]</p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of times this replica has been restarted due to failure.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_deployment_replica_healthy</span></code></p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>Whether this deployment replica is healthy. 1 means healthy, 0 unhealthy.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_deployment_processing_latency_ms</span></code> [**]</p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>route</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The latency for queries to be processed.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_replica_processing_queries</span></code> [**]</p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The current number of queries being processed.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_replica_pending_queries</span></code> [**]</p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The current number of pending queries.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_num_http_requests</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>route</p></li>
<li><p>method</p></li>
<li><p>application</p></li>
<li><p>status_code</p></li>
</ul>
</td>
<td><p>The number of HTTP requests processed.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_num_grpc_requests</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>route</p></li>
<li><p>method</p></li>
<li><p>application</p></li>
<li><p>status_code</p></li>
</ul>
</td>
<td><p>The number of gRPC requests processed.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_num_http_error_requests</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>route</p></li>
<li><p>error_code</p></li>
<li><p>method</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of non-200 HTTP responses.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_num_grpc_error_requests</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>route</p></li>
<li><p>error_code</p></li>
<li><p>method</p></li>
</ul>
</td>
<td><p>The number of non-OK gRPC responses.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_num_ongoing_http_requests</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>node_id</p></li>
<li><p>node_ip_address</p></li>
</ul>
</td>
<td><p>The number of ongoing requests in the HTTP Proxy.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_num_ongoing_grpc_requests</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>node_id</p></li>
<li><p>node_ip_address</p></li>
</ul>
</td>
<td><p>The number of ongoing requests in the gRPC Proxy.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_num_router_requests</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>route</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of requests processed by the router.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_handle_request_counter</span></code> [**]</p></td>
<td><ul class="simple">
<li><p>handle</p></li>
<li><p>deployment</p></li>
<li><p>route</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of requests processed by this DeploymentHandle.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_deployment_queued_queries</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>route</p></li>
</ul>
</td>
<td><p>The number of queries for this deployment waiting to be assigned to a replica.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_num_deployment_http_error_requests</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>error_code</p></li>
<li><p>method</p></li>
<li><p>route</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of non-200 HTTP responses returned by each deployment.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_num_deployment_grpc_error_requests</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>error_code</p></li>
<li><p>method</p></li>
<li><p>route</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of non-OK gRPC responses returned by each deployment.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_http_request_latency_ms</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>method</p></li>
<li><p>route</p></li>
<li><p>application</p></li>
<li><p>status_code</p></li>
</ul>
</td>
<td><p>The end-to-end latency of HTTP requests (measured from the Serve HTTP proxy).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_grpc_request_latency_ms</span></code> [*]</p></td>
<td><ul class="simple">
<li><p>method</p></li>
<li><p>route</p></li>
<li><p>application</p></li>
<li><p>status_code</p></li>
</ul>
</td>
<td><p>The end-to-end latency of gRPC requests (measured from the Serve gRPC proxy).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_multiplexed_model_load_latency_ms</span></code></p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The time it takes to load a model.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_multiplexed_model_unload_latency_ms</span></code></p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The time it takes to unload a model.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_num_multiplexed_models</span></code></p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of models loaded on the current replica.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_multiplexed_models_unload_counter</span></code></p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of times models unloaded on the current replica.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_multiplexed_models_load_counter</span></code></p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of times models loaded on the current replica.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_registered_multiplexed_model_id</span></code></p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>application</p></li>
<li><p>model_id</p></li>
</ul>
</td>
<td><p>The mutlplexed model ID registered on the current replica.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ray_serve_multiplexed_get_model_requests_counter</span></code></p></td>
<td><ul class="simple">
<li><p>deployment</p></li>
<li><p>replica</p></li>
<li><p>application</p></li>
</ul>
</td>
<td><p>The number of calls to get a multiplexed model.</p></td>
</tr>
</tbody>
</table>
<p>[*] - only available when using proxy calls
[**] - only available when using Python <code class="docutils literal notranslate"><span class="pre">DeploymentHandle</span></code> calls</p>
<p>To see this in action, first run the following command to start Ray and set up the metrics export port:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ray start --head --metrics-export-port<span class="o">=</span><span class="m">8080</span>
</pre></div>
</div>
<p>Then run the following script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">requests</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">def</span> <span class="nf">sleeper</span><span class="p">():</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="n">s</span> <span class="o">=</span> <span class="n">sleeper</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>

<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000/&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The requests loop until canceled with <code class="docutils literal notranslate"><span class="pre">Control-C</span></code>.</p>
<p>While this script is running, go to <code class="docutils literal notranslate"><span class="pre">localhost:8080</span></code> in your web browser.
In the output there, you can search for <code class="docutils literal notranslate"><span class="pre">serve_</span></code> to locate the metrics above.
The metrics are updated once every ten seconds, so you need to refresh the page to see new values.</p>
<p>For example, after running the script for some time and refreshing <code class="docutils literal notranslate"><span class="pre">localhost:8080</span></code> you should find metrics similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ray_serve_deployment_processing_latency_ms_count</span><span class="p">{</span><span class="o">...</span><span class="p">,</span> <span class="n">replica</span><span class="o">=</span><span class="s2">&quot;sleeper#jtzqhX&quot;</span><span class="p">}</span> <span class="mf">48.0</span>
<span class="n">ray_serve_deployment_processing_latency_ms_sum</span><span class="p">{</span><span class="o">...</span><span class="p">,</span> <span class="n">replica</span><span class="o">=</span><span class="s2">&quot;sleeper#jtzqhX&quot;</span><span class="p">}</span> <span class="mf">48160.6719493866</span>
</pre></div>
</div>
<p>which indicates that the average processing latency is just over one second, as expected.</p>
<p>You can even define a <a class="reference internal" href="../ray-observability/user-guides/add-app-metrics.html#application-level-metrics"><span class="std std-ref">custom metric</span></a> for your deployment and tag it with deployment or replica metadata.
Here’s an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">serve</span>
<span class="kn">from</span> <span class="nn">ray.serve</span> <span class="kn">import</span> <span class="n">metrics</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">requests</span>


<span class="nd">@serve</span><span class="o">.</span><span class="n">deployment</span>
<span class="k">class</span> <span class="nc">MyDeployment</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_requests</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_counter</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span>
            <span class="s2">&quot;my_counter&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;The number of odd-numbered requests to this deployment.&quot;</span><span class="p">),</span>
            <span class="n">tag_keys</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_counter</span><span class="o">.</span><span class="n">set_default_tags</span><span class="p">({</span><span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">})</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_requests</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_requests</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">my_counter</span><span class="o">.</span><span class="n">inc</span><span class="p">()</span>


<span class="n">my_deployment</span> <span class="o">=</span> <span class="n">MyDeployment</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
<span class="n">serve</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">my_deployment</span><span class="p">)</span>

<span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000/&quot;</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

</pre></div>
</div>
<p>The emitted logs include:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># HELP ray_my_counter The number of odd-numbered requests to this deployment.</span>
<span class="c1"># TYPE ray_my_counter gauge</span>
<span class="n">ray_my_counter</span><span class="p">{</span><span class="o">...</span><span class="p">,</span> <span class="n">deployment</span><span class="o">=</span><span class="s2">&quot;MyDeployment&quot;</span><span class="p">,</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;123&quot;</span><span class="p">,</span><span class="n">replica</span><span class="o">=</span><span class="s2">&quot;MyDeployment#rUVqKh&quot;</span><span class="p">}</span> <span class="mf">5.0</span>
</pre></div>
</div>
<p>See the <a class="reference internal" href="../cluster/metrics.html#collect-metrics"><span class="std std-ref">Ray Metrics documentation</span></a> for more details, including instructions for scraping these metrics using Prometheus.</p>
</section>
<section id="profiling-memory">
<h2>Profiling memory<a class="headerlink" href="#profiling-memory" title="Permalink to this headline">#</a></h2>
<p>Ray provides two useful metrics to track memory usage: <code class="docutils literal notranslate"><span class="pre">ray_component_rss_mb</span></code> (resident set size) and <code class="docutils literal notranslate"><span class="pre">ray_component_mem_shared_bytes</span></code> (shared memory). Approximate a Serve actor’s memory usage by subtracting its shared memory from its resident set size (i.e. <code class="docutils literal notranslate"><span class="pre">ray_component_rss_mb</span></code> - <code class="docutils literal notranslate"><span class="pre">ray_component_mem_shared_bytes</span></code>).</p>
<p>If you notice a memory leak on a Serve actor, use <code class="docutils literal notranslate"><span class="pre">memray</span></code> to debug (<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">memray</span></code>). Set the env var <code class="docutils literal notranslate"><span class="pre">RAY_SERVE_ENABLE_MEMORY_PROFILING=1</span></code>, and run your Serve application. All the Serve actors will run a <code class="docutils literal notranslate"><span class="pre">memray</span></code> tracker that logs their memory usage to <code class="docutils literal notranslate"><span class="pre">bin</span></code> files in the <code class="docutils literal notranslate"><span class="pre">/tmp/ray/session_latest/logs/serve/</span></code> directory. Run the <code class="docutils literal notranslate"><span class="pre">memray</span> <span class="pre">flamegraph</span> <span class="pre">[bin</span> <span class="pre">file]</span></code> command to generate a flamegraph of the memory usage. See the <a class="reference external" href="https://bloomberg.github.io/memray/overview.html">memray docs</a> for more info.</p>
</section>
<section id="exporting-metrics-into-arize">
<h2>Exporting metrics into Arize<a class="headerlink" href="#exporting-metrics-into-arize" title="Permalink to this headline">#</a></h2>
<p>Besides using Prometheus to check out Ray metrics, Ray Serve also has the flexibility to export the metrics into other observability platforms.</p>
<p><a class="reference external" href="https://docs.arize.com/arize/">Arize</a> is a machine learning observability platform which can help you to monitor real-time model performance, root cause model failures/performance degradation using explainability &amp; slice analysis and surface drift, data quality, data consistency issues etc.</p>
<p>To integrate with Arize, add Arize client code directly into your Serve deployment code. (<a class="reference external" href="https://docs.arize.com/arize/integrations/integrations/anyscale-ray-serve">Example code</a>)</p>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="production-guide/best-practices.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Best practices in production</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="resource-allocation.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">资源分配</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><!-- Override the footer area for the sphinx-book-theme to include the CSAT widget -->
<div id="csat">
  <div id="csat-feedback-received" class="csat-hidden">
    <span>谢谢你的反馈！</span>
  </div>
  <div id="csat-inputs">
    <span>是否能帮助到你？</span>
    <div id="csat-yes" class="csat-button">
      <svg id="csat-yes-icon" class="csat-hidden csat-icon" width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 10.172L16.1922 0.979004L17.6072 2.393L7.00023 13L0.63623 6.636L2.05023 5.222L7.00023 10.172Z" fill="black"/>
      </svg>
      <span>是<span>
    </div>
    <div id="csat-no" class="csat-button">
      <svg id="csat-no-icon" class="csat-hidden csat-icon" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 5.58599L11.9502 0.635986L13.3642 2.04999L8.41423 6.99999L13.3642 11.95L11.9502 13.364L7.00023 8.41399L2.05023 13.364L0.63623 11.95L5.58623 6.99999L0.63623 2.04999L2.05023 0.635986L7.00023 5.58599Z" fill="black"/>
      </svg>
      <span>否<span>
    </div>
  </div>
  <div id="csat-textarea-group" class="csat-hidden">
    <span id="csat-feedback-label">反馈</span>
    <textarea id="csat-textarea"></textarea>
    <div id="csat-submit">提交</div>
  </div>
</div><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2024, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>