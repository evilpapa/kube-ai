
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>目录 (Alpha) &#8212; Ray 2.7.2</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/versionwarning.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../_static/js/docsearch.js"></script>
    <script defer="defer" src="../_static/js/csat.js"></script>
    <script defer="defer" src="../_static/js/termynal.js"></script>
    <script defer="defer" src="../_static/js/custom.js"></script>
    <script defer="defer" src="../_static/js/top-navigation.js"></script>
    <script src="../_static/js/tags.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/rllib/rllib-catalogs.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="连接器 (Beta)" href="rllib-connector.html" />
    <link rel="prev" title="使用离线数据" href="rllib-offline.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
  data-modal-disclaimer = "Results are automated and may be incorrect or contain inappropriate information. Do not include any personal data or confidential information."
  data-modal-title = "Ray Docs AI - Ask a Question"
  data-button-position-bottom = "60px"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 2.7.2</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../index.html">
                    欢迎来到 Ray ！
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/index.html">
   概述「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/getting-started.html">
   入门「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/installation.html">
   安装「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/use-cases.html">
   用例「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/examples.html">
   示例库「1%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-overview/ray-libraries.html">
   生态「3%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-core/walkthrough.html">
   Ray 核心「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../data/data.html">
   Ray 数据「85%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../train/train.html">
   Ray 训练「95%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../tune/index.html">
   Ray 调参「0%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../serve/index.html">
   Ray Serve「1%」
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="index.html">
   Ray RLlib「0%」
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="rllib-training.html">
     RLlib 入门
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="key-concepts.html">
     关键概念
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="rllib-env.html">
     环境
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="rllib-algorithms.html">
     算法
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="user-guides.html">
     用户指南
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-advanced-api.html">
       高级 Python API
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-models.html">
       模型、预处理器和动作分布
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-saving-and-loading-algos-and-policies.html">
       保存和加载您的强化学习算法和策略
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-concepts.html">
       How To Customize Policies
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-sample-collection.html">
       样本集合和轨迹视图
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-replay-buffers.html">
       Replay Buffers
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-offline.html">
       使用离线数据
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       目录 (Alpha)
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-connector.html">
       连接器 (Beta)
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-rlmodule.html">
       RL 模块 (Alpha)
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-learner.html">
       Learner (Alpha)
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-torch2x.html">
       Using RLlib with torch 2.x compile
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-fault-tolerance.html">
       容错与弹性训练
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-dev.html">
       如何为 RLlib 做出贡献
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="rllib-cli.html">
       使用 RLlib CLI
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="rllib-examples.html">
     示例
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="package_ref/index.html">
     Ray RLlib API
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-more-libs/index.html">
   更多类库「40%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../cluster/getting-started.html">
   Ray 集群「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-observability/index.html">
   监控调试「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-references/api.html">
   参考「20%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-contribute/index.html">
   开发者指引「30%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../ray-security/index.html">
   安全「100%」
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Frllib/rllib-catalogs.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/rllib/rllib-catalogs.rst"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/rllib/rllib-catalogs.rst.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.rst</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-are-catalogs">
   What are Catalogs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#catalog-design-and-ideas">
   Catalog design and ideas
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-problems-do-catalogs-solve">
     What problems do Catalogs solve?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-do-catalogs-solve-this">
     How do Catalogs solve this?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#api-philosophy">
     API philosophy
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#catalog-and-algorithmconfig">
   Catalog and AlgorithmConfig
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#basic-usage">
   Basic usage
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#high-level-api">
     High-level API
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-models-and-distributions">
     Creating models and distributions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-models-and-distributions-for-ppo">
     Creating models and distributions for PPO
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inject-your-custom-model-or-action-distributions-into-catalogs">
   Inject your custom model or action distributions into Catalogs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#write-a-catalog-from-scratch">
   Write a Catalog from scratch
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>目录 (Alpha)</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-are-catalogs">
   What are Catalogs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#catalog-design-and-ideas">
   Catalog design and ideas
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#what-problems-do-catalogs-solve">
     What problems do Catalogs solve?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#how-do-catalogs-solve-this">
     How do Catalogs solve this?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#api-philosophy">
     API philosophy
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#catalog-and-algorithmconfig">
   Catalog and AlgorithmConfig
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#basic-usage">
   Basic usage
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#high-level-api">
     High-level API
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-models-and-distributions">
     Creating models and distributions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#creating-models-and-distributions-for-ppo">
     Creating models and distributions for PPO
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#inject-your-custom-model-or-action-distributions-into-catalogs">
   Inject your custom model or action distributions into Catalogs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#write-a-catalog-from-scratch">
   Write a Catalog from scratch
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <div class="admonition note">
<p class="admonition-title">Note</p>
<p>This doc is related to the <a class="reference external" href="rllib-rlmodule.html">RLModule API</a> and therefore experimental.</p>
</div>
<section id="alpha">
<h1>目录 (Alpha)<a class="headerlink" href="#alpha" title="Permalink to this headline">#</a></h1>
<p>Catalog is a utility abstraction that modularizes the construction of components for <a class="reference external" href="rllib-rlmodule.html">RLModules</a>.
It includes information such how input observation spaces should be encoded,
what action distributions should be used, and so on.
<code class="xref py py-class docutils literal notranslate"><span class="pre">Catalog</span></code>. For example,
<code class="xref py py-class docutils literal notranslate"><span class="pre">PPOTorchRLModule</span></code> has the
<code class="xref py py-class docutils literal notranslate"><span class="pre">PPOCatalog</span></code>.
To customize existing RLModules either change the RLModule directly by inheriting the class and changing the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">setup()</span></code> method or, alternatively, extend the Catalog class
attributed to that <code class="xref py py-obj docutils literal notranslate"><span class="pre">RLModule</span></code>. Use Catalogs only if your customizations fits the abstractions provided by Catalog.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Modifying Catalogs signifies advanced use cases so you should only consider this if modifying an RLModule or writing one does not cover your use case.
We recommend to modify Catalogs only when making deeper customizations to the decision trees that determine what <code class="xref py py-class docutils literal notranslate"><span class="pre">Model</span></code> and <code class="xref py py-class docutils literal notranslate"><span class="pre">Distribution</span></code> RLlib creates by default.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you simply want to modify a Model by changing its default values,
have a look at the model config dict:</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3 sd-fade-in-slide-down">
<summary class="sd-summary-title sd-card-header">
<code class="docutils literal notranslate"><span class="pre">MODEL_DEFAULTS</span></code><div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">This dict (or an overriding sub-set) is part of <code class="xref py py-class docutils literal notranslate"><span class="pre">AlgorithmConfig</span></code>
and therefore also part of any algorithm-specific config.
To change the behavior RLlib’s default models, override it and pass it to an AlgorithmConfig.
to change the behavior RLlib’s default models.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">MODEL_DEFAULTS</span><span class="p">:</span> <span class="n">ModelConfigDict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># Experimental flag.</span>
    <span class="c1"># If True, user specified no preprocessor to be created</span>
    <span class="c1"># (via config._disable_preprocessor_api=True). If True, observations</span>
    <span class="c1"># will arrive in model as they are returned by the env.</span>
    <span class="s2">&quot;_disable_preprocessor_api&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Experimental flag.</span>
    <span class="c1"># If True, RLlib will no longer flatten the policy-computed actions into</span>
    <span class="c1"># a single tensor (for storage in SampleCollectors/output files/etc..),</span>
    <span class="c1"># but leave (possibly nested) actions as-is. Disabling flattening affects:</span>
    <span class="c1"># - SampleCollectors: Have to store possibly nested action structs.</span>
    <span class="c1"># - Models that have the previous action(s) as part of their input.</span>
    <span class="c1"># - Algorithms reading from offline files (incl. action information).</span>
    <span class="s2">&quot;_disable_action_flattening&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>

    <span class="c1"># === Built-in options ===</span>
    <span class="c1"># FullyConnectedNetwork (tf and torch): rllib.models.tf|torch.fcnet.py</span>
    <span class="c1"># These are used if no custom model is specified and the input space is 1D.</span>
    <span class="c1"># Number of hidden layers to be used.</span>
    <span class="s2">&quot;fcnet_hiddens&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span>
    <span class="c1"># Activation function descriptor.</span>
    <span class="c1"># Supported values are: &quot;tanh&quot;, &quot;relu&quot;, &quot;swish&quot; (or &quot;silu&quot;, which is the same),</span>
    <span class="c1"># &quot;linear&quot; (or None).</span>
    <span class="s2">&quot;fcnet_activation&quot;</span><span class="p">:</span> <span class="s2">&quot;tanh&quot;</span><span class="p">,</span>

    <span class="c1"># VisionNetwork (tf and torch): rllib.models.tf|torch.visionnet.py</span>
    <span class="c1"># These are used if no custom model is specified and the input space is 2D.</span>
    <span class="c1"># Filter config: List of [out_channels, kernel, stride] for each filter.</span>
    <span class="c1"># Example:</span>
    <span class="c1"># Use None for making RLlib try to find a default filter setup given the</span>
    <span class="c1"># observation space.</span>
    <span class="s2">&quot;conv_filters&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># Activation function descriptor.</span>
    <span class="c1"># Supported values are: &quot;tanh&quot;, &quot;relu&quot;, &quot;swish&quot; (or &quot;silu&quot;, which is the same),</span>
    <span class="c1"># &quot;linear&quot; (or None).</span>
    <span class="s2">&quot;conv_activation&quot;</span><span class="p">:</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>

    <span class="c1"># Some default models support a final FC stack of n Dense layers with given</span>
    <span class="c1"># activation:</span>
    <span class="c1"># - Complex observation spaces: Image components are fed through</span>
    <span class="c1">#   VisionNets, flat Boxes are left as-is, Discrete are one-hot&#39;d, then</span>
    <span class="c1">#   everything is concated and pushed through this final FC stack.</span>
    <span class="c1"># - VisionNets (CNNs), e.g. after the CNN stack, there may be</span>
    <span class="c1">#   additional Dense layers.</span>
    <span class="c1"># - FullyConnectedNetworks will have this additional FCStack as well</span>
    <span class="c1"># (that&#39;s why it&#39;s empty by default).</span>
    <span class="s2">&quot;post_fcnet_hiddens&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="s2">&quot;post_fcnet_activation&quot;</span><span class="p">:</span> <span class="s2">&quot;relu&quot;</span><span class="p">,</span>

    <span class="c1"># For DiagGaussian action distributions, make the second half of the model</span>
    <span class="c1"># outputs floating bias variables instead of state-dependent. This only</span>
    <span class="c1"># has an effect is using the default fully connected net.</span>
    <span class="s2">&quot;free_log_std&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Whether to skip the final linear layer used to resize the hidden layer</span>
    <span class="c1"># outputs to size `num_outputs`. If True, then the last hidden layer</span>
    <span class="c1"># should already match num_outputs.</span>
    <span class="s2">&quot;no_final_linear&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Whether layers should be shared for the value function.</span>
    <span class="s2">&quot;vf_share_layers&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>

    <span class="c1"># == LSTM ==</span>
    <span class="c1"># Whether to wrap the model with an LSTM.</span>
    <span class="s2">&quot;use_lstm&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Max seq len for training the LSTM, defaults to 20.</span>
    <span class="s2">&quot;max_seq_len&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
    <span class="c1"># Size of the LSTM cell.</span>
    <span class="s2">&quot;lstm_cell_size&quot;</span><span class="p">:</span> <span class="mi">256</span><span class="p">,</span>
    <span class="c1"># Whether to feed a_{t-1} to LSTM (one-hot encoded if discrete).</span>
    <span class="s2">&quot;lstm_use_prev_action&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Whether to feed r_{t-1} to LSTM.</span>
    <span class="s2">&quot;lstm_use_prev_reward&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Whether the LSTM is time-major (TxBx..) or batch-major (BxTx..).</span>
    <span class="s2">&quot;_time_major&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>

    <span class="c1"># == Attention Nets (experimental: torch-version is untested) ==</span>
    <span class="c1"># Whether to use a GTrXL (&quot;Gru transformer XL&quot;; attention net) as the</span>
    <span class="c1"># wrapper Model around the default Model.</span>
    <span class="s2">&quot;use_attention&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># The number of transformer units within GTrXL.</span>
    <span class="c1"># A transformer unit in GTrXL consists of a) MultiHeadAttention module and</span>
    <span class="c1"># b) a position-wise MLP.</span>
    <span class="s2">&quot;attention_num_transformer_units&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="c1"># The input and output size of each transformer unit.</span>
    <span class="s2">&quot;attention_dim&quot;</span><span class="p">:</span> <span class="mi">64</span><span class="p">,</span>
    <span class="c1"># The number of attention heads within the MultiHeadAttention units.</span>
    <span class="s2">&quot;attention_num_heads&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="c1"># The dim of a single head (within the MultiHeadAttention units).</span>
    <span class="s2">&quot;attention_head_dim&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
    <span class="c1"># The memory sizes for inference and training.</span>
    <span class="s2">&quot;attention_memory_inference&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="s2">&quot;attention_memory_training&quot;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
    <span class="c1"># The output dim of the position-wise MLP.</span>
    <span class="s2">&quot;attention_position_wise_mlp_dim&quot;</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span>
    <span class="c1"># The initial bias values for the 2 GRU gates within a transformer unit.</span>
    <span class="s2">&quot;attention_init_gru_gate_bias&quot;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
    <span class="c1"># Whether to feed a_{t-n:t-1} to GTrXL (one-hot encoded if discrete).</span>
    <span class="s2">&quot;attention_use_n_prev_actions&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="c1"># Whether to feed r_{t-n:t-1} to GTrXL.</span>
    <span class="s2">&quot;attention_use_n_prev_rewards&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>

    <span class="c1"># == Atari ==</span>
    <span class="c1"># Set to True to enable 4x stacking behavior.</span>
    <span class="s2">&quot;framestack&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="c1"># Final resized frame dimension</span>
    <span class="s2">&quot;dim&quot;</span><span class="p">:</span> <span class="mi">84</span><span class="p">,</span>
    <span class="c1"># (deprecated) Converts ATARI frame to 1 Channel Grayscale image</span>
    <span class="s2">&quot;grayscale&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="c1"># (deprecated) Changes frame to range from [-1, 1] if true</span>
    <span class="s2">&quot;zero_mean&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>

    <span class="c1"># === Options for custom models ===</span>
    <span class="c1"># Name of a custom model to use</span>
    <span class="s2">&quot;custom_model&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># Extra options to pass to the custom classes. These will be available to</span>
    <span class="c1"># the Model&#39;s constructor in the model_config field. Also, they will be</span>
    <span class="c1"># attempted to be passed as **kwargs to ModelV2 models. For an example,</span>
    <span class="c1"># see rllib/models/[tf|torch]/attention_net.py.</span>
    <span class="s2">&quot;custom_model_config&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="c1"># Name of a custom action distribution to use.</span>
    <span class="s2">&quot;custom_action_dist&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># Custom preprocessors are deprecated. Please use a wrapper class around</span>
    <span class="c1"># your environment instead to preprocess observations.</span>
    <span class="s2">&quot;custom_preprocessor&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>

    <span class="c1"># === Options for ModelConfigs in RLModules ===</span>
    <span class="c1"># The latent dimension to encode into.</span>
    <span class="c1"># Since most RLModules have an encoder and heads, this establishes an agreement</span>
    <span class="c1"># on the dimensionality of the latent space they share.</span>
    <span class="c1"># This has no effect for models outside RLModule.</span>
    <span class="c1"># If None, model_config[&#39;fcnet_hiddens&#39;][-1] value will be used to guarantee</span>
    <span class="c1"># backward compatibility to old configs. This yields different models than past</span>
    <span class="c1"># versions of RLlib.</span>
    <span class="s2">&quot;encoder_latent_dim&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="c1"># Whether to always check the inputs and outputs of RLlib&#39;s default models for</span>
    <span class="c1"># their specifications. Input specifications are checked on failed forward passes</span>
    <span class="c1"># of the models regardless of this flag. If this flag is set to `True`, inputs and</span>
    <span class="c1"># outputs are checked on every call. This leads to a slow-down and should only be</span>
    <span class="c1"># used for debugging. Note that this flag is only relevant for instances of</span>
    <span class="c1"># RLlib&#39;s Model class. These are commonly generated from ModelConfigs in RLModules.</span>
    <span class="s2">&quot;always_check_shapes&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>

    <span class="c1"># Deprecated keys:</span>
    <span class="c1"># Use `lstm_use_prev_action` or `lstm_use_prev_reward` instead.</span>
    <span class="s2">&quot;lstm_use_prev_action_reward&quot;</span><span class="p">:</span> <span class="n">DEPRECATED_VALUE</span><span class="p">,</span>
    <span class="c1"># Deprecated in anticipation of RLModules API</span>
    <span class="s2">&quot;_use_default_native_models&quot;</span><span class="p">:</span> <span class="n">DEPRECATED_VALUE</span><span class="p">,</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
</details></div>
<p>While Catalogs have a base class Catalog, you mostly interact with
Algorithm-specific Catalogs.
Therefore, this doc also includes examples around PPO from which you can extrapolate to other algorithms.
Prerequisites for this user guide is a rough understanding of <a class="reference external" href="rllib-rlmodule.html">RLModules</a>.
This user guide covers the following topics:</p>
<ul class="simple">
<li><p>What are Catalogs</p></li>
<li><p>Catalog design and ideas</p></li>
<li><p>Catalog and AlgorithmConfig</p></li>
<li><p>Basic usage</p></li>
<li><p>Inject your custom models into RLModules</p></li>
<li><p>Inject your custom action distributions into RLModules</p></li>
<li><p>Write a Catalog from scratch</p></li>
</ul>
<section id="what-are-catalogs">
<h2>What are Catalogs<a class="headerlink" href="#what-are-catalogs" title="Permalink to this headline">#</a></h2>
<p>Catalogs have two primary roles: Choosing the right <code class="xref py py-class docutils literal notranslate"><span class="pre">Model</span></code> and choosing the right <code class="xref py py-class docutils literal notranslate"><span class="pre">Distribution</span></code>.
By default, all catalogs implement decision trees that decide model architecture based on a combination of input configurations.
These mainly include the <code class="docutils literal notranslate"><span class="pre">observation</span> <span class="pre">space</span></code> and <code class="docutils literal notranslate"><span class="pre">action</span> <span class="pre">space</span></code> of the <code class="xref py py-class docutils literal notranslate"><span class="pre">RLModule</span></code>, the <code class="docutils literal notranslate"><span class="pre">model</span> <span class="pre">config</span> <span class="pre">dict</span></code> and the <code class="docutils literal notranslate"><span class="pre">deep</span> <span class="pre">learning</span> <span class="pre">framework</span> <span class="pre">backend</span></code>.</p>
<p>The following diagram shows the break down of the information flow towards <code class="docutils literal notranslate"><span class="pre">models</span></code> and <code class="docutils literal notranslate"><span class="pre">distributions</span></code> within an RLModule.
An RLModule creates an instance of the Catalog class they receive as part of their constructor.
It then create its internal <code class="docutils literal notranslate"><span class="pre">models</span></code> and <code class="docutils literal notranslate"><span class="pre">distributions</span></code> with the help of this Catalog.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can also modify Model or Distribution in an RLModule directly by overriding the RLModule’s constructor!</p>
</div>
<img alt="../_images/catalog_and_rlm_diagram.svg" class="align-center" src="../_images/catalog_and_rlm_diagram.svg" /><p>The following diagram shows a concrete case in more detail.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3 sd-fade-in-slide-down">
<summary class="sd-summary-title sd-card-header">
<strong>Example of catalog in a PPORLModule</strong><div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">The <code class="xref py py-class docutils literal notranslate"><span class="pre">PPOCatalog</span></code> is fed an <code class="docutils literal notranslate"><span class="pre">observation</span> <span class="pre">space</span></code>, <code class="docutils literal notranslate"><span class="pre">action</span> <span class="pre">space</span></code>,
a <code class="docutils literal notranslate"><span class="pre">model</span> <span class="pre">config</span> <span class="pre">dict</span></code> and the <code class="docutils literal notranslate"><span class="pre">view</span> <span class="pre">requirements</span></code> of the <code class="xref py py-class docutils literal notranslate"><span class="pre">RLModule</span></code>.
The <code class="docutils literal notranslate"><span class="pre">model</span> <span class="pre">config</span> <span class="pre">dicts</span></code> and the <code class="docutils literal notranslate"><span class="pre">view</span> <span class="pre">requirements</span></code> are only of interest in special cases, such as
recurrent networks or attention networks. A PPORLModule has four components that are created by the PPOCatalog:
<code class="docutils literal notranslate"><span class="pre">Encoder</span></code>, <code class="docutils literal notranslate"><span class="pre">value</span> <span class="pre">function</span> <span class="pre">head</span></code>, <code class="docutils literal notranslate"><span class="pre">policy</span> <span class="pre">head</span></code>, and <code class="docutils literal notranslate"><span class="pre">action</span> <span class="pre">distribution</span></code>.</p>
<img alt="../_images/ppo_catalog_and_rlm_diagram.svg" class="align-center" src="../_images/ppo_catalog_and_rlm_diagram.svg" /></div>
</details></section>
<section id="catalog-design-and-ideas">
<h2>Catalog design and ideas<a class="headerlink" href="#catalog-design-and-ideas" title="Permalink to this headline">#</a></h2>
<p>Since the main use cases for this component involve deep modifications of it, we explain the design and ideas behind Catalogs in this section.</p>
<section id="what-problems-do-catalogs-solve">
<h3>What problems do Catalogs solve?<a class="headerlink" href="#what-problems-do-catalogs-solve" title="Permalink to this headline">#</a></h3>
<p>RL algorithms need neural network <code class="docutils literal notranslate"><span class="pre">models</span></code> and <code class="docutils literal notranslate"><span class="pre">distributions</span></code>.
Within an algorithm, many different architectures for such sub-components are valid.
Moreover, models and distributions vary with environments.
However, most algorithms require models that have similarities.
The problem is finding sensible sub-components for a wide range of use cases while sharing this functionality
across algorithms.</p>
</section>
<section id="how-do-catalogs-solve-this">
<h3>How do Catalogs solve this?<a class="headerlink" href="#how-do-catalogs-solve-this" title="Permalink to this headline">#</a></h3>
<p>As states above, Catalogs implement decision-trees for sub-components of <code class="xref py py-obj docutils literal notranslate"><span class="pre">RLModules</span></code>.
Models and distributions from a Catalog object are meant to fit together.
Since we mostly build RLModules out of <code class="xref py py-class docutils literal notranslate"><span class="pre">Encoder</span></code> s, Heads and <code class="xref py py-class docutils literal notranslate"><span class="pre">Distribution</span></code> s, Catalogs also generally reflect this.
For example, the PPOCatalog will output Encoders that output a latent vector and two Heads that take this latent vector as input.
(That’s why Catalogs have a <code class="docutils literal notranslate"><span class="pre">latent_dims</span></code> attribute). Heads and distributions behave accordingly.
Whenever you create a Catalog, the decision tree is executed to find suitable configs for models and classes for distributions.
By default this happens in <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_encoder_config()</span></code> and <code class="xref py py-meth docutils literal notranslate"><span class="pre">_get_dist_cls_from_action_space()</span></code>.
Whenever you build a model, the config is turned into a model.
Distributions are instantiated per forward pass of an <code class="xref py py-obj docutils literal notranslate"><span class="pre">RLModule</span></code> and are therefore not built.</p>
</section>
<section id="api-philosophy">
<h3>API philosophy<a class="headerlink" href="#api-philosophy" title="Permalink to this headline">#</a></h3>
<p>Catalogs attempt to encapsulate most complexity around models inside the <code class="xref py py-class docutils literal notranslate"><span class="pre">Encoder</span></code>.
This means that recurrency, attention and other special cases are fully handles inside the Encoder and are transparent
to other components.
Encoders are the only components that the Catalog base class builds.
This is because many algorithms require custom heads and distributions but most of them can use the same encoders.
The Catalog API is designed such that interaction usually happens in two stages:</p>
<ul class="simple">
<li><p>Instantiate a Catalog. This executes the decision tree.</p></li>
<li><p>Generate arbitrary number of decided components through Catalog methods.</p></li>
</ul>
<p>The two default methods to access components on the base class are…</p>
<ul class="simple">
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">build_encoder()</span></code></p></li>
<li><p><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_action_dist_cls()</span></code></p></li>
</ul>
<p>You can override these to quickly hack what models RLModules build.
Other methods are private and should only be overridden to make deep changes to the decision tree to enhance the capabilities of Catalogs.
Additionally, <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_tokenizer_config()</span></code> is a method that can be used when tokenization
is required. Tokenization means single-step-embedding. Encoding also means embedding but can span multiple timesteps.
In fact, RLlib’s tokenizers used in its recurrent Encoders (e.g. <code class="xref py py-class docutils literal notranslate"><span class="pre">TorchLSTMEncoder</span></code>),
are instances of non-recurrent Encoder classes.</p>
</section>
</section>
<section id="catalog-and-algorithmconfig">
<h2>Catalog and AlgorithmConfig<a class="headerlink" href="#catalog-and-algorithmconfig" title="Permalink to this headline">#</a></h2>
<p>Since Catalogs effectively control what <code class="docutils literal notranslate"><span class="pre">models</span></code> and <code class="docutils literal notranslate"><span class="pre">distributions</span></code> RLlib uses under the hood,
they are also part of RLlib’s configurations. As the primary entry point for configuring RLlib,
<code class="xref py py-class docutils literal notranslate"><span class="pre">AlgorithmConfig</span></code> is the place where you can configure the
Catalogs of the RLModules that are created.
You set the <code class="docutils literal notranslate"><span class="pre">catalog</span> <span class="pre">class</span></code> by going through the <code class="xref py py-class docutils literal notranslate"><span class="pre">SingleAgentRLModuleSpec</span></code>
or <code class="xref py py-class docutils literal notranslate"><span class="pre">MultiAgentRLModuleSpec</span></code> of an AlgorithmConfig.
For example, in heterogeneous multi-agent cases, you modify the MultiAgentRLModuleSpec.</p>
<img alt="../_images/catalog_rlmspecs_diagram.svg" class="align-center" src="../_images/catalog_rlmspecs_diagram.svg" /><p>The following example shows how to configure the Catalog of an <code class="xref py py-class docutils literal notranslate"><span class="pre">RLModule</span></code>
created by PPO.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray.rllib.algorithms.ppo.ppo_catalog</span> <span class="kn">import</span> <span class="n">PPOCatalog</span>
<span class="kn">from</span> <span class="nn">ray.rllib.algorithms.ppo</span> <span class="kn">import</span> <span class="n">PPOConfig</span>
<span class="kn">from</span> <span class="nn">ray.rllib.core.rl_module.rl_module</span> <span class="kn">import</span> <span class="n">SingleAgentRLModuleSpec</span>


<span class="k">class</span> <span class="nc">MyPPOCatalog</span><span class="p">(</span><span class="n">PPOCatalog</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hi from within PPORLModule!&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="n">config</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">PPOConfig</span><span class="p">()</span>
    <span class="o">.</span><span class="n">environment</span><span class="p">(</span><span class="s2">&quot;CartPole-v1&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">framework</span><span class="p">(</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rl_module</span><span class="p">(</span><span class="n">_enable_rl_module_api</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">training</span><span class="p">(</span><span class="n">_enable_learner_api</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Specify the catalog to use for the PPORLModule.</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">rl_module</span><span class="p">(</span>
    <span class="n">rl_module_spec</span><span class="o">=</span><span class="n">SingleAgentRLModuleSpec</span><span class="p">(</span><span class="n">catalog_class</span><span class="o">=</span><span class="n">MyPPOCatalog</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># This is how RLlib constructs a PPORLModule</span>
<span class="c1"># It will say &quot;Hi from within PPORLModule!&quot;.</span>
<span class="n">ppo</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="basic-usage">
<h2>Basic usage<a class="headerlink" href="#basic-usage" title="Permalink to this headline">#</a></h2>
<p>In the following three examples, we play with Catalogs to illustrate their API.</p>
<section id="high-level-api">
<h3>High-level API<a class="headerlink" href="#high-level-api" title="Permalink to this headline">#</a></h3>
<p>The first example showcases the general API for interacting with Catalogs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>

<span class="kn">from</span> <span class="nn">ray.rllib.algorithms.ppo.ppo_catalog</span> <span class="kn">import</span> <span class="n">PPOCatalog</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;CartPole-v1&quot;</span><span class="p">)</span>

<span class="n">catalog</span> <span class="o">=</span> <span class="n">PPOCatalog</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="p">,</span> <span class="n">model_config_dict</span><span class="o">=</span><span class="p">{})</span>
<span class="c1"># Build an encoder that fits CartPole&#39;s observation space.</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">build_actor_critic_encoder</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>
<span class="n">policy_head</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">build_pi_head</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>
<span class="c1"># We expect a categorical distribution for CartPole.</span>
<span class="n">action_dist_class</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">get_action_dist_cls</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="creating-models-and-distributions">
<h3>Creating models and distributions<a class="headerlink" href="#creating-models-and-distributions" title="Permalink to this headline">#</a></h3>
<p>The second example showcases how to use the base <code class="xref py py-class docutils literal notranslate"><span class="pre">Catalog</span></code>
to create an <code class="docutils literal notranslate"><span class="pre">model</span></code> and an <code class="docutils literal notranslate"><span class="pre">action</span> <span class="pre">distribution</span></code>.
Besides these, we create a <code class="docutils literal notranslate"><span class="pre">head</span> <span class="pre">network</span></code> by hand that fits these two by hand.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3 sd-fade-in-slide-down">
<summary class="sd-summary-title sd-card-header">
<strong>Customize a policy head</strong><div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="c1"># ENCODER_OUT is a constant we use to enumerate Encoder I/O.</span>
<span class="kn">from</span> <span class="nn">ray.rllib.core.models.base</span> <span class="kn">import</span> <span class="n">ENCODER_OUT</span>
<span class="kn">from</span> <span class="nn">ray.rllib.core.models.catalog</span> <span class="kn">import</span> <span class="n">Catalog</span>
<span class="kn">from</span> <span class="nn">ray.rllib.policy.sample_batch</span> <span class="kn">import</span> <span class="n">SampleBatch</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;CartPole-v1&quot;</span><span class="p">)</span>

<span class="n">catalog</span> <span class="o">=</span> <span class="n">Catalog</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="p">,</span> <span class="n">model_config_dict</span><span class="o">=</span><span class="p">{})</span>
<span class="c1"># We expect a categorical distribution for CartPole.</span>
<span class="n">action_dist_class</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">get_action_dist_cls</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>

<span class="c1"># Build an encoder that fits CartPole&#39;s observation space.</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">build_encoder</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>
<span class="c1"># Build a suitable head model for the action distribution.</span>
<span class="c1"># We need `env.action_space.n` action distribution inputs.</span>
<span class="n">head</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">catalog</span><span class="o">.</span><span class="n">latent_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
<span class="c1"># Now we are ready to interact with the environment</span>
<span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="c1"># Encoders check for state and sequence lengths for recurrent models.</span>
<span class="c1"># We don&#39;t need either in this case because default encoders are not recurrent.</span>
<span class="n">input_batch</span> <span class="o">=</span> <span class="p">{</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">OBS</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="n">obs</span><span class="p">])}</span>
<span class="c1"># Pass the batch through our models and the action distribution.</span>
<span class="n">encoding</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="n">input_batch</span><span class="p">)[</span><span class="n">ENCODER_OUT</span><span class="p">]</span>
<span class="n">action_dist_inputs</span> <span class="o">=</span> <span class="n">head</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
<span class="n">action_dist</span> <span class="o">=</span> <span class="n">action_dist_class</span><span class="o">.</span><span class="n">from_logits</span><span class="p">(</span><span class="n">action_dist_inputs</span><span class="p">)</span>
<span class="n">actions</span> <span class="o">=</span> <span class="n">action_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">actions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details></section>
<section id="creating-models-and-distributions-for-ppo">
<h3>Creating models and distributions for PPO<a class="headerlink" href="#creating-models-and-distributions-for-ppo" title="Permalink to this headline">#</a></h3>
<p>The third example showcases how to use the <code class="xref py py-class docutils literal notranslate"><span class="pre">PPOCatalog</span></code>
to create a <code class="docutils literal notranslate"><span class="pre">encoder</span></code> and an <code class="docutils literal notranslate"><span class="pre">action</span> <span class="pre">distribution</span></code>.
This is more similar to what RLlib does internally.</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3 sd-fade-in-slide-down">
<summary class="sd-summary-title sd-card-header">
<strong>Use catalog-generated models</strong><div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">ray.rllib.algorithms.ppo.ppo_catalog</span> <span class="kn">import</span> <span class="n">PPOCatalog</span>

<span class="c1"># STATE_IN, STATE_OUT and ENCODER_OUT are constants we use to enumerate Encoder I/O.</span>
<span class="kn">from</span> <span class="nn">ray.rllib.core.models.base</span> <span class="kn">import</span> <span class="n">STATE_IN</span><span class="p">,</span> <span class="n">ENCODER_OUT</span><span class="p">,</span> <span class="n">ACTOR</span>
<span class="kn">from</span> <span class="nn">ray.rllib.policy.sample_batch</span> <span class="kn">import</span> <span class="n">SampleBatch</span>

<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;CartPole-v1&quot;</span><span class="p">)</span>

<span class="n">catalog</span> <span class="o">=</span> <span class="n">PPOCatalog</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">observation_space</span><span class="p">,</span> <span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="p">,</span> <span class="n">model_config_dict</span><span class="o">=</span><span class="p">{})</span>
<span class="c1"># Build an encoder that fits CartPole&#39;s observation space.</span>
<span class="n">encoder</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">build_actor_critic_encoder</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>
<span class="n">policy_head</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">build_pi_head</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>
<span class="c1"># We expect a categorical distribution for CartPole.</span>
<span class="n">action_dist_class</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">get_action_dist_cls</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="s2">&quot;torch&quot;</span><span class="p">)</span>

<span class="c1"># Now we are ready to interact with the environment</span>
<span class="n">obs</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="c1"># Encoders check for state and sequence lengths for recurrent models.</span>
<span class="c1"># We don&#39;t need either in this case because default encoders are not recurrent.</span>
<span class="n">input_batch</span> <span class="o">=</span> <span class="p">{</span><span class="n">SampleBatch</span><span class="o">.</span><span class="n">OBS</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">([</span><span class="n">obs</span><span class="p">])}</span>
<span class="c1"># Pass the batch through our models and the action distribution.</span>
<span class="n">encoding</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span><span class="n">input_batch</span><span class="p">)[</span><span class="n">ENCODER_OUT</span><span class="p">][</span><span class="n">ACTOR</span><span class="p">]</span>
<span class="n">action_dist_inputs</span> <span class="o">=</span> <span class="n">policy_head</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
<span class="n">action_dist</span> <span class="o">=</span> <span class="n">action_dist_class</span><span class="o">.</span><span class="n">from_logits</span><span class="p">(</span><span class="n">action_dist_inputs</span><span class="p">)</span>
<span class="n">actions</span> <span class="o">=</span> <span class="n">action_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">actions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
</details><p>Note that the above two examples illustrate in principle what it takes to implement a Catalog.
In this case, we see the difference between <code class="xref py py-obj docutils literal notranslate"><span class="pre">Catalog</span></code> and <code class="xref py py-obj docutils literal notranslate"><span class="pre">PPOCatalog</span></code>.
In most cases, we can reuse the capabilities of the base <code class="xref py py-class docutils literal notranslate"><span class="pre">Catalog</span></code> base class
and only need to add methods to build head networks that we can then use in the appropriate <code class="xref py py-obj docutils literal notranslate"><span class="pre">RLModule</span></code>.</p>
</section>
</section>
<section id="inject-your-custom-model-or-action-distributions-into-catalogs">
<h2>Inject your custom model or action distributions into Catalogs<a class="headerlink" href="#inject-your-custom-model-or-action-distributions-into-catalogs" title="Permalink to this headline">#</a></h2>
<p>You can make a <code class="xref py py-class docutils literal notranslate"><span class="pre">Catalog</span></code> build custom <code class="docutils literal notranslate"><span class="pre">models</span></code> by overriding the Catalog’s methods used by RLModules to build <code class="docutils literal notranslate"><span class="pre">models</span></code>.
Have a look at these lines from the constructor of the <code class="xref py py-class docutils literal notranslate"><span class="pre">PPOTorchRLModule</span></code> to see how Catalogs are being used by an <code class="xref py py-class docutils literal notranslate"><span class="pre">RLModule</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>        <span class="n">catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_catalog</span><span class="p">()</span>

        <span class="c1"># Build models from catalog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">build_actor_critic_encoder</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">framework</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">build_pi_head</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">framework</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vf</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">build_vf_head</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">framework</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">action_dist_cls</span> <span class="o">=</span> <span class="n">catalog</span><span class="o">.</span><span class="n">get_action_dist_cls</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">framework</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that what happens inside the constructor of PPOTorchRLModule is similar to the earlier example <a class="reference external" href="rllib-catalogs.html#creating-models-and-distributions-for-ppo">Creating models and distributions for PPO</a>.</p>
<p>Consequently, in order to build a custom <code class="xref py py-class docutils literal notranslate"><span class="pre">Model</span></code> compatible with a PPORLModule,
you can override methods by inheriting from <code class="xref py py-class docutils literal notranslate"><span class="pre">PPOCatalog</span></code>
or write a <code class="xref py py-class docutils literal notranslate"><span class="pre">Catalog</span></code> that implements them from scratch.
The following examples showcase such modifications:</p>
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-0">
Adding a custom Encoder</label><div class="sd-tab-content docutils">
<p>This example shows two modifications:</p>
<ul class="simple">
<li><p>How to write a custom <code class="xref py py-class docutils literal notranslate"><span class="pre">Encoder</span></code></p></li>
<li><p>How to inject the custom Encoder into a <code class="xref py py-class docutils literal notranslate"><span class="pre">Catalog</span></code></p></li>
</ul>
<p>Note that, if you only want to inject your Encoder into a single <code class="xref py py-class docutils literal notranslate"><span class="pre">RLModule</span></code>, the recommended workflow is to inherit
from an existing RL Module and place the Encoder there.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">ray.rllib.algorithms.ppo.ppo</span> <span class="kn">import</span> <span class="n">PPOConfig</span>
<span class="kn">from</span> <span class="nn">ray.rllib.algorithms.ppo.ppo_catalog</span> <span class="kn">import</span> <span class="n">PPOCatalog</span>
<span class="kn">from</span> <span class="nn">ray.rllib.examples.models.mobilenet_v2_encoder</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">MobileNetV2EncoderConfig</span><span class="p">,</span>
    <span class="n">MOBILENET_INPUT_SHAPE</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ray.rllib.core.rl_module.rl_module</span> <span class="kn">import</span> <span class="n">SingleAgentRLModuleSpec</span>
<span class="kn">from</span> <span class="nn">ray.rllib.examples.env.random_env</span> <span class="kn">import</span> <span class="n">RandomEnv</span>


<span class="c1"># Define a PPO Catalog that we can use to inject our MobileNetV2 Encoder into RLlib&#39;s</span>
<span class="c1"># decision tree of what model to choose</span>
<span class="k">class</span> <span class="nc">MobileNetEnhancedPPOCatalog</span><span class="p">(</span><span class="n">PPOCatalog</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_get_encoder_config</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">observation_space</span><span class="p">:</span> <span class="n">gym</span><span class="o">.</span><span class="n">Space</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">observation_space</span><span class="p">,</span> <span class="n">gym</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">observation_space</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">MOBILENET_INPUT_SHAPE</span>
        <span class="p">):</span>
            <span class="c1"># Inject our custom encoder here, only if the observation space fits it</span>
            <span class="k">return</span> <span class="n">MobileNetV2EncoderConfig</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_get_encoder_config</span><span class="p">(</span><span class="n">observation_space</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="c1"># Create a generic config with our enhanced Catalog</span>
<span class="n">ppo_config</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">PPOConfig</span><span class="p">()</span>
    <span class="o">.</span><span class="n">rl_module</span><span class="p">(</span>
        <span class="n">rl_module_spec</span><span class="o">=</span><span class="n">SingleAgentRLModuleSpec</span><span class="p">(</span>
            <span class="n">catalog_class</span><span class="o">=</span><span class="n">MobileNetEnhancedPPOCatalog</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rollouts</span><span class="p">(</span><span class="n">num_rollout_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># The following training settings make it so that a training iteration is very</span>
    <span class="c1"># quick. This is just for the sake of this example. PPO will not learn properly</span>
    <span class="c1"># with these settings!</span>
    <span class="o">.</span><span class="n">training</span><span class="p">(</span><span class="n">train_batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">sgd_minibatch_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">num_sgd_iter</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># CartPole&#39;s observation space is not compatible with our MobileNetV2 Encoder, so</span>
<span class="c1"># this will use the default behaviour of Catalogs</span>
<span class="n">ppo_config</span><span class="o">.</span><span class="n">environment</span><span class="p">(</span><span class="s2">&quot;CartPole-v1&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">ppo_config</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

<span class="c1"># For this training, we use a RandomEnv with observations of shape</span>
<span class="c1"># MOBILENET_INPUT_SHAPE. This will use our custom Encoder.</span>
<span class="n">ppo_config</span><span class="o">.</span><span class="n">environment</span><span class="p">(</span>
    <span class="n">RandomEnv</span><span class="p">,</span>
    <span class="n">env_config</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;action_space&quot;</span><span class="p">:</span> <span class="n">gym</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">Discrete</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="c1"># Test a simple Image observation space.</span>
        <span class="s2">&quot;observation_space&quot;</span><span class="p">:</span> <span class="n">gym</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">(</span>
            <span class="mf">0.0</span><span class="p">,</span>
            <span class="mf">1.0</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">MOBILENET_INPUT_SHAPE</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">ppo_config</span><span class="o">.</span><span class="n">build</span><span class="p">()</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
</input><label class="sd-tab-label" for="sd-tab-item-1">
Adding a custom action distribution</label><div class="sd-tab-content docutils">
<p>This example shows two modifications:</p>
<ul class="simple">
<li><p>How to write a custom <code class="xref py py-class docutils literal notranslate"><span class="pre">Distribution</span></code></p></li>
<li><p>How to inject the custom action distribution into a <code class="xref py py-class docutils literal notranslate"><span class="pre">Catalog</span></code></p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>

<span class="kn">from</span> <span class="nn">ray.rllib.algorithms.ppo.ppo</span> <span class="kn">import</span> <span class="n">PPOConfig</span>
<span class="kn">from</span> <span class="nn">ray.rllib.algorithms.ppo.ppo_catalog</span> <span class="kn">import</span> <span class="n">PPOCatalog</span>
<span class="kn">from</span> <span class="nn">ray.rllib.core.rl_module.rl_module</span> <span class="kn">import</span> <span class="n">SingleAgentRLModuleSpec</span>
<span class="kn">from</span> <span class="nn">ray.rllib.models.distributions</span> <span class="kn">import</span> <span class="n">Distribution</span>
<span class="kn">from</span> <span class="nn">ray.rllib.models.torch.torch_distributions</span> <span class="kn">import</span> <span class="n">TorchDeterministic</span>


<span class="c1"># Define a simple categorical distribution that can be used for PPO</span>
<span class="k">class</span> <span class="nc">CustomTorchCategorical</span><span class="p">(</span><span class="n">Distribution</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torch_dist</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">categorical</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">rsample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample_shape</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">Size</span><span class="p">(),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dist</span><span class="o">.</span><span class="n">rsample</span><span class="p">(</span><span class="n">sample_shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">logp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch_dist</span><span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">entropy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">torch_dist</span><span class="o">.</span><span class="n">entropy</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">kl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">kl</span><span class="o">.</span><span class="n">kl_divergence</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">torch_dist</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">torch_dist</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">required_input_dim</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">space</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="c1"># This method is used to create distributions from logits inside RLModules.</span>
    <span class="c1"># You can use this to inject arguments into the constructor of this distribution</span>
    <span class="c1"># that are not the logits themselves.</span>
    <span class="k">def</span> <span class="nf">from_logits</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">logits</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CustomTorchCategorical</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">logits</span><span class="p">)</span>

    <span class="c1"># This method is used to create a deterministic distribution for the</span>
    <span class="c1"># PPORLModule.forward_inference.</span>
    <span class="k">def</span> <span class="nf">to_deterministic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">TorchDeterministic</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>


<span class="c1"># See if we can create this distribution and sample from it to interact with our</span>
<span class="c1"># target environment</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;CartPole-v1&quot;</span><span class="p">)</span>
<span class="n">dummy_logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">([</span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">])</span>
<span class="n">dummy_dist</span> <span class="o">=</span> <span class="n">CustomTorchCategorical</span><span class="o">.</span><span class="n">from_logits</span><span class="p">(</span><span class="n">dummy_logits</span><span class="p">)</span>
<span class="n">action</span> <span class="o">=</span> <span class="n">dummy_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="s2">&quot;CartPole-v1&quot;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
<span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>


<span class="c1"># Define a simple catalog that returns our custom distribution when</span>
<span class="c1"># get_action_dist_cls is called</span>
<span class="k">class</span> <span class="nc">CustomPPOCatalog</span><span class="p">(</span><span class="n">PPOCatalog</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_action_dist_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">framework</span><span class="p">):</span>
        <span class="c1"># The distribution we wrote will only work with torch</span>
        <span class="k">assert</span> <span class="n">framework</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span>
        <span class="k">return</span> <span class="n">CustomTorchCategorical</span>


<span class="c1"># Train with our custom action distribution</span>
<span class="n">algo</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">PPOConfig</span><span class="p">()</span>
    <span class="o">.</span><span class="n">environment</span><span class="p">(</span><span class="s2">&quot;CartPole-v1&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">rl_module</span><span class="p">(</span><span class="n">rl_module_spec</span><span class="o">=</span><span class="n">SingleAgentRLModuleSpec</span><span class="p">(</span><span class="n">catalog_class</span><span class="o">=</span><span class="n">CustomPPOCatalog</span><span class="p">))</span>
    <span class="o">.</span><span class="n">build</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">algo</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>These examples target PPO but the workflows apply to all RLlib algorithms.
Note that PPO adds the <code class="xref py py-class docutils literal notranslate"><span class="pre">from</span> <span class="pre">ray.rllib.core.models.base.ActorCriticEncoder</span></code> and two heads (policy- and value-head) to the base class.
You can override these similarly to the above.
Other algorithms may add different sub-components or override default ones.</p>
</section>
<section id="write-a-catalog-from-scratch">
<h2>Write a Catalog from scratch<a class="headerlink" href="#write-a-catalog-from-scratch" title="Permalink to this headline">#</a></h2>
<p>You only need this when you want to write a new Algorithm under RLlib.
Note that writing an Algorithm does not strictly require writing a new Catalog but you can use Catalogs as a tool to create
the fitting default sub-components, such as models or distributions.
The following are typical requirements and steps for writing a new Catalog:</p>
<ul class="simple">
<li><p>Does the Algorithm need a special Encoder? Overwrite <code class="xref py py-meth docutils literal notranslate"><span class="pre">_get_encoder_config()</span></code>.</p></li>
<li><p>Does the Algorithm need an additional network? Write a method to build it. You can use RLlib’s model configurations to build models from dimensions.</p></li>
<li><p>Does the Algorithm need a custom distribution? Overwrite <code class="xref py py-meth docutils literal notranslate"><span class="pre">_get_dist_cls_from_action_space()</span></code>.</p></li>
<li><p>Does the Algorithm need a special tokenizer? Overwrite <code class="xref py py-meth docutils literal notranslate"><span class="pre">get_tokenizer_config()</span></code>.</p></li>
<li><p>Does the Algorithm not need an Encoder at all? Overwrite <code class="xref py py-meth docutils literal notranslate"><span class="pre">_determine_components_hook()</span></code>.</p></li>
</ul>
<p>The following example shows our implementation of a Catalog for PPO that follows the above steps:</p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<strong>Catalog for PPORLModules</strong><div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">gymnasium</span> <span class="k">as</span> <span class="nn">gym</span>

<span class="kn">from</span> <span class="nn">ray.rllib.core.models.catalog</span> <span class="kn">import</span> <span class="n">Catalog</span>
<span class="kn">from</span> <span class="nn">ray.rllib.core.models.configs</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ActorCriticEncoderConfig</span><span class="p">,</span>
    <span class="n">MLPHeadConfig</span><span class="p">,</span>
    <span class="n">FreeLogStdMLPHeadConfig</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ray.rllib.core.models.base</span> <span class="kn">import</span> <span class="n">Encoder</span><span class="p">,</span> <span class="n">ActorCriticEncoder</span><span class="p">,</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="nn">ray.rllib.utils</span> <span class="kn">import</span> <span class="n">override</span>
<span class="kn">from</span> <span class="nn">ray.rllib.utils.annotations</span> <span class="kn">import</span> <span class="n">OverrideToImplementCustomLogic</span>


<span class="k">def</span> <span class="nf">_check_if_diag_gaussian</span><span class="p">(</span><span class="n">action_distribution_cls</span><span class="p">,</span> <span class="n">framework</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">framework</span> <span class="o">==</span> <span class="s2">&quot;torch&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ray.rllib.models.torch.torch_distributions</span> <span class="kn">import</span> <span class="n">TorchDiagGaussian</span>

        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">action_distribution_cls</span><span class="p">,</span> <span class="n">TorchDiagGaussian</span><span class="p">),</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;free_log_std is only supported for DiagGaussian action distributions. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Found action distribution: </span><span class="si">{</span><span class="n">action_distribution_cls</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">framework</span> <span class="o">==</span> <span class="s2">&quot;tf2&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ray.rllib.models.tf.tf_distributions</span> <span class="kn">import</span> <span class="n">TfDiagGaussian</span>

        <span class="k">assert</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">action_distribution_cls</span><span class="p">,</span> <span class="n">TfDiagGaussian</span><span class="p">),</span> <span class="p">(</span>
            <span class="s2">&quot;free_log_std is only supported for DiagGaussian action distributions. &quot;</span>
            <span class="s2">&quot;Found action distribution: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">action_distribution_cls</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Framework </span><span class="si">{</span><span class="n">framework</span><span class="si">}</span><span class="s2"> not supported for free_log_std.&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PPOCatalog</span><span class="p">(</span><span class="n">Catalog</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The Catalog class used to build models for PPO.</span>

<span class="sd">    PPOCatalog provides the following models:</span>
<span class="sd">        - ActorCriticEncoder: The encoder used to encode the observations.</span>
<span class="sd">        - Pi Head: The head used to compute the policy logits.</span>
<span class="sd">        - Value Function Head: The head used to compute the value function.</span>

<span class="sd">    The ActorCriticEncoder is a wrapper around Encoders to produce separate outputs</span>
<span class="sd">    for the policy and value function. See implementations of PPORLModule for</span>
<span class="sd">    more details.</span>

<span class="sd">    Any custom ActorCriticEncoder can be built by overriding the</span>
<span class="sd">    build_actor_critic_encoder() method. Alternatively, the ActorCriticEncoderConfig</span>
<span class="sd">    at PPOCatalog.actor_critic_encoder_config can be overridden to build a custom</span>
<span class="sd">    ActorCriticEncoder during RLModule runtime.</span>

<span class="sd">    Any custom head can be built by overriding the build_pi_head() and build_vf_head()</span>
<span class="sd">    methods. Alternatively, the PiHeadConfig and VfHeadConfig can be overridden to</span>
<span class="sd">    build custom heads during RLModule runtime.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">observation_space</span><span class="p">:</span> <span class="n">gym</span><span class="o">.</span><span class="n">Space</span><span class="p">,</span>
        <span class="n">action_space</span><span class="p">:</span> <span class="n">gym</span><span class="o">.</span><span class="n">Space</span><span class="p">,</span>
        <span class="n">model_config_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes the PPOCatalog.</span>

<span class="sd">        Args:</span>
<span class="sd">            observation_space: The observation space of the Encoder.</span>
<span class="sd">            action_space: The action space for the Pi Head.</span>
<span class="sd">            model_config_dict: The model config to use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">observation_space</span><span class="o">=</span><span class="n">observation_space</span><span class="p">,</span>
            <span class="n">action_space</span><span class="o">=</span><span class="n">action_space</span><span class="p">,</span>
            <span class="n">model_config_dict</span><span class="o">=</span><span class="n">model_config_dict</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Replace EncoderConfig by ActorCriticEncoderConfig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actor_critic_encoder_config</span> <span class="o">=</span> <span class="n">ActorCriticEncoderConfig</span><span class="p">(</span>
            <span class="n">base_encoder_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_encoder_config</span><span class="p">,</span>
            <span class="n">shared</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_config_dict</span><span class="p">[</span><span class="s2">&quot;vf_share_layers&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pi_and_vf_head_hiddens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_config_dict</span><span class="p">[</span><span class="s2">&quot;post_fcnet_hiddens&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_and_vf_head_activation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_config_dict</span><span class="p">[</span>
            <span class="s2">&quot;post_fcnet_activation&quot;</span>
        <span class="p">]</span>

        <span class="c1"># We don&#39;t have the exact (framework specific) action dist class yet and thus</span>
        <span class="c1"># cannot determine the exact number of output nodes (action space) required.</span>
        <span class="c1"># -&gt; Build pi config only in the `self.build_pi_head` method.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_head_config</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">vf_head_config</span> <span class="o">=</span> <span class="n">MLPHeadConfig</span><span class="p">(</span>
            <span class="n">input_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latent_dims</span><span class="p">,</span>
            <span class="n">hidden_layer_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pi_and_vf_head_hiddens</span><span class="p">,</span>
            <span class="n">hidden_layer_activation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pi_and_vf_head_activation</span><span class="p">,</span>
            <span class="n">output_layer_activation</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
            <span class="n">output_layer_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@OverrideToImplementCustomLogic</span>
    <span class="k">def</span> <span class="nf">build_actor_critic_encoder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">framework</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ActorCriticEncoder</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Builds the ActorCriticEncoder.</span>

<span class="sd">        The default behavior is to build the encoder from the encoder_config.</span>
<span class="sd">        This can be overridden to build a custom ActorCriticEncoder as a means of</span>
<span class="sd">        configuring the behavior of a PPORLModule implementation.</span>

<span class="sd">        Args:</span>
<span class="sd">            framework: The framework to use. Either &quot;torch&quot; or &quot;tf2&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The ActorCriticEncoder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor_critic_encoder_config</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="n">framework</span><span class="p">)</span>

    <span class="nd">@override</span><span class="p">(</span><span class="n">Catalog</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">build_encoder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">framework</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Encoder</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Builds the encoder.</span>

<span class="sd">        Since PPO uses an ActorCriticEncoder, this method should not be implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;Use PPOCatalog.build_actor_critic_encoder() instead for PPO.&quot;</span>
        <span class="p">)</span>

    <span class="nd">@OverrideToImplementCustomLogic</span>
    <span class="k">def</span> <span class="nf">build_pi_head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">framework</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Builds the policy head.</span>

<span class="sd">        The default behavior is to build the head from the pi_head_config.</span>
<span class="sd">        This can be overridden to build a custom policy head as a means of configuring</span>
<span class="sd">        the behavior of a PPORLModule implementation.</span>

<span class="sd">        Args:</span>
<span class="sd">            framework: The framework to use. Either &quot;torch&quot; or &quot;tf2&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The policy head.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get action_distribution_cls to find out about the output dimension for pi_head</span>
        <span class="n">action_distribution_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_action_dist_cls</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="n">framework</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_config_dict</span><span class="p">[</span><span class="s2">&quot;free_log_std&quot;</span><span class="p">]:</span>
            <span class="n">_check_if_diag_gaussian</span><span class="p">(</span>
                <span class="n">action_distribution_cls</span><span class="o">=</span><span class="n">action_distribution_cls</span><span class="p">,</span> <span class="n">framework</span><span class="o">=</span><span class="n">framework</span>
            <span class="p">)</span>
        <span class="n">required_output_dim</span> <span class="o">=</span> <span class="n">action_distribution_cls</span><span class="o">.</span><span class="n">required_input_dim</span><span class="p">(</span>
            <span class="n">space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">action_space</span><span class="p">,</span> <span class="n">model_config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_model_config_dict</span>
        <span class="p">)</span>
        <span class="c1"># Now that we have the action dist class and number of outputs, we can define</span>
        <span class="c1"># our pi-config and build the pi head.</span>
        <span class="n">pi_head_config_class</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">FreeLogStdMLPHeadConfig</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_config_dict</span><span class="p">[</span><span class="s2">&quot;free_log_std&quot;</span><span class="p">]</span>
            <span class="k">else</span> <span class="n">MLPHeadConfig</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_head_config</span> <span class="o">=</span> <span class="n">pi_head_config_class</span><span class="p">(</span>
            <span class="n">input_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">latent_dims</span><span class="p">,</span>
            <span class="n">hidden_layer_dims</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pi_and_vf_head_hiddens</span><span class="p">,</span>
            <span class="n">hidden_layer_activation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pi_and_vf_head_activation</span><span class="p">,</span>
            <span class="n">output_layer_dim</span><span class="o">=</span><span class="n">required_output_dim</span><span class="p">,</span>
            <span class="n">output_layer_activation</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_head_config</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="n">framework</span><span class="p">)</span>

    <span class="nd">@OverrideToImplementCustomLogic</span>
    <span class="k">def</span> <span class="nf">build_vf_head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">framework</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Model</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Builds the value function head.</span>

<span class="sd">        The default behavior is to build the head from the vf_head_config.</span>
<span class="sd">        This can be overridden to build a custom value function head as a means of</span>
<span class="sd">        configuring the behavior of a PPORLModule implementation.</span>

<span class="sd">        Args:</span>
<span class="sd">            framework: The framework to use. Either &quot;torch&quot; or &quot;tf2&quot;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The value function head.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vf_head_config</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">framework</span><span class="o">=</span><span class="n">framework</span><span class="p">)</span>


</pre></div>
</div>
</div>
</details></section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="rllib-offline.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">使用离线数据</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="rllib-connector.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">连接器 (Beta)</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><!-- Override the footer area for the sphinx-book-theme to include the CSAT widget -->
<div id="csat">
  <div id="csat-feedback-received" class="csat-hidden">
    <span>谢谢你的反馈！</span>
  </div>
  <div id="csat-inputs">
    <span>是否能帮助到你？</span>
    <div id="csat-yes" class="csat-button">
      <svg id="csat-yes-icon" class="csat-hidden csat-icon" width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 10.172L16.1922 0.979004L17.6072 2.393L7.00023 13L0.63623 6.636L2.05023 5.222L7.00023 10.172Z" fill="black"/>
      </svg>
      <span>是<span>
    </div>
    <div id="csat-no" class="csat-button">
      <svg id="csat-no-icon" class="csat-hidden csat-icon" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 5.58599L11.9502 0.635986L13.3642 2.04999L8.41423 6.99999L13.3642 11.95L11.9502 13.364L7.00023 8.41399L2.05023 13.364L0.63623 11.95L5.58623 6.99999L0.63623 2.04999L2.05023 0.635986L7.00023 5.58599Z" fill="black"/>
      </svg>
      <span>否<span>
    </div>
  </div>
  <div id="csat-textarea-group" class="csat-hidden">
    <span id="csat-feedback-label">反馈</span>
    <textarea id="csat-textarea"></textarea>
    <div id="csat-submit">提交</div>
  </div>
</div><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2024, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>