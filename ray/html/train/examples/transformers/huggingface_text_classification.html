
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Fine-tune a Hugging Face Transformers Model &#8212; Ray 2.7.2</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/termynal.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/versionwarning.js"></script>
    <script src="../../../_static/togglebutton.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>
    <script defer="defer" src="../../../_static/js/docsearch.js"></script>
    <script defer="defer" src="../../../_static/js/csat.js"></script>
    <script defer="defer" src="../../../_static/js/termynal.js"></script>
    <script defer="defer" src="../../../_static/js/custom.js"></script>
    <script defer="defer" src="../../../_static/js/top-navigation.js"></script>
    <script src="../../../_static/js/tags.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <link rel="canonical" href="https://docs.ray.io/en/latest/train/examples/transformers/huggingface_text_classification.html" />
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />

<!-- Fathom - beautiful, simple website analytics -->
<script src="https://deer.ray.io/script.js" data-site="WYYANYOS" defer></script>
<!-- / Fathom -->

<script async src="https://www.googletagmanager.com/gtag/js?id=UA-110413294-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-110413294-1');
</script>

<script
  src="https://widget.kapa.ai/kapa-widget.bundle.js"
  data-website-id="18a8c339-4ec5-43c8-8182-db3f2bc8c6b6"
  data-project-name="Ray"
  data-project-color="#2C2C2C"
  data-project-logo="https://global.discourse-cdn.com/business7/uploads/ray/original/1X/8f4dcb72f7cd34e2a332d548bd65860994bc8ff1.png"
  data-modal-disclaimer = "Results are automated and may be incorrect or contain inappropriate information. Do not include any personal data or confidential information."
  data-modal-title = "Ray Docs AI - Ask a Question"
  data-button-position-bottom = "60px"
></script>

<script>
(function(apiKey){
    (function(p,e,n,d,o){var v,w,x,y,z;o=p[d]=p[d]||{};o._q=o._q||[];
    v=['initialize','identify','updateOptions','pageLoad','track'];for(w=0,x=v.length;w<x;++w)(function(m){
        o[m]=o[m]||function(){o._q[m===v[0]?'unshift':'push']([m].concat([].slice.call(arguments,0)));};})(v[w]);
        y=e.createElement(n);y.async=!0;y.src='https://cdn.pendo.io/agent/static/'+apiKey+'/pendo.js';
        z=e.getElementsByTagName(n)[0];z.parentNode.insertBefore(y,z);})(window,document,'script','pendo');

        pendo.initialize({
            visitor: {
                id: 'VISITOR-UNIQUE-ID'
            },
            account: {
                id: 'ACCOUNT-UNIQUE-ID'
            }
        });
})('f89fa48a-6dd7-4d7c-67cf-a8051ed891f2');
</script>



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"><div class='topnav'></div></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Ray 2.7.2</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main Navigation">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    欢迎来到 Ray ！
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Ray
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-overview/index.html">
   概述「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-overview/getting-started.html">
   入门「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-overview/installation.html">
   安装「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-overview/use-cases.html">
   用例「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-overview/examples.html">
   示例库「1%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-overview/ray-libraries.html">
   生态「3%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-core/walkthrough.html">
   Ray 核心「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../data/data.html">
   Ray 数据「85%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../train.html">
   Ray 训练「95%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../tune/index.html">
   Ray 调参「0%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../serve/index.html">
   Ray Serve「1%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../rllib/index.html">
   Ray RLlib「0%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-more-libs/index.html">
   更多类库「40%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../cluster/getting-started.html">
   Ray 集群「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-observability/index.html">
   监控调试「100%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-references/api.html">
   参考「20%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-contribute/index.html">
   开发者指引「30%」
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../../ray-security/index.html">
   安全「100%」
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ray-project/ray"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/issues/new?title=Issue%20on%20page%20%2Ftrain/examples/transformers/huggingface_text_classification.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ray-project/ray/edit/master/doc/source/train/examples/transformers/huggingface_text_classification.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../../_sources/train/examples/transformers/huggingface_text_classification.ipynb.txt"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-up-ray-a-name-setup-a">
   Set up Ray
   <a name="setup">
   </a>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fine-tune-a-model-on-a-text-classification-task">
   Fine-tune a model on a text classification task
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-the-dataset-a-name-load-a">
     Loading the dataset
     <a name="load">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preprocessing-the-data-with-ray-data-a-name-preprocess-a">
     Preprocessing the data with Ray Data
     <a name="preprocess">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fine-tuning-the-model-with-ray-train-a-name-train-a">
     Fine-tuning the model with Ray Train
     <a name="train">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tune-hyperparameters-with-ray-tune-a-name-predict-a">
     Tune hyperparameters with Ray Tune
     <a name="predict">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#share-the-model-a-name-share-a">
     Share the model
     <a name="share">
     </a>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#see-also">
   See also
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Fine-tune a Hugging Face Transformers Model</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#set-up-ray-a-name-setup-a">
   Set up Ray
   <a name="setup">
   </a>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fine-tune-a-model-on-a-text-classification-task">
   Fine-tune a model on a text classification task
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#loading-the-dataset-a-name-load-a">
     Loading the dataset
     <a name="load">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preprocessing-the-data-with-ray-data-a-name-preprocess-a">
     Preprocessing the data with Ray Data
     <a name="preprocess">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#fine-tuning-the-model-with-ray-train-a-name-train-a">
     Fine-tuning the model with Ray Train
     <a name="train">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tune-hyperparameters-with-ray-tune-a-name-predict-a">
     Tune hyperparameters with Ray Tune
     <a name="predict">
     </a>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#share-the-model-a-name-share-a">
     Share the model
     <a name="share">
     </a>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#see-also">
   See also
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="fine-tune-a-hugging-face-transformers-model">
<span id="train-transformers-glue-example"></span><h1>Fine-tune a Hugging Face Transformers Model<a class="headerlink" href="#fine-tune-a-hugging-face-transformers-model" title="Permalink to this headline">#</a></h1>
<p>This notebook is based on an official Hugging Face example, <a class="reference external" href="https://github.com/huggingface/notebooks/blob/6ca682955173cc9d36ffa431ddda505a048cbe80/examples/text_classification.ipynb">How to fine-tune a model on text classification</a>. This notebook shows the process of conversion from vanilla HF to Ray Train without changing the training logic unless necessary.</p>
<p>This notebook consists of the following steps:</p>
<ol class="simple">
<li><p><a class="reference external" href="#setup">Set up Ray</a></p></li>
<li><p><a class="reference external" href="#load">Load the dataset</a></p></li>
<li><p><a class="reference external" href="#preprocess">Preprocess the dataset with Ray Data</a></p></li>
<li><p><a class="reference external" href="#train">Run the training with Ray Train</a></p></li>
<li><p><a class="reference external" href="#share">Optionally, share the model with the community</a></p></li>
</ol>
<p>Uncomment and run the following line to install all the necessary dependencies. (This notebook is being tested with <code class="docutils literal notranslate"><span class="pre">transformers==4.19.1</span></code>.):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#! pip install &quot;datasets&quot; &quot;transformers&gt;=4.19.0&quot; &quot;torch&gt;=1.10.0&quot; &quot;mlflow&quot;</span>
</pre></div>
</div>
</div>
</div>
<section id="set-up-ray-a-name-setup-a">
<h2>Set up Ray <a name="setup"></a><a class="headerlink" href="#set-up-ray-a-name-setup-a" title="Permalink to this headline">#</a></h2>
<p>Use <code class="docutils literal notranslate"><span class="pre">ray.init()</span></code> to initialize a local cluster. By default, this cluster contains only the machine you are running this notebook on. You can also run this notebook on an <a class="reference external" href="https://www.anyscale.com/">Anyscale</a> cluster.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">import</span> <span class="nn">ray</span>

<span class="n">ray</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Check the resources our cluster is composed of. If you are running this notebook on your local machine or Google Colab, you should see the number of CPU cores and GPUs available on the your machine.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pprint</span><span class="p">(</span><span class="n">ray</span><span class="o">.</span><span class="n">cluster_resources</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;CPU&#39;: 48.0,
 &#39;GPU&#39;: 4.0,
 &#39;accelerator_type:None&#39;: 1.0,
 &#39;memory&#39;: 206158430208.0,
 &#39;node:10.0.27.125&#39;: 1.0,
 &#39;node:__internal_head__&#39;: 1.0,
 &#39;object_store_memory&#39;: 59052625920.0}
</pre></div>
</div>
</div>
</div>
<p>This notebook fine-tunes a <a class="reference external" href="https://github.com/huggingface/transformers">HF Transformers</a> model for one of the text classification task of the <a class="reference external" href="https://gluebenchmark.com/">GLUE Benchmark</a>. It runs the training using Ray Train.</p>
<p>You can change these two variables to control whether the training, which happens later, uses CPUs or GPUs, and how many workers to spawn. Each worker claims one CPU or GPU. Make sure to not request more resources than the resources present. By default, the training runs with one GPU worker.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">use_gpu</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># set this to False to run on CPUs</span>
<span class="n">num_workers</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># set this to number of GPUs or CPUs you want to use</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fine-tune-a-model-on-a-text-classification-task">
<h2>Fine-tune a model on a text classification task<a class="headerlink" href="#fine-tune-a-model-on-a-text-classification-task" title="Permalink to this headline">#</a></h2>
<p>The GLUE Benchmark is a group of nine classification tasks on sentences or pairs of sentences. To learn more, see the <a class="reference external" href="https://github.com/huggingface/notebooks/blob/6ca682955173cc9d36ffa431ddda505a048cbe80/examples/text_classification.ipynb">original notebook</a>.</p>
<p>Each task has a name that is its acronym, with <code class="docutils literal notranslate"><span class="pre">mnli-mm</span></code> to indicate that it is a mismatched version of MNLI. Each one has the same training set as <code class="docutils literal notranslate"><span class="pre">mnli</span></code> but different validation and test sets.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">GLUE_TASKS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;cola&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mnli&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mnli-mm&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mrpc&quot;</span><span class="p">,</span>
    <span class="s2">&quot;qnli&quot;</span><span class="p">,</span>
    <span class="s2">&quot;qqp&quot;</span><span class="p">,</span>
    <span class="s2">&quot;rte&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sst2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stsb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;wnli&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>This notebook runs on any of the tasks in the list above, with any model checkpoint from the <a class="reference external" href="https://huggingface.co/models">Model Hub</a> as long as that model has a version with a classification head. Depending on the model and the GPU you are using, you might need to adjust the batch size to avoid out-of-memory errors. Set these three parameters, and the rest of the notebook should run smoothly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;cola&quot;</span>
<span class="n">model_checkpoint</span> <span class="o">=</span> <span class="s2">&quot;distilbert-base-uncased&quot;</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">16</span>
</pre></div>
</div>
</div>
</div>
<section id="loading-the-dataset-a-name-load-a">
<h3>Loading the dataset <a name="load"></a><a class="headerlink" href="#loading-the-dataset-a-name-load-a" title="Permalink to this headline">#</a></h3>
<p>Use the <a class="reference external" href="https://github.com/huggingface/datasets">HF Datasets</a> library to download the data and get the metric to use for evaluation and to compare your model to the benchmark. You can do this comparison easily with the <code class="docutils literal notranslate"><span class="pre">load_dataset</span></code> and <code class="docutils literal notranslate"><span class="pre">load_metric</span></code> functions.</p>
<p>Apart from <code class="docutils literal notranslate"><span class="pre">mnli-mm</span></code> being special code, you can directly pass the task name to those functions.</p>
<p>Run the normal HF Datasets code to load the dataset from the Hub.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_dataset</span>

<span class="n">actual_task</span> <span class="o">=</span> <span class="s2">&quot;mnli&quot;</span> <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;mnli-mm&quot;</span> <span class="k">else</span> <span class="n">task</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="s2">&quot;glue&quot;</span><span class="p">,</span> <span class="n">actual_task</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Reusing dataset glue (/home/ray/.cache/huggingface/datasets/glue/cola/1.0.0/dacbe3125aa31d7f70367a07a8a9e72a5a0bfeb5fc42e75c9db75b96da6053ad)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "8217c4d4e1e7402c92477b3e2cf8961c", "version_major": 2, "version_minor": 0}
</script></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">dataset</span></code> object itself is a <a class="reference external" href="https://huggingface.co/docs/datasets/package_reference/main_classes.html#datasetdict"><code class="docutils literal notranslate"><span class="pre">DatasetDict</span></code></a>, which contains one key for the training, validation, and test set, with more keys for the mismatched validation and test set in the special case of <code class="docutils literal notranslate"><span class="pre">mnli</span></code>.</p>
</section>
<section id="preprocessing-the-data-with-ray-data-a-name-preprocess-a">
<h3>Preprocessing the data with Ray Data <a name="preprocess"></a><a class="headerlink" href="#preprocessing-the-data-with-ray-data-a-name-preprocess-a" title="Permalink to this headline">#</a></h3>
<p>Before you can feed these texts to the model, you need to preprocess them. Preprocess them with a HF Transformers’ <code class="docutils literal notranslate"><span class="pre">Tokenizer</span></code>, which tokenizes the inputs, including converting the tokens to their corresponding IDs in the pretrained vocabulary, and puts them in a format the model expects. It also generates the other inputs that the model requires.</p>
<p>To do all of this preprocessing, instantiate your tokenizer with the <code class="docutils literal notranslate"><span class="pre">AutoTokenizer.from_pretrained</span></code> method, which ensures that you:</p>
<ul class="simple">
<li><p>Get a tokenizer that corresponds to the model architecture you want to use.</p></li>
<li><p>Download the vocabulary used when pretraining this specific checkpoint.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span>

<span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_checkpoint</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Pass <code class="docutils literal notranslate"><span class="pre">use_fast=True</span></code> to the preceding call to use one of the fast tokenizers, backed by Rust, from the HF Tokenizers library. These fast tokenizers are available for almost all models, but if you get an error with the previous call, remove the argument.</p>
<p>To preprocess the dataset, you need the names of the columns containing the sentence(s). The following dictionary keeps track of the correspondence task to column names:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">task_to_keys</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;cola&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;sentence&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s2">&quot;mnli&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;premise&quot;</span><span class="p">,</span> <span class="s2">&quot;hypothesis&quot;</span><span class="p">),</span>
    <span class="s2">&quot;mnli-mm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;premise&quot;</span><span class="p">,</span> <span class="s2">&quot;hypothesis&quot;</span><span class="p">),</span>
    <span class="s2">&quot;mrpc&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;sentence1&quot;</span><span class="p">,</span> <span class="s2">&quot;sentence2&quot;</span><span class="p">),</span>
    <span class="s2">&quot;qnli&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;question&quot;</span><span class="p">,</span> <span class="s2">&quot;sentence&quot;</span><span class="p">),</span>
    <span class="s2">&quot;qqp&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;question1&quot;</span><span class="p">,</span> <span class="s2">&quot;question2&quot;</span><span class="p">),</span>
    <span class="s2">&quot;rte&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;sentence1&quot;</span><span class="p">,</span> <span class="s2">&quot;sentence2&quot;</span><span class="p">),</span>
    <span class="s2">&quot;sst2&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;sentence&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
    <span class="s2">&quot;stsb&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;sentence1&quot;</span><span class="p">,</span> <span class="s2">&quot;sentence2&quot;</span><span class="p">),</span>
    <span class="s2">&quot;wnli&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;sentence1&quot;</span><span class="p">,</span> <span class="s2">&quot;sentence2&quot;</span><span class="p">),</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Instead of using HF Dataset objects directly, convert them to <a class="reference internal" href="../../../data/data.html#data"><span class="std std-ref">Ray Data</span></a>. Arrow tables back both of them, so the conversion is straightforward. Use the built-in <a class="reference internal" href="../../../data/api/doc/ray.data.from_huggingface.html#ray.data.from_huggingface" title="ray.data.from_huggingface"><code class="xref py py-meth docutils literal notranslate"><span class="pre">from_huggingface()</span></code></a> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ray.data</span>

<span class="n">ray_datasets</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">from_huggingface</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]),</span>
    <span class="s2">&quot;validation&quot;</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">from_huggingface</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">]),</span>
    <span class="s2">&quot;test&quot;</span><span class="p">:</span> <span class="n">ray</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">from_huggingface</span><span class="p">(</span><span class="n">datasets</span><span class="p">[</span><span class="s2">&quot;test&quot;</span><span class="p">]),</span>
<span class="p">}</span>
<span class="n">ray_datasets</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;train&#39;: MaterializedDataset(
    num_blocks=1,
    num_rows=8551,
    schema={sentence: string, label: int64, idx: int32}
 ),
 &#39;validation&#39;: MaterializedDataset(
    num_blocks=1,
    num_rows=1043,
    schema={sentence: string, label: int64, idx: int32}
 ),
 &#39;test&#39;: MaterializedDataset(
    num_blocks=1,
    num_rows=1063,
    schema={sentence: string, label: int64, idx: int32}
 )}
</pre></div>
</div>
</div>
</div>
<p>You can then write the function that preprocesses the samples. Feed them to the <code class="docutils literal notranslate"><span class="pre">tokenizer</span></code> with the argument <code class="docutils literal notranslate"><span class="pre">truncation=True</span></code>. This configuration ensures that the <code class="docutils literal notranslate"><span class="pre">tokenizer</span></code> truncates and pads to the longest sequence in the batch, any input longer than what the model selected can handle.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>


<span class="c1"># Tokenize input sentences</span>
<span class="k">def</span> <span class="nf">collate_fn</span><span class="p">(</span><span class="n">examples</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">]):</span>
    <span class="n">sentence1_key</span><span class="p">,</span> <span class="n">sentence2_key</span> <span class="o">=</span> <span class="n">task_to_keys</span><span class="p">[</span><span class="n">task</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">sentence2_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">examples</span><span class="p">[</span><span class="n">sentence1_key</span><span class="p">]),</span>
            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;longest&quot;</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">examples</span><span class="p">[</span><span class="n">sentence1_key</span><span class="p">]),</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">examples</span><span class="p">[</span><span class="n">sentence2_key</span><span class="p">]),</span>
            <span class="n">truncation</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">padding</span><span class="o">=</span><span class="s2">&quot;longest&quot;</span><span class="p">,</span>
            <span class="n">return_tensors</span><span class="o">=</span><span class="s2">&quot;pt&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">examples</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">])</span>

    <span class="c1"># Move all input tensors to GPU</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">outputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">outputs</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="fine-tuning-the-model-with-ray-train-a-name-train-a">
<h3>Fine-tuning the model with Ray Train <a name="train"></a><a class="headerlink" href="#fine-tuning-the-model-with-ray-train-a-name-train-a" title="Permalink to this headline">#</a></h3>
<p>Now that the data is ready, download the pretrained model and fine-tune it.</p>
<p>Because all of the tasks involve sentence classification, use the <code class="docutils literal notranslate"><span class="pre">AutoModelForSequenceClassification</span></code> class. For more specifics about each individual training component, see the <a class="reference external" href="https://github.com/huggingface/notebooks/blob/6ca682955173cc9d36ffa431ddda505a048cbe80/examples/text_classification.ipynb">original notebook</a>. The original notebook uses the same tokenizer used to encode the dataset in this notebook’s preceding example.</p>
<p>The main difference when using Ray Train is that you need to define the training logic as a function (<code class="docutils literal notranslate"><span class="pre">train_func</span></code>). You pass this <a class="reference internal" href="../../overview.html#train-overview-training-function"><span class="std std-ref">training function</span></a> to the <a class="reference internal" href="../../api/doc/ray.train.torch.TorchTrainer.html#ray.train.torch.TorchTrainer" title="ray.train.torch.TorchTrainer"><code class="xref py py-class docutils literal notranslate"><span class="pre">TorchTrainer</span></code></a> to on every Ray worker. The training then proceeds using PyTorch DDP.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Be sure to initialize the model, metric, and tokenizer within the function. Otherwise, you may encounter serialization errors.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">datasets</span> <span class="kn">import</span> <span class="n">load_metric</span>
<span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span><span class="p">,</span> <span class="n">TrainingArguments</span><span class="p">,</span> <span class="n">Trainer</span>

<span class="kn">import</span> <span class="nn">ray.train</span>
<span class="kn">from</span> <span class="nn">ray.train.huggingface.transformers</span> <span class="kn">import</span> <span class="n">prepare_trainer</span><span class="p">,</span> <span class="n">RayTrainReportCallback</span>

<span class="n">num_labels</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;mnli&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;stsb&quot;</span> <span class="k">else</span> <span class="mi">2</span>
<span class="n">metric_name</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;pearson&quot;</span>
    <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;stsb&quot;</span>
    <span class="k">else</span> <span class="s2">&quot;matthews_correlation&quot;</span>
    <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;cola&quot;</span>
    <span class="k">else</span> <span class="s2">&quot;accuracy&quot;</span>
<span class="p">)</span>
<span class="n">model_name</span> <span class="o">=</span> <span class="n">model_checkpoint</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">validation_key</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;validation_mismatched&quot;</span>
    <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;mnli-mm&quot;</span>
    <span class="k">else</span> <span class="s2">&quot;validation_matched&quot;</span>
    <span class="k">if</span> <span class="n">task</span> <span class="o">==</span> <span class="s2">&quot;mnli&quot;</span>
    <span class="k">else</span> <span class="s2">&quot;validation&quot;</span>
<span class="p">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">-finetuned-</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="c1"># Calculate the maximum steps per epoch based on the number of rows in the training dataset.</span>
<span class="c1"># Make sure to scale by the total number of training workers and the per device batch size.</span>
<span class="n">max_steps_per_epoch</span> <span class="o">=</span> <span class="n">ray_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">//</span> <span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">num_workers</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">train_func</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Is CUDA available: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">metric</span> <span class="o">=</span> <span class="n">load_metric</span><span class="p">(</span><span class="s2">&quot;glue&quot;</span><span class="p">,</span> <span class="n">actual_task</span><span class="p">)</span>
    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="n">model_checkpoint</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span>
        <span class="n">model_checkpoint</span><span class="p">,</span> <span class="n">num_labels</span><span class="o">=</span><span class="n">num_labels</span>
    <span class="p">)</span>

    <span class="n">train_ds</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">get_dataset_shard</span><span class="p">(</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
    <span class="n">eval_ds</span> <span class="o">=</span> <span class="n">ray</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">get_dataset_shard</span><span class="p">(</span><span class="s2">&quot;eval&quot;</span><span class="p">)</span>

    <span class="n">train_ds_iterable</span> <span class="o">=</span> <span class="n">train_ds</span><span class="o">.</span><span class="n">iter_torch_batches</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span>
    <span class="p">)</span>
    <span class="n">eval_ds_iterable</span> <span class="o">=</span> <span class="n">eval_ds</span><span class="o">.</span><span class="n">iter_torch_batches</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;max_steps_per_epoch: &quot;</span><span class="p">,</span> <span class="n">max_steps_per_epoch</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">TrainingArguments</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">evaluation_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
        <span class="n">save_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
        <span class="n">logging_strategy</span><span class="o">=</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
        <span class="n">per_device_train_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">per_device_eval_batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span>
        <span class="n">learning_rate</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="mf">2e-5</span><span class="p">),</span>
        <span class="n">num_train_epochs</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;epochs&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">weight_decay</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;weight_decay&quot;</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">),</span>
        <span class="n">push_to_hub</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">max_steps</span><span class="o">=</span><span class="n">max_steps_per_epoch</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;epochs&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">disable_tqdm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># declutter the output a little</span>
        <span class="n">no_cuda</span><span class="o">=</span><span class="ow">not</span> <span class="n">use_gpu</span><span class="p">,</span>  <span class="c1"># you need to explicitly set no_cuda if you want CPUs</span>
        <span class="n">report_to</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_metrics</span><span class="p">(</span><span class="n">eval_pred</span><span class="p">):</span>
        <span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">eval_pred</span>
        <span class="k">if</span> <span class="n">task</span> <span class="o">!=</span> <span class="s2">&quot;stsb&quot;</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">metric</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">references</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>

    <span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span>
        <span class="n">args</span><span class="p">,</span>
        <span class="n">train_dataset</span><span class="o">=</span><span class="n">train_ds_iterable</span><span class="p">,</span>
        <span class="n">eval_dataset</span><span class="o">=</span><span class="n">eval_ds_iterable</span><span class="p">,</span>
        <span class="n">tokenizer</span><span class="o">=</span><span class="n">tokenizer</span><span class="p">,</span>
        <span class="n">compute_metrics</span><span class="o">=</span><span class="n">compute_metrics</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">trainer</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">RayTrainReportCallback</span><span class="p">())</span>

    <span class="n">trainer</span> <span class="o">=</span> <span class="n">prepare_trainer</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting training&quot;</span><span class="p">)</span>
    <span class="n">trainer</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-09-06 14:25:28.144428: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F AVX512_VNNI FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
2023-09-06 14:25:28.284936: I tensorflow/core/util/port.cc:104] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2023-09-06 14:25:29.025734: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer.so.7&#39;; dlerror: libnvinfer.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /usr/local/nvidia/lib:/usr/local/nvidia/lib64
2023-09-06 14:25:29.025801: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer_plugin.so.7&#39;; dlerror: libnvinfer_plugin.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /usr/local/nvidia/lib:/usr/local/nvidia/lib64
2023-09-06 14:25:29.025807: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Cannot dlopen some TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please make sure the missing libraries mentioned above are installed properly.
comet_ml is installed but `COMET_API_KEY` is not set.
</pre></div>
</div>
</div>
</div>
<p>With your <code class="docutils literal notranslate"><span class="pre">train_func</span></code> complete, you can now instantiate the <a class="reference internal" href="../../api/doc/ray.train.torch.TorchTrainer.html#ray.train.torch.TorchTrainer" title="ray.train.torch.TorchTrainer"><code class="xref py py-class docutils literal notranslate"><span class="pre">TorchTrainer</span></code></a>. Aside from calling the function, set the <code class="docutils literal notranslate"><span class="pre">scaling_config</span></code>, which controls the amount of workers and resources used, and the <code class="docutils literal notranslate"><span class="pre">datasets</span></code> to use for training and evaluation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray.train.torch</span> <span class="kn">import</span> <span class="n">TorchTrainer</span>
<span class="kn">from</span> <span class="nn">ray.train</span> <span class="kn">import</span> <span class="n">RunConfig</span><span class="p">,</span> <span class="n">ScalingConfig</span><span class="p">,</span> <span class="n">CheckpointConfig</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">TorchTrainer</span><span class="p">(</span>
    <span class="n">train_func</span><span class="p">,</span>
    <span class="n">scaling_config</span><span class="o">=</span><span class="n">ScalingConfig</span><span class="p">(</span><span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span> <span class="n">use_gpu</span><span class="o">=</span><span class="n">use_gpu</span><span class="p">),</span>
    <span class="n">datasets</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">ray_datasets</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">],</span>
        <span class="s2">&quot;eval&quot;</span><span class="p">:</span> <span class="n">ray_datasets</span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">run_config</span><span class="o">=</span><span class="n">RunConfig</span><span class="p">(</span>
        <span class="n">checkpoint_config</span><span class="o">=</span><span class="n">CheckpointConfig</span><span class="p">(</span>
            <span class="n">num_to_keep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">checkpoint_score_attribute</span><span class="o">=</span><span class="s2">&quot;eval_loss&quot;</span><span class="p">,</span>
            <span class="n">checkpoint_score_order</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, call the <code class="docutils literal notranslate"><span class="pre">fit</span></code> method to start training with Ray Train. Save the <code class="docutils literal notranslate"><span class="pre">Result</span></code> object to a variable so you can access metrics and checkpoints.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="tuneStatus">
  <div style="display: flex;flex-direction: row">
    <div style="display: flex;flex-direction: column;">
      <h3>Tune Status</h3>
      <table>
<tbody>
<tr><td>Current time:</td><td>2023-09-06 14:27:12</td></tr>
<tr><td>Running for: </td><td>00:01:40.12        </td></tr>
<tr><td>Memory:      </td><td>18.4/186.6 GiB     </td></tr>
</tbody>
</table>
    </div>
    <div class="vDivider"></div>
    <div class="systemInfo">
      <h3>System Info</h3>
      Using FIFO scheduling algorithm.<br>Logical resource usage: 1.0/48 CPUs, 1.0/4 GPUs (0.0/1.0 accelerator_type:None)
    </div>

  </div>
  <div class="hDivider"></div>
  <div class="trialStatus">
    <h3>Trial Status</h3>
    <table>
<thead>
<tr><th>Trial name              </th><th>status    </th><th>loc              </th><th style="text-align: right;">  iter</th><th style="text-align: right;">  total time (s)</th><th style="text-align: right;">  loss</th><th style="text-align: right;">  learning_rate</th><th style="text-align: right;">  epoch</th></tr>
</thead>
<tbody>
<tr><td>TorchTrainer_e8bd4_00000</td><td>TERMINATED</td><td>10.0.27.125:43821</td><td style="text-align: right;">     2</td><td style="text-align: right;">         76.6259</td><td style="text-align: right;">0.3866</td><td style="text-align: right;">              0</td><td style="text-align: right;">    1.5</td></tr>
</tbody>
</table>
  </div>
</div>
<style>
.tuneStatus {
  color: var(--jp-ui-font-color1);
}
.tuneStatus .systemInfo {
  display: flex;
  flex-direction: column;
}
.tuneStatus td {
  white-space: nowrap;
}
.tuneStatus .trialStatus {
  display: flex;
  flex-direction: column;
}
.tuneStatus h3 {
  font-weight: bold;
}
.tuneStatus .hDivider {
  border-bottom-width: var(--jp-border-width);
  border-bottom-color: var(--jp-border-color0);
  border-bottom-style: solid;
}
.tuneStatus .vDivider {
  border-left-width: var(--jp-border-width);
  border-left-color: var(--jp-border-color0);
  border-left-style: solid;
  margin: 0.5em 1em 0.5em 1em;
}
</style>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=43821)</span> 2023-09-06 14:25:35.638885: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F AVX512_VNNI FMA
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=43821)</span> To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=43821)</span> 2023-09-06 14:25:35.782950: I tensorflow/core/util/port.cc:104] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=43821)</span> 2023-09-06 14:25:36.501583: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer.so.7&#39;; dlerror: libnvinfer.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /usr/local/nvidia/lib:/usr/local/nvidia/lib64
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=43821)</span> 2023-09-06 14:25:36.501653: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer_plugin.so.7&#39;; dlerror: libnvinfer_plugin.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /usr/local/nvidia/lib:/usr/local/nvidia/lib64
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=43821)</span> 2023-09-06 14:25:36.501660: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Cannot dlopen some TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please make sure the missing libraries mentioned above are installed properly.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=43821)</span> comet_ml is installed but `COMET_API_KEY` is not set.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TorchTrainer pid=43821)</span> Starting distributed worker processes: [&#39;43946 (10.0.27.125)&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Setting up process group for: env:// [rank=0, world_size=1]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> 2023-09-06 14:25:42.756510: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F AVX512_VNNI FMA
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> 2023-09-06 14:25:42.903398: I tensorflow/core/util/port.cc:104] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44017)</span> Auto configuring locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> 2023-09-06 14:25:43.737476: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer.so.7&#39;; dlerror: libnvinfer.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /usr/local/nvidia/lib:/usr/local/nvidia/lib64
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> 2023-09-06 14:25:43.737544: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer_plugin.so.7&#39;; dlerror: libnvinfer_plugin.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /usr/local/nvidia/lib:/usr/local/nvidia/lib64
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> 2023-09-06 14:25:43.737554: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Cannot dlopen some TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please make sure the missing libraries mentioned above are installed properly.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> comet_ml is installed but `COMET_API_KEY` is not set.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Is CUDA available: True
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Some weights of the model checkpoint at distilbert-base-uncased were not used when initializing DistilBertForSequenceClassification: [&#39;vocab_transform.weight&#39;, &#39;vocab_layer_norm.bias&#39;, &#39;vocab_projector.bias&#39;, &#39;vocab_transform.bias&#39;, &#39;vocab_layer_norm.weight&#39;, &#39;vocab_projector.weight&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> - This IS expected if you are initializing DistilBertForSequenceClassification from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> - This IS NOT expected if you are initializing DistilBertForSequenceClassification from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Some weights of DistilBertForSequenceClassification were not initialized from the model checkpoint at distilbert-base-uncased and are newly initialized: [&#39;classifier.weight&#39;, &#39;classifier.bias&#39;, &#39;pre_classifier.bias&#39;, &#39;pre_classifier.weight&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44016)</span> Auto configuring locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> max_steps_per_epoch:  534
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> max_steps is given, it will override any value given in num_train_epochs
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> /home/ray/anaconda3/lib/python3.9/site-packages/transformers/optimization.py:306: FutureWarning: This implementation of AdamW is deprecated and will be removed in a future version. Use the PyTorch implementation torch.optim.AdamW instead, or set `no_deprecation_warning=True` to disable this warning
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span>   warnings.warn(
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Starting training
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> ***** Running training *****
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span>   Num examples = 17088
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span>   Num Epochs = 9223372036854775807
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span>   Instantaneous batch size per device = 16
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span>   Total train batch size (w. parallel, distributed &amp; accumulation) = 16
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span>   Gradient Accumulation steps = 1
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span>   Total optimization steps = 1068
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> /tmp/ipykernel_43503/4088900328.py:23: UserWarning: The given NumPy array is not writable, and PyTorch does not support non-writable tensors. This means writing to this tensor will result in undefined behavior. You may want to copy the array to protect its data or make it writable before converting it to a tensor. This type of warning will be suppressed for the rest of this program. (Triggered internally at ../torch/csrc/utils/tensor_numpy.cpp:206.)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44016)</span> Executing DAG InputDataBuffer[Input] -&gt; OutputSplitter[split(1, equal=True)]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44016)</span> Execution config: ExecutionOptions(resource_limits=ExecutionResources(cpu=None, gpu=None, object_store_memory=None), locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;], preserve_order=False, actor_locality_enabled=True, verbose_progress=False)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44016)</span> Tip: For detailed progress reporting, run `ray.data.DataContext.get_current().execution_options.verbose_progress = True`
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> [W reducer.cpp:1300] Warning: find_unused_parameters=True was specified in DDP constructor, but did not find any unused parameters in the forward pass. This flag results in an extra traversal of the autograd graph every iteration,  which can adversely affect performance. If your model indeed never has any unused parameters in the forward pass, consider turning this flag off. Note that this warning may be a false positive if your model has flow control causing later iterations to have unused parameters. (function operator())
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> {&#39;loss&#39;: 0.5414, &#39;learning_rate&#39;: 9.9812734082397e-06, &#39;epoch&#39;: 0.5}
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> ***** Running Evaluation *****
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span>   Num examples: Unknown
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span>   Batch size = 16
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44017)</span> Executing DAG InputDataBuffer[Input] -&gt; OutputSplitter[split(1, equal=True)]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44017)</span> Execution config: ExecutionOptions(resource_limits=ExecutionResources(cpu=None, gpu=None, object_store_memory=None), locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;], preserve_order=False, actor_locality_enabled=True, verbose_progress=False)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44017)</span> Tip: For detailed progress reporting, run `ray.data.DataContext.get_current().execution_options.verbose_progress = True`
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Saving model checkpoint to distilbert-base-uncased-finetuned-cola/checkpoint-535
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Configuration saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/config.json
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> {&#39;eval_loss&#39;: 0.5018134117126465, &#39;eval_matthews_correlation&#39;: 0.4145623770066859, &#39;eval_runtime&#39;: 0.6595, &#39;eval_samples_per_second&#39;: 1581.584, &#39;eval_steps_per_second&#39;: 100.081, &#39;epoch&#39;: 0.5}
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Model weights saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/pytorch_model.bin
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> tokenizer config file saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/tokenizer_config.json
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Special tokens file saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/special_tokens_map.json
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Checkpoint successfully created at: Checkpoint(filesystem=local, path=/mnt/cluster_storage/ray_results/TorchTrainer_2023-09-06_14-25-31/TorchTrainer_e8bd4_00000_0_2023-09-06_14-25-32/checkpoint_000000)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44016)</span> Executing DAG InputDataBuffer[Input] -&gt; OutputSplitter[split(1, equal=True)]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44016)</span> Execution config: ExecutionOptions(resource_limits=ExecutionResources(cpu=None, gpu=None, object_store_memory=None), locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;], preserve_order=False, actor_locality_enabled=True, verbose_progress=False)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44016)</span> Tip: For detailed progress reporting, run `ray.data.DataContext.get_current().execution_options.verbose_progress = True`
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> {&#39;loss&#39;: 0.3866, &#39;learning_rate&#39;: 0.0, &#39;epoch&#39;: 1.5}
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> ***** Running Evaluation *****
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span>   Num examples: Unknown
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span>   Batch size = 16
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44017)</span> Executing DAG InputDataBuffer[Input] -&gt; OutputSplitter[split(1, equal=True)]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44017)</span> Execution config: ExecutionOptions(resource_limits=ExecutionResources(cpu=None, gpu=None, object_store_memory=None), locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;], preserve_order=False, actor_locality_enabled=True, verbose_progress=False)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=44017)</span> Tip: For detailed progress reporting, run `ray.data.DataContext.get_current().execution_options.verbose_progress = True`
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Saving model checkpoint to distilbert-base-uncased-finetuned-cola/checkpoint-1068
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Configuration saved in distilbert-base-uncased-finetuned-cola/checkpoint-1068/config.json
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> {&#39;eval_loss&#39;: 0.5527923107147217, &#39;eval_matthews_correlation&#39;: 0.44860917123689154, &#39;eval_runtime&#39;: 0.6646, &#39;eval_samples_per_second&#39;: 1569.42, &#39;eval_steps_per_second&#39;: 99.311, &#39;epoch&#39;: 1.5}
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Model weights saved in distilbert-base-uncased-finetuned-cola/checkpoint-1068/pytorch_model.bin
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> tokenizer config file saved in distilbert-base-uncased-finetuned-cola/checkpoint-1068/tokenizer_config.json
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Special tokens file saved in distilbert-base-uncased-finetuned-cola/checkpoint-1068/special_tokens_map.json
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Checkpoint successfully created at: Checkpoint(filesystem=local, path=/mnt/cluster_storage/ray_results/TorchTrainer_2023-09-06_14-25-31/TorchTrainer_e8bd4_00000_0_2023-09-06_14-25-32/checkpoint_000001)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> Training completed. Do not forget to share your model on huggingface.co/models =)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=43946)</span> {&#39;train_runtime&#39;: 66.0485, &#39;train_samples_per_second&#39;: 258.719, &#39;train_steps_per_second&#39;: 16.17, &#39;train_loss&#39;: 0.46413421630859375, &#39;epoch&#39;: 1.5}
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-09-06 14:27:12,180	WARNING experiment_state.py:371 -- Experiment checkpoint syncing has been triggered multiple times in the last 30.0 seconds. A sync will be triggered whenever a trial has checkpointed more than `num_to_keep` times since last sync or if 300 seconds have passed since last sync. If you have set `num_to_keep` in your `CheckpointConfig`, consider increasing the checkpoint frequency or keeping more checkpoints. You can supress this warning by changing the `TUNE_WARN_EXCESSIVE_EXPERIMENT_CHECKPOINT_SYNC_THRESHOLD_S` environment variable.
2023-09-06 14:27:12,184	INFO tune.py:1141 -- Total run time: 100.17 seconds (85.12 seconds for the tuning loop).
</pre></div>
</div>
</div>
</div>
<p>You can use the returned <code class="docutils literal notranslate"><span class="pre">Result</span></code> object to access metrics and the Ray Train <code class="docutils literal notranslate"><span class="pre">Checkpoint</span></code> associated with the last iteration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Result(
  metrics={&#39;loss&#39;: 0.3866, &#39;learning_rate&#39;: 0.0, &#39;epoch&#39;: 1.5, &#39;step&#39;: 1068, &#39;eval_loss&#39;: 0.5527923107147217, &#39;eval_matthews_correlation&#39;: 0.44860917123689154, &#39;eval_runtime&#39;: 0.6646, &#39;eval_samples_per_second&#39;: 1569.42, &#39;eval_steps_per_second&#39;: 99.311},
  path=&#39;/mnt/cluster_storage/ray_results/TorchTrainer_2023-09-06_14-25-31/TorchTrainer_e8bd4_00000_0_2023-09-06_14-25-32&#39;,
  filesystem=&#39;local&#39;,
  checkpoint=Checkpoint(filesystem=local, path=/mnt/cluster_storage/ray_results/TorchTrainer_2023-09-06_14-25-31/TorchTrainer_e8bd4_00000_0_2023-09-06_14-25-32/checkpoint_000001)
)
</pre></div>
</div>
</div>
</div>
</section>
<section id="tune-hyperparameters-with-ray-tune-a-name-predict-a">
<h3>Tune hyperparameters with Ray Tune <a name="predict"></a><a class="headerlink" href="#tune-hyperparameters-with-ray-tune-a-name-predict-a" title="Permalink to this headline">#</a></h3>
<p>To tune any hyperparameters of the model, pass your <code class="docutils literal notranslate"><span class="pre">TorchTrainer</span></code> into a <code class="docutils literal notranslate"><span class="pre">Tuner</span></code> and define the search space.</p>
<p>You can also take advantage of the advanced search algorithms and schedulers from Ray Tune. This example uses an <code class="docutils literal notranslate"><span class="pre">ASHAScheduler</span></code> to aggresively terminate underperforming trials.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray</span> <span class="kn">import</span> <span class="n">tune</span>
<span class="kn">from</span> <span class="nn">ray.tune</span> <span class="kn">import</span> <span class="n">Tuner</span>
<span class="kn">from</span> <span class="nn">ray.tune.schedulers.async_hyperband</span> <span class="kn">import</span> <span class="n">ASHAScheduler</span>

<span class="n">tune_epochs</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">tuner</span> <span class="o">=</span> <span class="n">Tuner</span><span class="p">(</span>
    <span class="n">trainer</span><span class="p">,</span>
    <span class="n">param_space</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;train_loop_config&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="n">tune</span><span class="o">.</span><span class="n">grid_search</span><span class="p">([</span><span class="mf">2e-5</span><span class="p">,</span> <span class="mf">2e-4</span><span class="p">,</span> <span class="mf">2e-3</span><span class="p">,</span> <span class="mf">2e-2</span><span class="p">]),</span>
            <span class="s2">&quot;epochs&quot;</span><span class="p">:</span> <span class="n">tune_epochs</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="n">tune_config</span><span class="o">=</span><span class="n">tune</span><span class="o">.</span><span class="n">TuneConfig</span><span class="p">(</span>
        <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;eval_loss&quot;</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
        <span class="n">num_samples</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">scheduler</span><span class="o">=</span><span class="n">ASHAScheduler</span><span class="p">(</span>
            <span class="n">max_t</span><span class="o">=</span><span class="n">tune_epochs</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
    <span class="n">run_config</span><span class="o">=</span><span class="n">RunConfig</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;tune_transformers&quot;</span><span class="p">,</span>
        <span class="n">checkpoint_config</span><span class="o">=</span><span class="n">CheckpointConfig</span><span class="p">(</span>
            <span class="n">num_to_keep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">checkpoint_score_attribute</span><span class="o">=</span><span class="s2">&quot;eval_loss&quot;</span><span class="p">,</span>
            <span class="n">checkpoint_score_order</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-09-06 14:46:47,821	INFO tuner_internal.py:508 -- A `RunConfig` was passed to both the `Tuner` and the `TorchTrainer`. The run config passed to the `Tuner` is the one that will be used.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tune_results</span> <span class="o">=</span> <span class="n">tuner</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="tuneStatus">
  <div style="display: flex;flex-direction: row">
    <div style="display: flex;flex-direction: column;">
      <h3>Tune Status</h3>
      <table>
<tbody>
<tr><td>Current time:</td><td>2023-09-06 14:49:04</td></tr>
<tr><td>Running for: </td><td>00:02:16.18        </td></tr>
<tr><td>Memory:      </td><td>19.6/186.6 GiB     </td></tr>
</tbody>
</table>
    </div>
    <div class="vDivider"></div>
    <div class="systemInfo">
      <h3>System Info</h3>
      Using AsyncHyperBand: num_stopped=4<br>Bracket: Iter 4.000: -0.6517604142427444 | Iter 1.000: -0.5936744660139084<br>Logical resource usage: 1.0/48 CPUs, 1.0/4 GPUs (0.0/1.0 accelerator_type:None)
    </div>

  </div>
  <div class="hDivider"></div>
  <div class="trialStatus">
    <h3>Trial Status</h3>
    <table>
<thead>
<tr><th>Trial name              </th><th>status    </th><th>loc              </th><th style="text-align: right;">       train_loop_config/le
arning_rate</th><th style="text-align: right;">  iter</th><th style="text-align: right;">  total time (s)</th><th style="text-align: right;">  loss</th><th style="text-align: right;">  learning_rate</th><th style="text-align: right;">  epoch</th></tr>
</thead>
<tbody>
<tr><td>TorchTrainer_e1825_00000</td><td>TERMINATED</td><td>10.0.27.125:57496</td><td style="text-align: right;">2e-05 </td><td style="text-align: right;">     4</td><td style="text-align: right;">        128.443 </td><td style="text-align: right;">0.1934</td><td style="text-align: right;">    0          </td><td style="text-align: right;">   3.25</td></tr>
<tr><td>TorchTrainer_e1825_00001</td><td>TERMINATED</td><td>10.0.27.125:57497</td><td style="text-align: right;">0.0002</td><td style="text-align: right;">     1</td><td style="text-align: right;">         41.2486</td><td style="text-align: right;">0.616 </td><td style="text-align: right;">    0.000149906</td><td style="text-align: right;">   0.25</td></tr>
<tr><td>TorchTrainer_e1825_00002</td><td>TERMINATED</td><td>10.0.27.125:57498</td><td style="text-align: right;">0.002 </td><td style="text-align: right;">     1</td><td style="text-align: right;">         41.1336</td><td style="text-align: right;">0.6699</td><td style="text-align: right;">    0.00149906 </td><td style="text-align: right;">   0.25</td></tr>
<tr><td>TorchTrainer_e1825_00003</td><td>TERMINATED</td><td>10.0.27.125:57499</td><td style="text-align: right;">0.02  </td><td style="text-align: right;">     4</td><td style="text-align: right;">        126.699 </td><td style="text-align: right;">0.6073</td><td style="text-align: right;">    0          </td><td style="text-align: right;">   3.25</td></tr>
</tbody>
</table>
  </div>
</div>
<style>
.tuneStatus {
  color: var(--jp-ui-font-color1);
}
.tuneStatus .systemInfo {
  display: flex;
  flex-direction: column;
}
.tuneStatus td {
  white-space: nowrap;
}
.tuneStatus .trialStatus {
  display: flex;
  flex-direction: column;
}
.tuneStatus h3 {
  font-weight: bold;
}
.tuneStatus .hDivider {
  border-bottom-width: var(--jp-border-width);
  border-bottom-color: var(--jp-border-color0);
  border-bottom-style: solid;
}
.tuneStatus .vDivider {
  border-left-width: var(--jp-border-width);
  border-left-color: var(--jp-border-color0);
  border-left-style: solid;
  margin: 0.5em 1em 0.5em 1em;
}
</style>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57498)</span> 2023-09-06 14:46:52.049839: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F AVX512_VNNI FMA
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57498)</span> To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57498)</span> 2023-09-06 14:46:52.195780: I tensorflow/core/util/port.cc:104] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57498)</span> 2023-09-06 14:46:52.944517: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer.so.7&#39;; dlerror: libnvinfer.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /usr/local/nvidia/lib:/usr/local/nvidia/lib64
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57498)</span> 2023-09-06 14:46:52.944590: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer_plugin.so.7&#39;; dlerror: libnvinfer_plugin.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /usr/local/nvidia/lib:/usr/local/nvidia/lib64
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57498)</span> 2023-09-06 14:46:52.944597: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Cannot dlopen some TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please make sure the missing libraries mentioned above are installed properly.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57498)</span> comet_ml is installed but `COMET_API_KEY` is not set.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TorchTrainer pid=57498)</span> Starting distributed worker processes: [&#39;57731 (10.0.27.125)&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57499)</span> 2023-09-06 14:46:52.229406: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F AVX512_VNNI FMA<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57499)</span> To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57499)</span> 2023-09-06 14:46:52.378805: I tensorflow/core/util/port.cc:104] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Setting up process group for: env:// [rank=0, world_size=1]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57499)</span> 2023-09-06 14:46:53.174151: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer_plugin.so.7&#39;; dlerror: libnvinfer_plugin.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /usr/local/nvidia/lib:/usr/local/nvidia/lib64<span class=" -Color -Color-Green"> [repeated 6x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57499)</span> 2023-09-06 14:46:53.174160: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Cannot dlopen some TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please make sure the missing libraries mentioned above are installed properly.<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TrainTrainable pid=57499)</span> comet_ml is installed but `COMET_API_KEY` is not set.<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57927)</span> Auto configuring locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Is CUDA available: True
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> max_steps_per_epoch:  534
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Some weights of the model checkpoint at distilbert-base-uncased were not used when initializing DistilBertForSequenceClassification: [&#39;vocab_projector.bias&#39;, &#39;vocab_projector.weight&#39;, &#39;vocab_transform.weight&#39;, &#39;vocab_layer_norm.bias&#39;, &#39;vocab_layer_norm.weight&#39;, &#39;vocab_transform.bias&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> - This IS expected if you are initializing DistilBertForSequenceClassification from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> - This IS NOT expected if you are initializing DistilBertForSequenceClassification from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Some weights of DistilBertForSequenceClassification were not initialized from the model checkpoint at distilbert-base-uncased and are newly initialized: [&#39;classifier.bias&#39;, &#39;pre_classifier.weight&#39;, &#39;classifier.weight&#39;, &#39;pre_classifier.bias&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(TorchTrainer pid=57499)</span> Starting distributed worker processes: [&#39;57746 (10.0.27.125)&#39;]<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> 2023-09-06 14:47:00.036649: I tensorflow/core/platform/cpu_feature_guard.cc:193] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F AVX512_VNNI FMA<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> 2023-09-06 14:47:00.198894: I tensorflow/core/util/port.cc:104] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> Setting up process group for: env:// [rank=0, world_size=1]<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> 2023-09-06 14:47:01.085704: W tensorflow/compiler/xla/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library &#39;libnvinfer_plugin.so.7&#39;; dlerror: libnvinfer_plugin.so.7: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /usr/local/nvidia/lib:/usr/local/nvidia/lib64<span class=" -Color -Color-Green"> [repeated 8x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> 2023-09-06 14:47:01.085711: W tensorflow/compiler/tf2tensorrt/utils/py_utils.cc:38] TF-TRT Warning: Cannot dlopen some TensorRT libraries. If you would like to use Nvidia GPU with TensorRT, please make sure the missing libraries mentioned above are installed properly.<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> comet_ml is installed but `COMET_API_KEY` is not set.<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57965)</span> Auto configuring locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;]<span class=" -Color -Color-Green"> [repeated 7x across cluster]</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Starting training
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> max_steps is given, it will override any value given in num_train_epochs
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> /home/ray/anaconda3/lib/python3.9/site-packages/transformers/optimization.py:306: FutureWarning: This implementation of AdamW is deprecated and will be removed in a future version. Use the PyTorch implementation torch.optim.AdamW instead, or set `no_deprecation_warning=True` to disable this warning
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span>   warnings.warn(
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> Some weights of the model checkpoint at distilbert-base-uncased were not used when initializing DistilBertForSequenceClassification: [&#39;vocab_layer_norm.weight&#39;, &#39;vocab_transform.weight&#39;, &#39;vocab_layer_norm.bias&#39;, &#39;vocab_projector.weight&#39;, &#39;vocab_projector.bias&#39;, &#39;vocab_transform.bias&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> Some weights of DistilBertForSequenceClassification were not initialized from the model checkpoint at distilbert-base-uncased and are newly initialized: [&#39;classifier.weight&#39;, &#39;pre_classifier.weight&#39;, &#39;classifier.bias&#39;, &#39;pre_classifier.bias&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57731)</span> Some weights of the model checkpoint at distilbert-base-uncased were not used when initializing DistilBertForSequenceClassification: [&#39;vocab_transform.bias&#39;, &#39;vocab_layer_norm.weight&#39;, &#39;vocab_projector.bias&#39;, &#39;vocab_transform.weight&#39;, &#39;vocab_projector.weight&#39;, &#39;vocab_layer_norm.bias&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> Some weights of the model checkpoint at distilbert-base-uncased were not used when initializing DistilBertForSequenceClassification: [&#39;vocab_projector.bias&#39;, &#39;vocab_transform.bias&#39;, &#39;vocab_transform.weight&#39;, &#39;vocab_layer_norm.weight&#39;, &#39;vocab_layer_norm.bias&#39;, &#39;vocab_projector.weight&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> Some weights of DistilBertForSequenceClassification were not initialized from the model checkpoint at distilbert-base-uncased and are newly initialized: [&#39;pre_classifier.weight&#39;, &#39;pre_classifier.bias&#39;, &#39;classifier.bias&#39;, &#39;classifier.weight&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> ***** Running training *****
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span>   Num examples = 34176
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span>   Num Epochs = 9223372036854775807
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span>   Instantaneous batch size per device = 16
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span>   Total train batch size (w. parallel, distributed &amp; accumulation) = 16
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span>   Gradient Accumulation steps = 1
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span>   Total optimization steps = 2136
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> /tmp/ipykernel_43503/4088900328.py:23: UserWarning: The given NumPy array is not writable, and PyTorch does not support non-writable tensors. This means writing to this tensor will result in undefined behavior. You may want to copy the array to protect its data or make it writable before converting it to a tensor. This type of warning will be suppressed for the rest of this program. (Triggered internally at ../torch/csrc/utils/tensor_numpy.cpp:206.)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57927)</span> Executing DAG InputDataBuffer[Input] -&gt; OutputSplitter[split(1, equal=True)]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57927)</span> Execution config: ExecutionOptions(resource_limits=ExecutionResources(cpu=None, gpu=None, object_store_memory=None), locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;], preserve_order=False, actor_locality_enabled=True, verbose_progress=False)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57927)</span> Tip: For detailed progress reporting, run `ray.data.DataContext.get_current().execution_options.verbose_progress = True`
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> [W reducer.cpp:1300] Warning: find_unused_parameters=True was specified in DDP constructor, but did not find any unused parameters in the forward pass. This flag results in an extra traversal of the autograd graph every iteration,  which can adversely affect performance. If your model indeed never has any unused parameters in the forward pass, consider turning this flag off. Note that this warning may be a false positive if your model has flow control causing later iterations to have unused parameters. (function operator())
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> {&#39;loss&#39;: 0.5481, &#39;learning_rate&#39;: 1.4990636704119851e-05, &#39;epoch&#39;: 0.25}
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> Is CUDA available: True<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> max_steps_per_epoch:  534<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> Starting training<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> ***** Running Evaluation *****
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span>   Num examples: Unknown
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span>   Batch size = 16
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> - This IS expected if you are initializing DistilBertForSequenceClassification from the checkpoint of a model trained on another task or with another architecture (e.g. initializing a BertForSequenceClassification model from a BertForPreTraining model).<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> - This IS NOT expected if you are initializing DistilBertForSequenceClassification from the checkpoint of a model that you expect to be exactly identical (initializing a BertForSequenceClassification model from a BertForSequenceClassification model).<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57731)</span> Some weights of DistilBertForSequenceClassification were not initialized from the model checkpoint at distilbert-base-uncased and are newly initialized: [&#39;classifier.bias&#39;, &#39;pre_classifier.weight&#39;, &#39;classifier.weight&#39;, &#39;pre_classifier.bias&#39;]
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> You should probably TRAIN this model on a down-stream task to be able to use it for predictions and inference.<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> max_steps is given, it will override any value given in num_train_epochs<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> /home/ray/anaconda3/lib/python3.9/site-packages/transformers/optimization.py:306: FutureWarning: This implementation of AdamW is deprecated and will be removed in a future version. Use the PyTorch implementation torch.optim.AdamW instead, or set `no_deprecation_warning=True` to disable this warning<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span>   warnings.warn(<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> ***** Running training *****<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span>   Num examples = 34176<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span>   Num Epochs = 9223372036854775807<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span>   Instantaneous batch size per device = 16<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span>   Total train batch size (w. parallel, distributed &amp; accumulation) = 16<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span>   Gradient Accumulation steps = 1<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span>   Total optimization steps = 2136<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> /tmp/ipykernel_43503/4088900328.py:23: UserWarning: The given NumPy array is not writable, and PyTorch does not support non-writable tensors. This means writing to this tensor will result in undefined behavior. You may want to copy the array to protect its data or make it writable before converting it to a tensor. This type of warning will be suppressed for the rest of this program. (Triggered internally at ../torch/csrc/utils/tensor_numpy.cpp:206.)<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57965)</span> Executing DAG InputDataBuffer[Input] -&gt; OutputSplitter[split(1, equal=True)]<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57965)</span> Execution config: ExecutionOptions(resource_limits=ExecutionResources(cpu=None, gpu=None, object_store_memory=None), locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;], preserve_order=False, actor_locality_enabled=True, verbose_progress=False)<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57965)</span> Tip: For detailed progress reporting, run `ray.data.DataContext.get_current().execution_options.verbose_progress = True`<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> [W reducer.cpp:1300] Warning: find_unused_parameters=True was specified in DDP constructor, but did not find any unused parameters in the forward pass. This flag results in an extra traversal of the autograd graph every iteration,  which can adversely affect performance. If your model indeed never has any unused parameters in the forward pass, consider turning this flag off. Note that this warning may be a false positive if your model has flow control causing later iterations to have unused parameters. (function operator())<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> {&#39;eval_loss&#39;: 0.5202918648719788, &#39;eval_matthews_correlation&#39;: 0.37321205597032797, &#39;eval_runtime&#39;: 0.7255, &#39;eval_samples_per_second&#39;: 1437.704, &#39;eval_steps_per_second&#39;: 90.976, &#39;epoch&#39;: 0.25}
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Saving model checkpoint to distilbert-base-uncased-finetuned-cola/checkpoint-535
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Configuration saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/config.json
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Model weights saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/pytorch_model.bin
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> tokenizer config file saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/tokenizer_config.json
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Special tokens file saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/special_tokens_map.json
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Checkpoint successfully created at: Checkpoint(filesystem=local, path=/home/ray/ray_results/tune_transformers/TorchTrainer_e1825_00000_0_learning_rate=0.0000_2023-09-06_14-46-48/checkpoint_000000)
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> {&#39;loss&#39;: 0.6064, &#39;learning_rate&#39;: 0.009981273408239701, &#39;epoch&#39;: 1.25}<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> {&#39;eval_loss&#39;: 0.6181353330612183, &#39;eval_matthews_correlation&#39;: 0.0, &#39;eval_runtime&#39;: 0.7543, &#39;eval_samples_per_second&#39;: 1382.828, &#39;eval_steps_per_second&#39;: 87.504, &#39;epoch&#39;: 0.25}<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> ***** Running Evaluation *****<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span>   Num examples: Unknown<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span>   Batch size = 16<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57954)</span> Executing DAG InputDataBuffer[Input] -&gt; OutputSplitter[split(1, equal=True)]<span class=" -Color -Color-Green"> [repeated 6x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57954)</span> Execution config: ExecutionOptions(resource_limits=ExecutionResources(cpu=None, gpu=None, object_store_memory=None), locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;], preserve_order=False, actor_locality_enabled=True, verbose_progress=False)<span class=" -Color -Color-Green"> [repeated 6x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57954)</span> Tip: For detailed progress reporting, run `ray.data.DataContext.get_current().execution_options.verbose_progress = True`<span class=" -Color -Color-Green"> [repeated 6x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> Saving model checkpoint to distilbert-base-uncased-finetuned-cola/checkpoint-535<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> Configuration saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/config.json<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> Model weights saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/pytorch_model.bin<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> tokenizer config file saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/tokenizer_config.json<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> Special tokens file saved in distilbert-base-uncased-finetuned-cola/checkpoint-535/special_tokens_map.json<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57740)</span> Checkpoint successfully created at: Checkpoint(filesystem=local, path=/home/ray/ray_results/tune_transformers/TorchTrainer_e1825_00001_1_learning_rate=0.0002_2023-09-06_14-46-48/checkpoint_000000)<span class=" -Color -Color-Green"> [repeated 3x across cluster]</span>
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> {&#39;loss&#39;: 0.6061, &#39;learning_rate&#39;: 0.004971910112359551, &#39;epoch&#39;: 2.25}<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> {&#39;eval_loss&#39;: 0.5246258974075317, &#39;eval_matthews_correlation&#39;: 0.489934557943789, &#39;eval_runtime&#39;: 0.6462, &#39;eval_samples_per_second&#39;: 1614.032, &#39;eval_steps_per_second&#39;: 102.134, &#39;epoch&#39;: 1.25}<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> ***** Running Evaluation *****<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span>   Num examples: Unknown<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span>   Batch size = 16<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57927)</span> Executing DAG InputDataBuffer[Input] -&gt; OutputSplitter[split(1, equal=True)]<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57927)</span> Execution config: ExecutionOptions(resource_limits=ExecutionResources(cpu=None, gpu=None, object_store_memory=None), locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;], preserve_order=False, actor_locality_enabled=True, verbose_progress=False)<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57927)</span> Tip: For detailed progress reporting, run `ray.data.DataContext.get_current().execution_options.verbose_progress = True`<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Saving model checkpoint to distilbert-base-uncased-finetuned-cola/checkpoint-1070<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Configuration saved in distilbert-base-uncased-finetuned-cola/checkpoint-1070/config.json<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Model weights saved in distilbert-base-uncased-finetuned-cola/checkpoint-1070/pytorch_model.bin<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> tokenizer config file saved in distilbert-base-uncased-finetuned-cola/checkpoint-1070/tokenizer_config.json<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Special tokens file saved in distilbert-base-uncased-finetuned-cola/checkpoint-1070/special_tokens_map.json<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Checkpoint successfully created at: Checkpoint(filesystem=local, path=/home/ray/ray_results/tune_transformers/TorchTrainer_e1825_00000_0_learning_rate=0.0000_2023-09-06_14-46-48/checkpoint_000001)<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> {&#39;loss&#39;: 0.6073, &#39;learning_rate&#39;: 0.0, &#39;epoch&#39;: 3.25}<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> {&#39;eval_loss&#39;: 0.6450843811035156, &#39;eval_matthews_correlation&#39;: 0.5259674254268325, &#39;eval_runtime&#39;: 0.6474, &#39;eval_samples_per_second&#39;: 1611.106, &#39;eval_steps_per_second&#39;: 101.949, &#39;epoch&#39;: 2.25}<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> ***** Running Evaluation *****<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span>   Num examples: Unknown<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span>   Batch size = 16<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57927)</span> Executing DAG InputDataBuffer[Input] -&gt; OutputSplitter[split(1, equal=True)]<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57927)</span> Execution config: ExecutionOptions(resource_limits=ExecutionResources(cpu=None, gpu=None, object_store_memory=None), locality_with_output=[&#39;84374908fd32ea9885fdd6d21aadf2ce3e296daf28a26522e7a8d026&#39;], preserve_order=False, actor_locality_enabled=True, verbose_progress=False)<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(SplitCoordinator pid=57927)</span> Tip: For detailed progress reporting, run `ray.data.DataContext.get_current().execution_options.verbose_progress = True`<span class=" -Color -Color-Green"> [repeated 4x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Saving model checkpoint to distilbert-base-uncased-finetuned-cola/checkpoint-1605<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Configuration saved in distilbert-base-uncased-finetuned-cola/checkpoint-1605/config.json<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Model weights saved in distilbert-base-uncased-finetuned-cola/checkpoint-1605/pytorch_model.bin<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> tokenizer config file saved in distilbert-base-uncased-finetuned-cola/checkpoint-1605/tokenizer_config.json<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Special tokens file saved in distilbert-base-uncased-finetuned-cola/checkpoint-1605/special_tokens_map.json<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Checkpoint successfully created at: Checkpoint(filesystem=local, path=/home/ray/ray_results/tune_transformers/TorchTrainer_e1825_00000_0_learning_rate=0.0000_2023-09-06_14-46-48/checkpoint_000002)<span class=" -Color -Color-Green"> [repeated 2x across cluster]</span>
</pre></div>
</div>
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "", "version_major": 2, "version_minor": 0}
</script><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> Training completed. Do not forget to share your model on huggingface.co/models =)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57746)</span> {&#39;train_runtime&#39;: 115.5377, &#39;train_samples_per_second&#39;: 295.8, &#39;train_steps_per_second&#39;: 18.487, &#39;train_loss&#39;: 0.6787891173630618, &#39;epoch&#39;: 3.25}
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2023-09-06 14:49:04,574	INFO tune.py:1141 -- Total run time: 136.19 seconds (136.17 seconds for the tuning loop).
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> Training completed. Do not forget to share your model on huggingface.co/models =)
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> 
<span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> 
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Faint -Color-Faint-Cyan">(RayTrainWorker pid=57741)</span> {&#39;train_runtime&#39;: 117.6791, &#39;train_samples_per_second&#39;: 290.417, &#39;train_steps_per_second&#39;: 18.151, &#39;train_loss&#39;: 0.3468295286657212, &#39;epoch&#39;: 3.25}
</pre></div>
</div>
</div>
</div>
<p>View the results of the tuning run as a dataframe, and find the best result.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tune_results</span><span class="o">.</span><span class="n">get_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;eval_loss&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>loss</th>
      <th>learning_rate</th>
      <th>epoch</th>
      <th>step</th>
      <th>eval_loss</th>
      <th>eval_matthews_correlation</th>
      <th>eval_runtime</th>
      <th>eval_samples_per_second</th>
      <th>eval_steps_per_second</th>
      <th>timestamp</th>
      <th>...</th>
      <th>time_total_s</th>
      <th>pid</th>
      <th>hostname</th>
      <th>node_ip</th>
      <th>time_since_restore</th>
      <th>iterations_since_restore</th>
      <th>checkpoint_dir_name</th>
      <th>config/train_loop_config/learning_rate</th>
      <th>config/train_loop_config/epochs</th>
      <th>logdir</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0.6160</td>
      <td>0.000150</td>
      <td>0.25</td>
      <td>535</td>
      <td>0.618135</td>
      <td>0.000000</td>
      <td>0.7543</td>
      <td>1382.828</td>
      <td>87.504</td>
      <td>1694036857</td>
      <td>...</td>
      <td>41.248600</td>
      <td>57497</td>
      <td>ip-10-0-27-125</td>
      <td>10.0.27.125</td>
      <td>41.248600</td>
      <td>1</td>
      <td>checkpoint_000000</td>
      <td>0.00020</td>
      <td>4</td>
      <td>e1825_00001</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.6699</td>
      <td>0.001499</td>
      <td>0.25</td>
      <td>535</td>
      <td>0.619657</td>
      <td>0.000000</td>
      <td>0.7449</td>
      <td>1400.202</td>
      <td>88.603</td>
      <td>1694036856</td>
      <td>...</td>
      <td>41.133609</td>
      <td>57498</td>
      <td>ip-10-0-27-125</td>
      <td>10.0.27.125</td>
      <td>41.133609</td>
      <td>1</td>
      <td>checkpoint_000000</td>
      <td>0.00200</td>
      <td>4</td>
      <td>e1825_00002</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.6073</td>
      <td>0.000000</td>
      <td>3.25</td>
      <td>2136</td>
      <td>0.619694</td>
      <td>0.000000</td>
      <td>0.6329</td>
      <td>1648.039</td>
      <td>104.286</td>
      <td>1694036942</td>
      <td>...</td>
      <td>126.699238</td>
      <td>57499</td>
      <td>ip-10-0-27-125</td>
      <td>10.0.27.125</td>
      <td>126.699238</td>
      <td>4</td>
      <td>checkpoint_000003</td>
      <td>0.02000</td>
      <td>4</td>
      <td>e1825_00003</td>
    </tr>
    <tr>
      <th>0</th>
      <td>0.1934</td>
      <td>0.000000</td>
      <td>3.25</td>
      <td>2136</td>
      <td>0.747960</td>
      <td>0.520756</td>
      <td>0.6530</td>
      <td>1597.187</td>
      <td>101.068</td>
      <td>1694036944</td>
      <td>...</td>
      <td>128.443495</td>
      <td>57496</td>
      <td>ip-10-0-27-125</td>
      <td>10.0.27.125</td>
      <td>128.443495</td>
      <td>4</td>
      <td>checkpoint_000003</td>
      <td>0.00002</td>
      <td>4</td>
      <td>e1825_00000</td>
    </tr>
  </tbody>
</table>
<p>4 rows × 26 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_result</span> <span class="o">=</span> <span class="n">tune_results</span><span class="o">.</span><span class="n">get_best_result</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="share-the-model-a-name-share-a">
<h3>Share the model <a name="share"></a><a class="headerlink" href="#share-the-model-a-name-share-a" title="Permalink to this headline">#</a></h3>
<p>To share the model with the community, a few more steps follow.</p>
<p>You conducted the training on the Ray cluster, but want share the model from the local enviroment. This configuration allows you to easily authenticate.</p>
<p>First, store your authentication token from the Hugging Face website. Sign up <a class="reference external" href="https://huggingface.co/join">here</a> if you haven’t already. Then execute the following cell and input your username and password:</p>
<div class="cell tag_remove-cell-ci docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">huggingface_hub</span> <span class="kn">import</span> <span class="n">notebook_login</span>

<span class="n">notebook_login</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Then you need to install Git-LFS. Uncomment the following instructions:</p>
<div class="cell tag_remove-cell-ci docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># !apt install git-lfs</span>
</pre></div>
</div>
</div>
</div>
<p>Now, load the model and tokenizer locally, and recreate the HF Transformers <code class="docutils literal notranslate"><span class="pre">Trainer</span></code>:</p>
<div class="cell tag_remove-cell-ci docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ray.train.huggingface</span> <span class="kn">import</span> <span class="n">LegacyTransformersCheckpoint</span>

<span class="n">checkpoint</span> <span class="o">=</span> <span class="n">LegacyTransformersCheckpoint</span><span class="o">.</span><span class="n">from_checkpoint</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">)</span>
<span class="n">hf_trainer</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">get_model</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">AutoModelForSequenceClassification</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>You can now upload the result of the training to the Hub. Execute this instruction:</p>
<div class="cell tag_remove-cell-ci docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hf_trainer</span><span class="o">.</span><span class="n">push_to_hub</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>You can now share this model. Others can load it with the identifier <code class="docutils literal notranslate"><span class="pre">&quot;your-username/the-name-you-picked&quot;</span></code>. For example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">transformers</span> <span class="kn">import</span> <span class="n">AutoModelForSequenceClassification</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForSequenceClassification</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s2">&quot;sgugger/my-awesome-model&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="see-also">
<h2>See also<a class="headerlink" href="#see-also" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="../../examples.html#train-examples"><span class="std std-ref">Ray Train Examples</span></a> for more use cases</p></li>
<li><p><a class="reference internal" href="../../user-guides.html#train-user-guides"><span class="std std-ref">Ray Train User Guides</span></a> for how-to guides</p></li>
</ul>
</section>
</section>


              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><!-- Override the footer area for the sphinx-book-theme to include the CSAT widget -->
<div id="csat">
  <div id="csat-feedback-received" class="csat-hidden">
    <span>谢谢你的反馈！</span>
  </div>
  <div id="csat-inputs">
    <span>是否能帮助到你？</span>
    <div id="csat-yes" class="csat-button">
      <svg id="csat-yes-icon" class="csat-hidden csat-icon" width="18" height="13" viewBox="0 0 18 13" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 10.172L16.1922 0.979004L17.6072 2.393L7.00023 13L0.63623 6.636L2.05023 5.222L7.00023 10.172Z" fill="black"/>
      </svg>
      <span>是<span>
    </div>
    <div id="csat-no" class="csat-button">
      <svg id="csat-no-icon" class="csat-hidden csat-icon" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M7.00023 5.58599L11.9502 0.635986L13.3642 2.04999L8.41423 6.99999L13.3642 11.95L11.9502 13.364L7.00023 8.41399L2.05023 13.364L0.63623 11.95L5.58623 6.99999L0.63623 2.04999L2.05023 0.635986L7.00023 5.58599Z" fill="black"/>
      </svg>
      <span>否<span>
    </div>
  </div>
  <div id="csat-textarea-group" class="csat-hidden">
    <span id="csat-feedback-label">反馈</span>
    <textarea id="csat-textarea"></textarea>
    <div id="csat-submit">提交</div>
  </div>
</div><p>
  
    By The Ray Team<br/>
  
      &copy; Copyright 2024, The Ray Team.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>