<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../_static/javascripts/modernizr.js"></script>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-54780881-2"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'UA-54780881-2');
</script>
  
  
    <title>End-to-end MLOps with Seldon Core and Jenkins X &#8212; seldon-core  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=83e35b93" />
    <link rel="stylesheet" type="text/css" href="../_static/material.css?v=79c92029" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/css/rtd_sphinx_search.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=15a8f09d" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/rtd_search_config.js"></script>
    <script src="../_static/js/rtd_sphinx_search.min.js"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Scaling Examples" href="scale.html" />
    <link rel="prev" title="MLOps with Seldon and Jenkins Classic" href="jenkins_classic.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=indigo data-md-color-accent=teal>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#examples/jenkins_x" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="seldon-core  documentation"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Seldon Core Documentation</span>
          <span class="md-header-nav__topic"> End-to-end MLOps with Seldon Core and Jenkins X </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/SeldonIO/seldon-core/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Seldon Core
  </div>
</a>
          </div>
        </div>
      
      
    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
            
            <li class="md-tabs__item"><a href="/" class="md-tabs__link">🚀 Our Other Projects & Products:</a></li>
            
            <li class="md-tabs__item"><a href="https://docs.seldon.io/projects/alibi/en/stable/" class="md-tabs__link">Alibi Explain</a></li>
            
            <li class="md-tabs__item"><a href="https://docs.seldon.io/projects/alibi-detect/en/stable/" class="md-tabs__link">Alibi Detect</a></li>
            
            <li class="md-tabs__item"><a href="https://mlserver.readthedocs.io/en/latest/" class="md-tabs__link">MLServer</a></li>
            
            <li class="md-tabs__item"><a href="https://tempo.readthedocs.io/en/latest/" class="md-tabs__link">Tempo SDK</a></li>
            
            <li class="md-tabs__item"><a href="https://deploy.seldon.io" class="md-tabs__link">Seldon Enterprise Platform</a></li>
            
            <li class="md-tabs__item"><a href="https://github.com/SeldonIO/seldon-deploy-sdk#seldon-deploy-sdk" class="md-tabs__link">Seldon Enterprise Platform SDK</a></li>
          <li class="md-tabs__item"><a href="../nav/tutorials.html" class="md-tabs__link">教程</a></li>
          <li class="md-tabs__item"><a href="notebooks.html" class="md-tabs__link">笔记本</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="seldon-core documentation" class="md-nav__button md-logo">
      
        <img src="../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../index.html"
       title="seldon-core documentation">Seldon Core Documentation</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/SeldonIO/seldon-core/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Seldon Core
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../nav/getting-started.html" class="md-nav__link">开始</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../nav/concepts.html" class="md-nav__link">概念</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../nav/configuration.html" class="md-nav__link">配置</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../nav/tutorials.html" class="md-nav__link">教程</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="notebooks.html" class="md-nav__link">笔记本</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#seldon-core" class="md-nav__link">Seldon Core 设置</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id2" class="md-nav__link">预包装推理服务示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#python" class="md-nav__link">Python 语言封装示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id3" class="md-nav__link">专门的框架示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id4" class="md-nav__link">孵化项目示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id5" class="md-nav__link">基于云的基础示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id6" class="md-nav__link">高级机器学习监控</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id7" class="md-nav__link">Seldon Core 批处理</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#mlops" class="md-nav__link">MLOps: 扩展、监控和可观察性</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id8" class="md-nav__link">生产配置及实现</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#ab" class="md-nav__link">AB 测试及渐进式部署</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id9" class="md-nav__link">复杂图示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id10" class="md-nav__link">入口</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id11" class="md-nav__link">基础设施</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id12" class="md-nav__link">基准测试和负载测试</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id13" class="md-nav__link">升级示例</a>
      
    
    </li></ul>
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../nav/reference.html" class="md-nav__link">参考</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../nav/contributing.html" class="md-nav__link">贡献</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">"Contents"</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#examples-jenkins-x--page-root" class="md-nav__link">End-to-end MLOps with Seldon Core and Jenkins X</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Intuitive-explanation" class="md-nav__link">Intuitive explanation</a>
        </li>
        <li class="md-nav__item"><a href="#Requirements" class="md-nav__link">Requirements</a>
        </li>
        <li class="md-nav__item"><a href="#Setting-up-repo" class="md-nav__link">Setting up repo</a>
        </li>
        <li class="md-nav__item"><a href="#Let&#39;s-train-a-model-locally" class="md-nav__link">Let’s train a model locally</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Install-dependencies" class="md-nav__link">Install dependencies</a>
        </li>
        <li class="md-nav__item"><a href="#Download-the-ML-data" class="md-nav__link">Download the ML data</a>
        </li>
        <li class="md-nav__item"><a href="#Train-a-model" class="md-nav__link">Train a model</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Test-single-prediction" class="md-nav__link">Test single prediction</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#Print-accuracy" class="md-nav__link">Print accuracy</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#Deploy-the-model" class="md-nav__link">Deploy the model</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Save-the-trained-model" class="md-nav__link">Save the trained model</a>
        </li>
        <li class="md-nav__item"><a href="#Update-your-unit-test" class="md-nav__link">Update your unit test</a>
        </li>
        <li class="md-nav__item"><a href="#Updating-Integration-Tests" class="md-nav__link">Updating Integration Tests</a>
        </li>
        <li class="md-nav__item"><a href="#Now-push-your-changes-to-trigger-the-pipeline" class="md-nav__link">Now push your changes to trigger the pipeline</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#Managing-your-Jenkins-X-Application" class="md-nav__link">Managing your Jenkins X Application</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Test-your-application-in-the-staging-environment" class="md-nav__link">Test your application in the staging environment</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#Diving-into-our-continuous-integration" class="md-nav__link">Diving into our continuous integration</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Using-the-Jenkins-X-pipeline" class="md-nav__link">Using the Jenkins X pipeline</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#Integration-tests" class="md-nav__link">Integration tests</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Add-docker-auth-to-your-cluster" class="md-nav__link">Add docker auth to your cluster</a>
        </li>
        <li class="md-nav__item"><a href="#Extend-JenkinsX-file-for-integration" class="md-nav__link">Extend JenkinsX file for integration</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Config-to-provide-docker-authentication" class="md-nav__link">Config to provide docker authentication</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#Kind-run-all-integration-tests-script" class="md-nav__link">Kind run all integration tests script</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Start-docker" class="md-nav__link">Start docker</a>
        </li>
        <li class="md-nav__item"><a href="#Create-and-set-up-KIND-cluster" class="md-nav__link">Create and set-up KIND cluster</a>
        </li>
        <li class="md-nav__item"><a href="#Run-python-tests" class="md-nav__link">Run python tests</a>
        </li>
        <li class="md-nav__item"><a href="#Clean-up" class="md-nav__link">Clean up</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#Promote-your-application" class="md-nav__link">Promote your application</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Test-your-production-application" class="md-nav__link">Test your production application</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="../_sources/examples/jenkins_x.nblink.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <div class="admonition note">
<p>This page was generated from <a class="reference external" href="https://github.com/SeldonIO/seldon-core/blob/e665e4994eabf83fb43c68a5f85e96d5c45e91b5/examples/cicd/sig-mlops-seldon-jenkins-x/README.ipynb">examples/cicd/sig-mlops-seldon-jenkins-x/README.ipynb</a>.</p>
</div>
<section id="End-to-end-MLOps-with-Seldon-Core-and-Jenkins-X">
<h1 id="examples-jenkins-x--page-root">End-to-end MLOps with Seldon Core and Jenkins X<a class="headerlink" href="#examples-jenkins-x--page-root" title="Permalink to this heading">¶</a></h1>
<p>This tutorial provides an end-to-end hands-on tutorial that shows you how to build your own re-usable MLOps pipelines leveraging Seldon Core and Jenkins X.</p>
<p>By the end of this tutorial, you will be able to:</p>
<ul class="simple">
<li><p>Quickly spin up a project based on the MLOps quickstart</p></li>
<li><p>Leverage Seldon’s prepackaged model servers</p></li>
<li><p>Leverage Seldon’s language wrapper for custom model servers</p></li>
<li><p>Run unit tests using Jenkins X</p></li>
<li><p>Run end-to-end tests for your model with KIND (Kubernetes in Docker)</p></li>
<li><p>Promote your model as a Jenkins X application across multiple (staging / prod) environments</p></li>
</ul>
<section id="Intuitive-explanation">
<h2 id="Intuitive-explanation">Intuitive explanation<a class="headerlink" href="#Intuitive-explanation" title="Permalink to this heading">¶</a></h2>
<p>In this project, we will be building an MLOps workflow to deploy your production machine learning models by buiding a re-usable pre-packaged model server through CI, and then deploying individual models using CD.</p>
<p><img alt="image0" src="../_images/jenkins-x-full-diagram.jpg"/></p>
</section>
<section id="Requirements">
<h2 id="Requirements">Requirements<a class="headerlink" href="#Requirements" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p>A Kubernetes cluster running v1.13+ (this was run using GKE)</p></li>
<li><p>The <a class="reference external" href="https://github.com/jenkins-x/jx/">jx CLI</a> version 2.0.916</p></li>
<li><p>Jenkins-X installed in your cluster (you can set it up with the <a class="reference external" href="https://jenkins-x.io/docs/getting-started/setup/boot/">jx boot tutorial</a>)</p></li>
<li><p>Seldon Core <a class="reference external" href="https://docs.seldon.io/projects/seldon-core/en/latest/workflow/install.html">v0.5.0 installed</a> in your cluster</p></li>
</ul>
<p>Once you set everything up, we’ll be ready to kick off 🚀</p>
</section>
<section id="Setting-up-repo">
<h2 id="Setting-up-repo">Setting up repo<a class="headerlink" href="#Setting-up-repo" title="Permalink to this heading">¶</a></h2>
<p>Now we want to start setting up our repo. For this we’ll just leverage the MLOps quickstart by running:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>jx<span class="w"> </span>create<span class="w"> </span>quickstart<span class="w"> </span>--org<span class="w"> </span><span class="s2">"SeldonIO"</span><span class="w"> </span>--project-name<span class="w"> </span><span class="s2">"mlops-deployment"</span><span class="w"> </span>--filter<span class="w"> </span><span class="s2">"mlops-quickstart"</span>
</pre></div>
</div>
</div>
<p>What this command does is basically the following:</p>
<ul class="simple">
<li><p>Find the quickstarts in the organisation “SeldonIO”</p></li>
<li><p>Find the quickstart named “mlops-quickstart”</p></li>
<li><p>Build the project with name “mlops-deployment”</p></li>
</ul>
<p>You now have a repo where you’ll be able to leverage <a class="reference external" href="https://docs.seldon.io/projects/seldon-core/en/latest/servers/overview.html">Seldon’s pre-packaged model servers</a>.</p>
<p>Let’s have a look at what was created:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">jenkins-x.yml</span></code> - File specifying the CI / CD steps</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Makefile</span></code> - Commands to build and test model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">README.(md|ipynb)</span></code> - This file!</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VERSION</span></code> - A file containing the version which is updated upon each release</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">charts/</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">mlops-server/</span></code> - Folder containing helm charts to deploy your model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">preview/</span></code> - Folder containing reference to helm charts to create preview environments</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">integration/</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">kind_test_all.sh</span></code> - File that spins up KIND cluster and runs your model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test_e2e_model_server.py</span></code> - End-to-end tests to run on your model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">requirements-dev.py</span></code> - Requirements for your end to end tests</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">src/</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">model.joblib</span></code> - Sample trained model that is deployed when importing project</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">train_model.py</span></code> - Sample code to train your model and output a model.pickle</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">test_model.py</span></code> - Sample code to unit test your model</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">requirements.txt</span></code> - Example requirements file with supported versions</p></li>
</ul>
</li>
</ul>
</section>
<section id="Let's-train-a-model-locally">
<h2 id="Let's-train-a-model-locally">Let’s train a model locally<a class="headerlink" href="#Let's-train-a-model-locally" title="Permalink to this heading">¶</a></h2>
<p>First we will train a machine learning model, which will help us classify news across multiple categories.</p>
<section id="Install-dependencies">
<h3 id="Install-dependencies">Install dependencies<a class="headerlink" href="#Install-dependencies" title="Permalink to this heading">¶</a></h3>
<p>We will need the following dependencies in order to run the Python code:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>cat<span class="w"> </span>src/requirements.txt
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
## You need the right versions for your model server:
## Model servers: https://docs.seldon.io/projects/seldon-core/en/latest/servers/overview.html

## For SKLearn you need a pickle and the following:
scikit-learn==0.20.3 # See https://docs.seldon.io/projects/seldon-core/en/latest/servers/sklearn.html
joblib==0.13.2

## For XGBoost you need v 0.82 and an xgboost export (not a pickle)
##xgboost==0.82

## For MLFlow you need the following, and a link to the built model:
##mlflow==1.1.0
##pandas==0.25

## For tensorflow, any models supported by tensorflow serving (less than v2.0)
</pre></div></div>
</div>
<p>We can now install the dependencies using the make command:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>make<span class="w"> </span>install_dev
</pre></div>
</div>
</div>
</section>
<section id="Download-the-ML-data">
<h3 id="Download-the-ML-data">Download the ML data<a class="headerlink" href="#Download-the-ML-data" title="Permalink to this heading">¶</a></h3>
<p>Now that we have all the dependencies we can proceed to download the data.</p>
<p>We will download the news stories dataset, and we’ll be attempting to classify across the four classes below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_20newsgroups</span>

<span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"alt.atheism"</span><span class="p">,</span> <span class="s2">"soc.religion.christian"</span><span class="p">,</span> <span class="s2">"comp.graphics"</span><span class="p">,</span> <span class="s2">"sci.med"</span><span class="p">]</span>

<span class="n">twenty_train</span> <span class="o">=</span> <span class="n">fetch_20newsgroups</span><span class="p">(</span>
    <span class="n">subset</span><span class="o">=</span><span class="s2">"train"</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="n">categories</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="n">twenty_test</span> <span class="o">=</span> <span class="n">fetch_20newsgroups</span><span class="p">(</span>
    <span class="n">subset</span><span class="o">=</span><span class="s2">"test"</span><span class="p">,</span> <span class="n">categories</span><span class="o">=</span><span class="n">categories</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1">## Printing the top 3 newstories</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">twenty_train</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)[:</span><span class="mi">3</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
From: sd345@city.ac.uk (Michael Collier)
Subject: Converting images to HP LaserJet III?
Nntp-Posting-Host: hampton
</pre></div></div>
</div>
</section>
<section id="Train-a-model">
<h3 id="Train-a-model">Train a model<a class="headerlink" href="#Train-a-model" title="Permalink to this heading">¶</a></h3>
<p>Now that we’ve downloaded the data, we can train the ML model using a simple pipeline with basic text pre-processors and a Multiclass naive bayes classifier</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="kn">import</span> <span class="n">CountVectorizer</span><span class="p">,</span> <span class="n">TfidfTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.naive_bayes</span> <span class="kn">import</span> <span class="n">MultinomialNB</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>

<span class="n">text_clf</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">"vect"</span><span class="p">,</span> <span class="n">CountVectorizer</span><span class="p">()),</span>
        <span class="p">(</span><span class="s2">"tfidf"</span><span class="p">,</span> <span class="n">TfidfTransformer</span><span class="p">()),</span>
        <span class="p">(</span><span class="s2">"clf"</span><span class="p">,</span> <span class="n">MultinomialNB</span><span class="p">()),</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">text_clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">twenty_train</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">twenty_train</span><span class="o">.</span><span class="n">target</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Pipeline(memory=None,
         steps=[('vect',
                 CountVectorizer(analyzer='word', binary=False,
                                 decode_error='strict',
                                 dtype=&lt;class 'numpy.int64'&gt;, encoding='utf-8',
                                 input='content', lowercase=True, max_df=1.0,
                                 max_features=None, min_df=1,
                                 ngram_range=(1, 1), preprocessor=None,
                                 stop_words=None, strip_accents=None,
                                 token_pattern='(?u)\\b\\w\\w+\\b',
                                 tokenizer=None, vocabulary=None)),
                ('tfidf',
                 TfidfTransformer(norm='l2', smooth_idf=True,
                                  sublinear_tf=False, use_idf=True)),
                ('clf',
                 MultinomialNB(alpha=1.0, class_prior=None, fit_prior=True))],
         verbose=False)
</pre></div></div>
</div>
<section id="Test-single-prediction">
<h4 id="Test-single-prediction">Test single prediction<a class="headerlink" href="#Test-single-prediction" title="Permalink to this heading">¶</a></h4>
<p>Now that we’ve trained our model we can use it to predict from un-seen data.</p>
<p>We can see below that the model is able to predict the first datapoint in the dataset correctly.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"CONTENT:</span><span class="si">{</span><span class="n">twenty_test</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="mi">35</span><span class="p">:</span><span class="mi">230</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">-----------</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"PREDICTED CLASS: </span><span class="si">{</span><span class="n">categories</span><span class="p">[</span><span class="n">twenty_test</span><span class="o">.</span><span class="n">target</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CONTENT:
Subject: Re: HELP for Kidney Stones ..............
Organization: The Avant-Garde of the Now, Ltd.
Lines: 12
NNTP-Posting-Host: ucsd.edu

As I recall from my bout with kidney stones, there isn't

-----------

PREDICTED CLASS: comp.graphics
</pre></div></div>
</div>
</section>
</section>
<section id="Print-accuracy">
<h3 id="Print-accuracy">Print accuracy<a class="headerlink" href="#Print-accuracy" title="Permalink to this heading">¶</a></h3>
<p>We can print the accuracy of the model by running the test data and counting the number of correct classes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">predicted</span> <span class="o">=</span> <span class="n">text_clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">twenty_test</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Accuracy: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">predicted</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">twenty_test</span><span class="o">.</span><span class="n">target</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Accuracy: 0.83
</pre></div></div>
</div>
</section>
</section>
<section id="Deploy-the-model">
<h2 id="Deploy-the-model">Deploy the model<a class="headerlink" href="#Deploy-the-model" title="Permalink to this heading">¶</a></h2>
<p>Now we want to be able to deploy the model we just trained. This will just be as simple as updated the model binary.</p>
<section id="Save-the-trained-model">
<h3 id="Save-the-trained-model">Save the trained model<a class="headerlink" href="#Save-the-trained-model" title="Permalink to this heading">¶</a></h3>
<p>First we have to save the trained model in the <code class="docutils literal notranslate"><span class="pre">src/</span></code> folder, which our wrapper will load</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">joblib</span>

<span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">text_clf</span><span class="p">,</span> <span class="s2">"src/model.joblib"</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
['src/model.joblib']
</pre></div></div>
</div>
</section>
<section id="Update-your-unit-test">
<h3 id="Update-your-unit-test">Update your unit test<a class="headerlink" href="#Update-your-unit-test" title="Permalink to this heading">¶</a></h3>
<p>We’ll write a very simple unit test that make sure that the model loads and runs as expected.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> src/test_model.py

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>
<span class="kn">import</span> <span class="nn">joblib</span>

<span class="n">EXPECTED_RESPONSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">test_model</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"text 1"</span><span class="p">,</span> <span class="s2">"text 2"</span><span class="p">]</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">"model.joblib"</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">EXPECTED_RESPONSE</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Overwriting src/test_model.py
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>make<span class="w"> </span>test
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
cat: VERSION: No such file or directory
Makefile:12: warning: overriding recipe for target 'make'
Makefile:9: warning: ignoring old recipe for target 'make'
Makefile:15: warning: overriding recipe for target 'make'
Makefile:12: warning: ignoring old recipe for target 'make'
(cd src &amp;&amp; pytest -s --verbose -W ignore 2&gt;&amp;1)
<span class="ansi-bold">============================= test session starts ==============================</span>
platform linux -- Python 3.7.3, pytest-5.1.1, py-1.8.0, pluggy-0.12.0 -- /home/alejandro/miniconda3/envs/reddit-classification/bin/python
cachedir: .pytest_cache
rootdir: /home/alejandro/Programming/kubernetes/seldon/sig-mlops-example/src
plugins: cov-2.7.1, forked-1.0.2, localserver-0.5.0
collected 1 item

test_model.py::test_model <span class="ansi-green-fg">PASSED</span>

<span class="ansi-green-intense-fg ansi-bold">============================== 1 passed in 2.21s ===============================</span>
</pre></div></div>
</div>
</section>
<section id="Updating-Integration-Tests">
<h3 id="Updating-Integration-Tests">Updating Integration Tests<a class="headerlink" href="#Updating-Integration-Tests" title="Permalink to this heading">¶</a></h3>
<p>We can also now update the integration tests. This is another very simple step, where we’ll want to test this model specifically.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> integration/test_e2e_sklearn_server.py
<span class="kn">from</span> <span class="nn">seldon_core.seldon_client</span> <span class="kn">import</span> <span class="n">SeldonClient</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">API_AMBASSADOR</span> <span class="o">=</span> <span class="s2">"localhost:8003"</span>

<span class="k">def</span> <span class="nf">test_sklearn_server</span><span class="p">():</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"From: brian@ucsd.edu (Brian Kantor)</span><span class="se">\n</span><span class="s2">Subject: Re: HELP for Kidney Stones ..............</span><span class="se">\n</span><span class="s2">Organization: The Avant-Garde of the Now, Ltd.</span><span class="se">\n</span><span class="s2">Lines: 12</span><span class="se">\n</span><span class="s2">NNTP-Posting-Host: ucsd.edu</span><span class="se">\n\n</span><span class="s2">As I recall from my bout with kidney stones, there isn't any</span><span class="se">\n</span><span class="s2">medication that can do anything about them except relieve the pain.</span><span class="se">\n\n</span><span class="s2">Either they pass, or they have to be broken up with sound, or they have</span><span class="se">\n</span><span class="s2">to be extracted surgically.</span><span class="se">\n\n</span><span class="s2">When I was in, the X-ray tech happened to mention that she'd had kidney</span><span class="se">\n</span><span class="s2">stones and children, and the childbirth hurt less.</span><span class="se">\n\n</span><span class="s2">Demerol worked, although I nearly got arrested on my way home when I barfed</span><span class="se">\n</span><span class="s2">all over the police car parked just outside the ER.</span><span class="se">\n\t</span><span class="s2">- Brian</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span>
            <span class="s1">'From: rind@enterprise.bih.harvard.edu (David Rind)</span><span class="se">\n</span><span class="s1">Subject: Re: Candida(yeast) Bloom, Fact or Fiction</span><span class="se">\n</span><span class="s1">Organization: Beth Israel Hospital, Harvard Medical School, Boston Mass., USA</span><span class="se">\n</span><span class="s1">Lines: 37</span><span class="se">\n</span><span class="s1">NNTP-Posting-Host: enterprise.bih.harvard.edu</span><span class="se">\n\n</span><span class="s1">In article &lt;1993Apr26.103242.1@vms.ocom.okstate.edu&gt;</span><span class="se">\n</span><span class="s1"> banschbach@vms.ocom.okstate.edu writes:</span><span class="se">\n</span><span class="s1">&gt;are in a different class.  The big question seems to be is it reasonable to </span><span class="se">\n</span><span class="s1">&gt;use them in patients with GI distress or sinus problems that *could* be due </span><span class="se">\n</span><span class="s1">&gt;to candida blooms following the use of broad-spectrum antibiotics?</span><span class="se">\n\n</span><span class="s1">I guess I</span><span class="se">\'</span><span class="s1">m still not clear on what the term "candida bloom" means,</span><span class="se">\n</span><span class="s1">but certainly it is well known that thrush (superficial candidal</span><span class="se">\n</span><span class="s1">infections on mucous membranes) can occur after antibiotic use.</span><span class="se">\n</span><span class="s1">This has nothing to do with systemic yeast syndrome, the "quack"</span><span class="se">\n</span><span class="s1">diagnosis that has been being discussed.</span><span class="se">\n\n\n</span><span class="s1">&gt;found in the sinus mucus membranes than is candida.  Women have been known </span><span class="se">\n</span><span class="s1">&gt;for a very long time to suffer from candida blooms in the vagina and a </span><span class="se">\n</span><span class="s1">&gt;women is lucky to find a physician who is willing to treat the cause and </span><span class="se">\n</span><span class="s1">&gt;not give give her advise to use the OTC anti-fungal creams.</span><span class="se">\n\n</span><span class="s1">Lucky how?  Since a recent article (randomized controlled trial) of</span><span class="se">\n</span><span class="s1">oral yogurt on reducing vaginal candidiasis, I</span><span class="se">\'</span><span class="s1">ve mentioned to a </span><span class="se">\n</span><span class="s1">number of patients with frequent vaginal yeast infections that they</span><span class="se">\n</span><span class="s1">could try eating 6 ounces of yogurt daily.  It turns out most would</span><span class="se">\n</span><span class="s1">rather just use anti-fungal creams when they get yeast infections.</span><span class="se">\n\n</span><span class="s1">&gt;yogurt dangerous).  If this were a standard part of medical practice, as </span><span class="se">\n</span><span class="s1">&gt;Gordon R. says it is, then the incidence of GI distress and vaginal yeast </span><span class="se">\n</span><span class="s1">&gt;infections should decline.</span><span class="se">\n\n</span><span class="s1">Again, this just isn</span><span class="se">\'</span><span class="s1">t what the systemic yeast syndrome is about, and</span><span class="se">\n</span><span class="s1">has nothing to do with the quack therapies that were being discussed.</span><span class="se">\n</span><span class="s1">There is some evidence that attempts to reinoculate the GI tract with</span><span class="se">\n</span><span class="s1">bacteria after antibiotic therapy don</span><span class="se">\'</span><span class="s1">t seem to be very helpful in</span><span class="se">\n</span><span class="s1">reducing diarrhea, but I don</span><span class="se">\'</span><span class="s1">t think anyone would view this as a</span><span class="se">\n</span><span class="s1">quack therapy.</span><span class="se">\n</span><span class="s1">-- </span><span class="se">\n</span><span class="s1">David Rind</span><span class="se">\n</span><span class="s1">rind@enterprise.bih.harvard.edu</span><span class="se">\n</span><span class="s1">'</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">SeldonClient</span><span class="p">(</span>
        <span class="n">gateway</span><span class="o">=</span><span class="s2">"ambassador"</span><span class="p">,</span>
        <span class="n">gateway_endpoint</span><span class="o">=</span><span class="n">API_AMBASSADOR</span><span class="p">,</span>
        <span class="n">deployment_name</span><span class="o">=</span><span class="s2">"news-classifier-server"</span><span class="p">,</span>
        <span class="n">payload_type</span><span class="o">=</span><span class="s2">"ndarray"</span><span class="p">,</span>
        <span class="n">namespace</span><span class="o">=</span><span class="s2">"default"</span><span class="p">,</span>
        <span class="n">transport</span><span class="o">=</span><span class="s2">"rest"</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Overwriting integration/test_e2e_sklearn_server.py
</pre></div></div>
</div>
</section>
<section id="Now-push-your-changes-to-trigger-the-pipeline">
<h3 id="Now-push-your-changes-to-trigger-the-pipeline">Now push your changes to trigger the pipeline<a class="headerlink" href="#Now-push-your-changes-to-trigger-the-pipeline" title="Permalink to this heading">¶</a></h3>
<p>Because Jenkins X has created a CI GitOps pipeline for our repo we just need to push our changes to run all the tests</p>
<p>We can do this by running our good old git commands:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-bash notranslate"><div class="highlight"><pre><span></span>%%bash
git<span class="w"> </span>add<span class="w"> </span>.
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>master
</pre></div>
</div>
</div>
<p>We can now see that the pipeline has been triggered by viewing our activities:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>jx<span class="w"> </span>get<span class="w"> </span>activity<span class="w"> </span>-f<span class="w"> </span>sig-mlops-seldon-jenkins-x<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
    Create Effective Pipeline                          11h28m57s       7s Succeeded
    Create Tekton Crds                                 11h28m50s      11s Succeeded
  test and deploy sklearn server                       11h28m38s    1m54s Succeeded
    Credential Initializer 59hx6                       11h28m38s       0s Succeeded
    Working Dir Initializer Fslpm                      11h28m38s       1s Succeeded
    Place Tools                                        11h28m37s       1s Succeeded
    Git Source Seldonio Sig Mlops Seldon Jenki Ftjtn   11h28m36s       6s Succeeded https://github.com/SeldonIO/sig-mlops-seldon-jenkins-x.git
    Git Merge                                          11h28m30s       1s Succeeded
    Run Tests                                          11h28m29s      13s Succeeded
    Build And Push Images                              11h28m16s    1m32s Succeeded
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Similarly</span> <span class="n">we</span> <span class="n">can</span> <span class="n">actually</span> <span class="n">see</span> <span class="n">the</span> <span class="n">logs</span> <span class="n">of</span> <span class="n">our</span> <span class="n">running</span> <span class="n">job</span><span class="p">:</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-bash notranslate"><div class="highlight"><pre><span></span>%%bash
<span class="nv">YOUR_GIT_USERNAME</span><span class="o">=</span>SeldonIO
jx<span class="w"> </span>get<span class="w"> </span>build<span class="w"> </span>logs<span class="w"> </span><span class="s2">"</span><span class="nv">$YOUR_GIT_USERNAME</span><span class="s2">/sig-mlops-seldon-jenkins-x/master #7 release"</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tail
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
error: Failed to parse docker reference ELDON_BASE_WRAPPER
ERROR: An error occurred: unable to get metadata for ELDON_BASE_WRAPPER:latest
ERROR: Suggested solution: check image name
ERROR: If the problem persists consult the docs at https://github.com/openshift/source-to-image/tree/master/docs. Eventually reach us on freenode #openshift or file an issue at https://github.com/openshift/source-to-image/issues providing us with a log from your build using log output level 3.
Makefile:8: recipe for target 'build' failed
make: *** [build] Error 1
Stopping Docker: dockerProgram process in pidfile '/var/run/docker-ssd.pid', 1 process(es), refused to die.
<span class="ansi-red-fg">
Pipeline failed on stage 'test-and-deploy-sklearn-server' : container 'step-build-and-push-images'. The execution of the pipeline has stopped.</span>

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
wrote: /tmp/086bfe4e-d4ac-46e6-baa1-71d4ef7abca4095596018
</pre></div></div>
</div>
</section>
</section>
<section id="Managing-your-Jenkins-X-Application">
<h2 id="Managing-your-Jenkins-X-Application">Managing your Jenkins X Application<a class="headerlink" href="#Managing-your-Jenkins-X-Application" title="Permalink to this heading">¶</a></h2>
<p>Now that we’ve deployed our MLOps repo, Jenkins X now has created an application from our charts.</p>
<p>This application gets automatically syncd into the Jenkins X staging environment, which you can see:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>jx-staging
</pre></div>
</div>
</div>
<section id="Test-your-application-in-the-staging-environment">
<h3 id="Test-your-application-in-the-staging-environment">Test your application in the staging environment<a class="headerlink" href="#Test-your-application-in-the-staging-environment" title="Permalink to this heading">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[163]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">seldon_core.seldon_client</span> <span class="kn">import</span> <span class="n">SeldonClient</span>

<span class="n">url</span> <span class="o">=</span> <span class="o">!</span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>ambassador<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].hostname}'</span>

<span class="n">sc</span> <span class="o">=</span> <span class="n">SeldonClient</span><span class="p">(</span>
    <span class="n">gateway</span><span class="o">=</span><span class="s2">"ambassador"</span><span class="p">,</span>
    <span class="n">gateway_endpoint</span><span class="o">=</span><span class="s2">"localhost:80"</span><span class="p">,</span>
    <span class="n">deployment_name</span><span class="o">=</span><span class="s2">"mlops-server"</span><span class="p">,</span>
    <span class="n">payload_type</span><span class="o">=</span><span class="s2">"ndarray"</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="s2">"jx-staging"</span><span class="p">,</span>
    <span class="n">transport</span><span class="o">=</span><span class="s2">"rest"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">twenty_test</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>

<span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[163]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ndarray {
  values {
    number_value: 2.0
  }
}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[165]:
</pre></div>
</div>
<div class="input_area highlight-bash notranslate"><div class="highlight"><pre><span></span>%%bash
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>-H<span class="w"> </span><span class="s1">'Content-Type: application/json'</span><span class="w"> </span><span class="se">\</span>
<span class="w">     </span>-d<span class="w"> </span><span class="s2">"{'data': {'names': ['text'], 'ndarray': ['Hello world this is a test']}}"</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>http://localhost/seldon/jx-staging/news-classifier-server/api/v0.1/predictions
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{
  "meta": {
    "puid": "so6n21pkf70fm66eka28lc63cr",
    "tags": {
    },
    "routing": {
    },
    "requestPath": {
      "news-classifier-server-processor": "axsauze/sklearn-server:0.1"
    },
    "metrics": []
  },
  "data": {
    "names": [],
    "ndarray": [2.0]
  }
}
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   350  100   278  100    72   7942   2057 --:--:-- --:--:-- --:--:-- 10294
</pre></div></div>
</div>
</section>
</section>
<section id="Diving-into-our-continuous-integration">
<h2 id="Diving-into-our-continuous-integration">Diving into our continuous integration<a class="headerlink" href="#Diving-into-our-continuous-integration" title="Permalink to this heading">¶</a></h2>
<p>We have now separated our model development into two chunks:</p>
<ul class="simple">
<li><p>The first one involves the creation of a model serve, and the second one involves the CI of the model server, and the second involves the deployment of models that create the model.</p></li>
</ul>
<section id="Using-the-Jenkins-X-pipeline">
<h3 id="Using-the-Jenkins-X-pipeline">Using the Jenkins X pipeline<a class="headerlink" href="#Using-the-Jenkins-X-pipeline" title="Permalink to this heading">¶</a></h3>
<p>In order to do this we will be able to first run some tests and the push to the docker repo.</p>
<p>For this we will be leveraging the Jenkins X file, we’ll first start with a simple file that just runs the tests:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[171]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> jenkins-x.yml
<span class="n">buildPack</span><span class="p">:</span> <span class="n">none</span>
<span class="n">pipelineConfig</span><span class="p">:</span>
  <span class="n">pipelines</span><span class="p">:</span>
    <span class="n">release</span><span class="p">:</span>
      <span class="n">pipeline</span><span class="p">:</span>
        <span class="n">agent</span><span class="p">:</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">seldonio</span><span class="o">/</span><span class="n">core</span><span class="o">-</span><span class="n">builder</span><span class="p">:</span><span class="mf">0.4</span>
        <span class="n">stages</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">test</span><span class="o">-</span><span class="n">sklearn</span><span class="o">-</span><span class="n">server</span>
            <span class="n">steps</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">run</span><span class="o">-</span><span class="n">tests</span>
              <span class="n">command</span><span class="p">:</span> <span class="n">make</span>
              <span class="n">args</span><span class="p">:</span>
              <span class="o">-</span> <span class="n">install_dev</span>
              <span class="o">-</span> <span class="n">test</span>
    <span class="n">pullRequest</span><span class="p">:</span>
      <span class="n">pipeline</span><span class="p">:</span>
        <span class="n">agent</span><span class="p">:</span>
          <span class="n">image</span><span class="p">:</span> <span class="n">seldonio</span><span class="o">/</span><span class="n">core</span><span class="o">-</span><span class="n">builder</span><span class="p">:</span><span class="mf">0.4</span>
        <span class="n">stages</span><span class="p">:</span>
          <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">test</span><span class="o">-</span><span class="n">sklearn</span><span class="o">-</span><span class="n">server</span>
            <span class="n">steps</span><span class="p">:</span>
            <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">run</span><span class="o">-</span><span class="n">tests</span>
              <span class="n">command</span><span class="p">:</span> <span class="n">make</span>
              <span class="n">args</span><span class="p">:</span>
              <span class="o">-</span> <span class="n">install_dev</span>
              <span class="o">-</span> <span class="n">test</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Overwriting jenkins-x.yml
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">jenkins-x.yml</span></code> file is pretty easy to understand if we read through the different steps.</p>
<p>Basically we can define the steps of what happens upon <code class="docutils literal notranslate"><span class="pre">release</span></code> - i.e. when a PR / Commit is added to master - and what happens upon <code class="docutils literal notranslate"><span class="pre">pullRequest</span></code> - whenever someone opens a pull request.</p>
<p>You can see that the steps are exactly the same for both release and PR for now - namely, we run <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">install_dev</span> <span class="pre">test</span></code> which basically installs all the dependencies and runs all the tests.</p>
</section>
</section>
<section id="Integration-tests">
<h2 id="Integration-tests">Integration tests<a class="headerlink" href="#Integration-tests" title="Permalink to this heading">¶</a></h2>
<p>Now that we have a model that we want to be able to deploy, we want to make sure that we run end-to-end tests on that model to make sure everything works as expected.</p>
<p>For this we will leverage the same framework that the Kubernetes team uses to test Kubernetes itself: KIND.</p>
<p>KIND stands for Kubernetes in Docker, and is used to isolate a Kubernetes environent for end-to-end tests.</p>
<p>In our case, we will be able to leverage to create an isolated environment, where we’ll be able to test our model.</p>
<p>For this, the steps we’ll have to carry out include:</p>
<ol class="arabic simple">
<li><p>Authenticate your docker with the jx CLI</p></li>
<li><p>Add the steps in the <code class="docutils literal notranslate"><span class="pre">Jenkins-X.yml</span></code> to run this in the production cluster</p></li>
<li><p>Leverage the <code class="docutils literal notranslate"><span class="pre">kind_run_all.sh</span></code> script that creates a KIND cluster and runs the tests</p></li>
</ol>
<section id="Add-docker-auth-to-your-cluster">
<h3 id="Add-docker-auth-to-your-cluster">Add docker auth to your cluster<a class="headerlink" href="#Add-docker-auth-to-your-cluster" title="Permalink to this heading">¶</a></h3>
<p>Adding a docker authentication with Jenkins X can be done through a JX CLI command, which is the following:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">jx</span> <span class="pre">create</span> <span class="pre">docker</span> <span class="pre">auth</span> <span class="pre">--host</span> <span class="pre">https://index.docker.io/v1/</span> <span class="pre">--user</span> <span class="pre">$YOUR_DOCKER_USERNAME</span> <span class="pre">--secret</span> <span class="pre">$YOUR_DOCKER_KEY_SECRET</span> <span class="pre">--email</span> <span class="pre">$YOUR_DOCKER_EMAIL</span></code></p></li>
</ul>
<p>This comamnd will use these credentials to authenticate with Docker and create an auth token (which expires).</p>
</section>
<section id="Extend-JenkinsX-file-for-integration">
<h3 id="Extend-JenkinsX-file-for-integration">Extend JenkinsX file for integration<a class="headerlink" href="#Extend-JenkinsX-file-for-integration" title="Permalink to this heading">¶</a></h3>
<p>Now that we have the test that would run for the integration tests, we need to extend the JX pipeline to run this.</p>
<p>This extension is quite simple, and only requires adding the following line:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- name: run-end-to-end-tests
  command: bash
  args:
  - integration/kind_test_all.sh
</pre></div>
</div>
<p>This line would be added in both the PR and release pipelines so that we can run integration tests then.</p>
<p>It is also possible to move the integration tests into a separate jenkins-x file such as <code class="docutils literal notranslate"><span class="pre">jenkins-x-integration.yml</span></code> by leveraging <a class="reference external" href="https://jenkins-x.io/docs/">Contexts &amp; Schedules</a> which basically allow us to extend the functionality of Prow by writing our own triggers, however this is outside the scope of this tutorial.</p>
<section id="Config-to-provide-docker-authentication">
<h4 id="Config-to-provide-docker-authentication">Config to provide docker authentication<a class="headerlink" href="#Config-to-provide-docker-authentication" title="Permalink to this heading">¶</a></h4>
<p>This piece is slightly more extensive, as we will need to use Docker to build out containers due to the dependency on <code class="docutils literal notranslate"><span class="pre">s2i</span></code> to build the model wrappers.</p>
<p>First we need to define the volumes that we’ll be mounting to the container.</p>
<p>The first few volumes before basically consist of the core components that docker will need to be able to run.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modules</span>
<span class="w">    </span><span class="nt">hostPath</span><span class="p">:</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/lib/modules</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Directory</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cgroup</span>
<span class="w">    </span><span class="nt">hostPath</span><span class="p">:</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/fs/cgroup</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Directory</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dind-storage</span>
<span class="w">    </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</pre></div>
</div>
<p>We also want to mount the docker credentials which we will generate in the next step.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jenkins-docker-config-volume</span>
<span class="w">  </span><span class="nt">secret</span><span class="p">:</span>
<span class="w">    </span><span class="nt">items</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config.json</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config.json</span>
<span class="w">    </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jenkins-docker-cfg</span>
</pre></div>
</div>
<p>Once we’ve created the volumes, now we just need to mount them. This can be done as follows:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">options</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containerOptions</span><span class="p">:</span>
<span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/lib/modules</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">modules</span>
<span class="w">        </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/fs/cgroup</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cgroup</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dind-storage</span>
<span class="w">        </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/lib/docker</span>
</pre></div>
</div>
<p>And finally we also mount the docker auth configuration so we don’t have to run <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">login</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/builder/home/.docker</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">jenkins-docker-config-volume</span>
</pre></div>
</div>
<p>And to finalise, we need to make sure that the pod can run with privileged context.</p>
<p>The reason why this is required is in order to be able to run the docker daemon:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">  </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div>
</div>
</section>
</section>
<section id="Kind-run-all-integration-tests-script">
<h3 id="Kind-run-all-integration-tests-script">Kind run all integration tests script<a class="headerlink" href="#Kind-run-all-integration-tests-script" title="Permalink to this heading">¶</a></h3>
<p>The kind_run_all may seem complicated at first, but it’s actually quite simple.</p>
<p>All the script does is set-up a kind cluster with all dependencies, deploy the model and clean everything up.</p>
<p>Let’s break down each of the components within the script.</p>
<section id="Start-docker">
<h4 id="Start-docker">Start docker<a class="headerlink" href="#Start-docker" title="Permalink to this heading">¶</a></h4>
<p>We first start the docker daemon and wait until Docker is running (using <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span> <span class="pre">q</span></code> for guidance.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">## FIRST WE START THE DOCKER DAEMON</span>
service<span class="w"> </span>docker<span class="w"> </span>start
<span class="c1">## the service can be started but the docker socket not ready, wait for ready</span>
<span class="nv">WAIT_N</span><span class="o">=</span><span class="m">0</span>
<span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span><span class="c1"># docker ps -q should only work if the daemon is ready</span>
<span class="w">    </span>docker<span class="w"> </span>ps<span class="w"> </span>-q<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="k">break</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="si">${</span><span class="nv">WAIT_N</span><span class="si">}</span><span class="w"> </span>-lt<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">        </span><span class="nv">WAIT_N</span><span class="o">=</span><span class="k">$((</span><span class="nv">WAIT_N</span><span class="o">+</span><span class="m">1</span><span class="k">))</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"[SETUP] Waiting for Docker to be ready, sleeping for </span><span class="si">${</span><span class="nv">WAIT_N</span><span class="si">}</span><span class="s2"> seconds ..."</span>
<span class="w">        </span>sleep<span class="w"> </span><span class="si">${</span><span class="nv">WAIT_N</span><span class="si">}</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"[SETUP] Reached maximum attempts, not waiting any longer ..."</span>
<span class="w">        </span><span class="k">break</span>
<span class="w">    </span><span class="k">fi</span>
<span class="k">done</span>
</pre></div>
</div>
</section>
<section id="Create-and-set-up-KIND-cluster">
<h4 id="Create-and-set-up-KIND-cluster">Create and set-up KIND cluster<a class="headerlink" href="#Create-and-set-up-KIND-cluster" title="Permalink to this heading">¶</a></h4>
<p>Once we’re running a docker daemon, we can run the command to create our KIND cluster, and install all the components.</p>
<p>This will set up a Kubnernetes cluster using the docker daemon (using containers as Nodes), and then install Ambassador + Seldon Core.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">########################################</span>
<span class="c1">## AVOID EXIT ON ERROR FOR FOLLOWING CMDS</span>
<span class="nb">set</span><span class="w"> </span>+o<span class="w"> </span>errexit

<span class="c1">## START CLUSTER</span>
make<span class="w"> </span>kind_create_cluster
<span class="nv">KIND_EXIT_VALUE</span><span class="o">=</span><span class="nv">$?</span>

<span class="c1">## Ensure we reach the kubeconfig path</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">KUBECONFIG</span><span class="o">=</span><span class="k">$(</span>kind<span class="w"> </span>get<span class="w"> </span>kubeconfig-path<span class="k">)</span>

<span class="c1">## ONLY RUN THE FOLLOWING IF SUCCESS</span>
<span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="si">${</span><span class="nv">KIND_EXIT_VALUE</span><span class="si">}</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="c1"># KIND CLUSTER SETUP</span>
<span class="w">    </span>make<span class="w"> </span>kind_setup
<span class="w">    </span><span class="nv">SETUP_EXIT_VALUE</span><span class="o">=</span><span class="nv">$?</span>
</pre></div>
</div>
</section>
<section id="Run-python-tests">
<h4 id="Run-python-tests">Run python tests<a class="headerlink" href="#Run-python-tests" title="Permalink to this heading">¶</a></h4>
<p>We can now run the tests; for this we run all the dev installations and kick off our tests (which we’ll add inside of the integration folder).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="c1"># BUILD S2I BASE IMAGES</span>
<span class="w">    </span>make<span class="w"> </span>build
<span class="w">    </span><span class="nv">S2I_EXIT_VALUE</span><span class="o">=</span><span class="nv">$?</span>

<span class="w">    </span><span class="c1">## INSTALL ALL REQUIRED DEPENDENCIES</span>
<span class="w">    </span>make<span class="w"> </span>install_integration_dev
<span class="w">    </span><span class="nv">INSTALL_EXIT_VALUE</span><span class="o">=</span><span class="nv">$?</span>

<span class="w">    </span><span class="c1">## RUNNING TESTS AND CAPTURING ERROR</span>
<span class="w">    </span>make<span class="w"> </span><span class="nb">test</span>
<span class="w">    </span><span class="nv">TEST_EXIT_VALUE</span><span class="o">=</span><span class="nv">$?</span>
<span class="k">fi</span>
</pre></div>
</div>
</section>
<section id="Clean-up">
<h4 id="Clean-up">Clean up<a class="headerlink" href="#Clean-up" title="Permalink to this heading">¶</a></h4>
<p>Finally we just clean everything, including the cluster, the containers and the docker daemon.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">## DELETE KIND CLUSTER</span>
make<span class="w"> </span>kind_delete_cluster
<span class="nv">DELETE_EXIT_VALUE</span><span class="o">=</span><span class="nv">$?</span>

<span class="c1">########################################</span>
<span class="c1">## EXIT STOPS COMMANDS FROM HERE ONWARDS</span>
<span class="nb">set</span><span class="w"> </span>-o<span class="w"> </span>errexit

<span class="c1">## CLEANING DOCKER</span>
docker<span class="w"> </span>ps<span class="w"> </span>-aq<span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-r<span class="w"> </span>docker<span class="w"> </span>rm<span class="w"> </span>-f<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
service<span class="w"> </span>docker<span class="w"> </span>stop<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">true</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="Promote-your-application">
<h2 id="Promote-your-application">Promote your application<a class="headerlink" href="#Promote-your-application" title="Permalink to this heading">¶</a></h2>
<p>Now that we’ve verified that our CI pipeline is working, we want to promote our application to production</p>
<p>This can be done with our JX CLI:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>jx<span class="w"> </span>promote<span class="w"> </span>application<span class="w"> </span>--...
</pre></div>
</div>
</div>
<section id="Test-your-production-application">
<h3 id="Test-your-production-application">Test your production application<a class="headerlink" href="#Test-your-production-application" title="Permalink to this heading">¶</a></h3>
<p>Once your production application is deployed, you can test it using the same script, but in the <code class="docutils literal notranslate"><span class="pre">jx-production</span></code> namespace:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">seldon_core.seldon_client</span> <span class="kn">import</span> <span class="n">SeldonClient</span>

<span class="n">url</span> <span class="o">=</span> <span class="o">!</span>kubectl<span class="w"> </span>get<span class="w"> </span>svc<span class="w"> </span>ambassador<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.status.loadBalancer.ingress[0].hostname}'</span>

<span class="n">sc</span> <span class="o">=</span> <span class="n">SeldonClient</span><span class="p">(</span>
    <span class="n">gateway</span><span class="o">=</span><span class="s2">"ambassador"</span><span class="p">,</span>
    <span class="n">gateway_endpoint</span><span class="o">=</span><span class="s2">"localhost:80"</span><span class="p">,</span>
    <span class="n">deployment_name</span><span class="o">=</span><span class="s2">"mlops-server"</span><span class="p">,</span>
    <span class="n">payload_type</span><span class="o">=</span><span class="s2">"ndarray"</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="s2">"jx-production"</span><span class="p">,</span>
    <span class="n">transport</span><span class="o">=</span><span class="s2">"rest"</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">twenty_test</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>

<span class="n">response</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="jenkins_classic.html" title="MLOps with Seldon and Jenkins Classic"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> "Previous" </span> MLOps with Seldon and Jenkins Classic </span>
              </div>
            </a>
          
          
            <a href="scale.html" title="Scaling Examples"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> "Next" </span> Scaling Examples </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2024, Seldon Technologies Ltd.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>