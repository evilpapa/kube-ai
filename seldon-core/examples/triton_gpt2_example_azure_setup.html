<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="../_static/javascripts/modernizr.js"></script>
  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-54780881-2"></script>
<script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'UA-54780881-2');
</script>
  
  
    <title>Setup Azure Kubernetes Infrastructure &#8212; seldon-core  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=83e35b93" />
    <link rel="stylesheet" type="text/css" href="../_static/material.css?v=79c92029" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/css/rtd_sphinx_search.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=15a8f09d" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/rtd_search_config.js"></script>
    <script src="../_static/js/rtd_sphinx_search.min.js"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Stateful Model Feedback Metrics Server" href="feedback_reward_custom_metrics.html" />
    <link rel="prev" title="Pretrained GPT2 Model Deployment Example" href="triton_gpt2_example_azure.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=indigo data-md-color-accent=teal>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#examples/triton_gpt2_example_azure_setup" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="seldon-core  documentation"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Seldon Core Documentation</span>
          <span class="md-header-nav__topic"> Setup Azure Kubernetes Infrastructure </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/SeldonIO/seldon-core/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Seldon Core
  </div>
</a>
          </div>
        </div>
      
      
    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
            
            <li class="md-tabs__item"><a href="/" class="md-tabs__link">🚀 Our Other Projects & Products:</a></li>
            
            <li class="md-tabs__item"><a href="https://docs.seldon.io/projects/alibi/en/stable/" class="md-tabs__link">Alibi Explain</a></li>
            
            <li class="md-tabs__item"><a href="https://docs.seldon.io/projects/alibi-detect/en/stable/" class="md-tabs__link">Alibi Detect</a></li>
            
            <li class="md-tabs__item"><a href="https://mlserver.readthedocs.io/en/latest/" class="md-tabs__link">MLServer</a></li>
            
            <li class="md-tabs__item"><a href="https://tempo.readthedocs.io/en/latest/" class="md-tabs__link">Tempo SDK</a></li>
            
            <li class="md-tabs__item"><a href="https://deploy.seldon.io" class="md-tabs__link">Seldon Enterprise Platform</a></li>
            
            <li class="md-tabs__item"><a href="https://github.com/SeldonIO/seldon-deploy-sdk#seldon-deploy-sdk" class="md-tabs__link">Seldon Enterprise Platform SDK</a></li>
          <li class="md-tabs__item"><a href="../nav/tutorials.html" class="md-tabs__link">教程</a></li>
          <li class="md-tabs__item"><a href="notebooks.html" class="md-tabs__link">笔记本</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="seldon-core documentation" class="md-nav__button md-logo">
      
        <img src="../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../index.html"
       title="seldon-core documentation">Seldon Core Documentation</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/SeldonIO/seldon-core/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Seldon Core
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="../nav/getting-started.html" class="md-nav__link">开始</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../nav/concepts.html" class="md-nav__link">概念</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../nav/configuration.html" class="md-nav__link">配置</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../nav/tutorials.html" class="md-nav__link">教程</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="notebooks.html" class="md-nav__link">笔记本</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#seldon-core" class="md-nav__link">Seldon Core 设置</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id2" class="md-nav__link">预包装推理服务示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#python" class="md-nav__link">Python 语言封装示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id3" class="md-nav__link">专门的框架示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id4" class="md-nav__link">孵化项目示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id5" class="md-nav__link">基于云的基础示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id6" class="md-nav__link">高级机器学习监控</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id7" class="md-nav__link">Seldon Core 批处理</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#mlops" class="md-nav__link">MLOps: 扩展、监控和可观察性</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id8" class="md-nav__link">生产配置及实现</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#ab" class="md-nav__link">AB 测试及渐进式部署</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id9" class="md-nav__link">复杂图示例</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id10" class="md-nav__link">入口</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id11" class="md-nav__link">基础设施</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id12" class="md-nav__link">基准测试和负载测试</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="notebooks.html#id13" class="md-nav__link">升级示例</a>
      
    
    </li></ul>
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../nav/reference.html" class="md-nav__link">参考</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="../nav/contributing.html" class="md-nav__link">贡献</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">"Contents"</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#examples-triton-gpt2-example-azure-setup--page-root" class="md-nav__link">Setup Azure Kubernetes Infrastructure</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Define-Variables" class="md-nav__link">Define Variables</a>
        </li>
        <li class="md-nav__item"><a href="#Azure-account-login" class="md-nav__link">Azure account login</a>
        </li>
        <li class="md-nav__item"><a href="#Create-Resource-Group" class="md-nav__link">Create Resource Group</a>
        </li>
        <li class="md-nav__item"><a href="#Create-AKS-Cluster-and-NodePools" class="md-nav__link">Create AKS Cluster and NodePools</a>
        </li>
        <li class="md-nav__item"><a href="#Connect-to-AKS-Cluster" class="md-nav__link">Connect to AKS Cluster</a>
        </li>
        <li class="md-nav__item"><a href="#Create-GPU-enabled-and-CPU-Node-Pools" class="md-nav__link">Create GPU enabled and CPU Node Pools</a>
        </li>
        <li class="md-nav__item"><a href="#Create-GPU-NodePool-with-GPU-taint" class="md-nav__link">Create GPU NodePool with GPU taint</a>
        </li>
        <li class="md-nav__item"><a href="#Verify-GPU-is-available-on-Kubernetes-Node" class="md-nav__link">Verify GPU is available on Kubernetes Node</a>
        </li>
        <li class="md-nav__item"><a href="#Create-CPU-NodePool-for-running-regular-workloads" class="md-nav__link">Create CPU NodePool for running regular workloads</a>
        </li>
        <li class="md-nav__item"><a href="#Verify-Taints-on-the-Kubernetes-nodes" class="md-nav__link">Verify Taints on the Kubernetes nodes</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#Create-Storage-Account-for-training-data" class="md-nav__link">Create Storage Account for training data</a>
        </li>
        <li class="md-nav__item"><a href="#Install-Kubernetes-Blob-CSI-Driver" class="md-nav__link">Install Kubernetes Blob CSI Driver</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#Create-Persistent-Volume-for-Azure-Blob" class="md-nav__link">Create Persistent Volume for Azure Blob</a>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="../_sources/examples/triton_gpt2_example_azure_setup.nblink.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <div class="admonition note">
<p>This page was generated from <a class="reference external" href="https://github.com/SeldonIO/seldon-core/blob/e665e4994eabf83fb43c68a5f85e96d5c45e91b5/examples/triton_gpt2/AzureSetup.ipynb">examples/triton_gpt2/AzureSetup.ipynb</a>.</p>
</div>
<section id="Setup-Azure-Kubernetes-Infrastructure">
<h1 id="examples-triton-gpt2-example-azure-setup--page-root">Setup Azure Kubernetes Infrastructure<a class="headerlink" href="#examples-triton-gpt2-example-azure-setup--page-root" title="Permalink to this heading">¶</a></h1>
<p>In this notebook we will - Login to Aure account - Create AKS cluster with - <strong>GPU enabled Spot VM nodepool</strong> for running ML elastic training - <strong>CPU VM nodepool</strong> for running typical workloads - Azure Storage Account for hosting model data - Deploy Kubernetes Components - Install Azure Blob CSI Driver to map Blob storage to container as persistent volumes - Create Kubernetes PersistentVolume and PersistentVolumeClaim</p>
<section id="Define-Variables">
<h2 id="Define-Variables">Define Variables<a class="headerlink" href="#Define-Variables" title="Permalink to this heading">¶</a></h2>
<p>Set variables required for the project</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">subscription_id</span> <span class="o">=</span> <span class="s2">"&lt;xxxx-xxxx-xxxx-xxxx&gt;"</span>  <span class="c1"># fill in</span>
<span class="n">resource_group</span> <span class="o">=</span> <span class="s2">"seldon"</span>  <span class="c1"># feel free to replace or use this default</span>
<span class="n">region</span> <span class="o">=</span> <span class="s2">"eastus2"</span>  <span class="c1"># ffeel free to replace or use this default</span>

<span class="n">storage_account_name</span> <span class="o">=</span> <span class="s2">"modeltestsgpt"</span>  <span class="c1"># fill in</span>
<span class="n">storage_container_name</span> <span class="o">=</span> <span class="s2">"gpt2tf"</span>

<span class="n">aks_name</span> <span class="o">=</span> <span class="s2">"modeltests"</span>  <span class="c1"># feel free to replace or use this default</span>
<span class="n">aks_gpupool</span> <span class="o">=</span> <span class="s2">"gpunodes"</span>  <span class="c1"># feel free to replace or use this default</span>
<span class="n">aks_cpupool</span> <span class="o">=</span> <span class="s2">"cpunodes"</span>  <span class="c1"># feel free to replace or use this default</span>
<span class="n">aks_gpu_sku</span> <span class="o">=</span> <span class="s2">"Standard_NC6s_v3"</span>  <span class="c1"># feel free to replace or use this default</span>
<span class="n">aks_cpu_sku</span> <span class="o">=</span> <span class="s2">"Standard_F8s_v2"</span>
</pre></div>
</div>
</div>
</section>
<section id="Azure-account-login">
<h2 id="Azure-account-login">Azure account login<a class="headerlink" href="#Azure-account-login" title="Permalink to this heading">¶</a></h2>
<p>If you are not already logged in to an Azure account, the command below will initiate a login. This will pop up a browser where you can select your login. (if no web browser is available or if the web browser fails to open, use device code flow with <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">login</span> <span class="pre">--use-device-code</span></code> or login in WSL command prompt and proceed to notebook)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-bash notranslate"><div class="highlight"><pre><span></span>%%bash
az<span class="w"> </span>login<span class="w"> </span>-o<span class="w"> </span>table
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>az<span class="w"> </span>account<span class="w"> </span><span class="nb">set</span><span class="w"> </span>--subscription<span class="w"> </span><span class="s2">"</span><span class="nv">$subscription_id</span><span class="s2">"</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>az<span class="w"> </span>account<span class="w"> </span>show
</pre></div>
</div>
</div>
</section>
<section id="Create-Resource-Group">
<h2 id="Create-Resource-Group">Create Resource Group<a class="headerlink" href="#Create-Resource-Group" title="Permalink to this heading">¶</a></h2>
<p>Azure encourages the use of groups to organize all the Azure components you deploy. That way it is easier to find them but also we can delete a number of resources simply by deleting the group.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>az<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span>-l<span class="w"> </span><span class="o">{</span>region<span class="o">}</span><span class="w"> </span>-n<span class="w"> </span><span class="o">{</span>resource_group<span class="o">}</span>
</pre></div>
</div>
</div>
</section>
<section id="Create-AKS-Cluster-and-NodePools">
<h2 id="Create-AKS-Cluster-and-NodePools">Create AKS Cluster and NodePools<a class="headerlink" href="#Create-AKS-Cluster-and-NodePools" title="Permalink to this heading">¶</a></h2>
<p>Below, we create the AKS cluster with default 1 system node (to save time, in production use more nodes as per best practices) in the resource group we created earlier. This step can take 5 or more minutes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="err">!</span><span class="n">az</span> <span class="n">aks</span> <span class="n">create</span> <span class="o">--</span><span class="n">resource</span><span class="o">-</span><span class="n">group</span> <span class="p">{</span><span class="n">resource_group</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">name</span> <span class="p">{</span><span class="n">aks_name</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">node</span><span class="o">-</span><span class="n">vm</span><span class="o">-</span><span class="n">size</span> <span class="n">Standard_D8s_v3</span>  \
    <span class="o">--</span><span class="n">node</span><span class="o">-</span><span class="n">count</span> <span class="mi">1</span> \
    <span class="o">--</span><span class="n">location</span> <span class="p">{</span><span class="n">region</span><span class="p">}</span>  \
    <span class="o">--</span><span class="n">kubernetes</span><span class="o">-</span><span class="n">version</span> <span class="mf">1.18.17</span> \
    <span class="o">--</span><span class="n">node</span><span class="o">-</span><span class="n">osdisk</span><span class="o">-</span><span class="nb">type</span> <span class="n">Ephemeral</span> \
    <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">ssh</span><span class="o">-</span><span class="n">keys</span>
</pre></div>
</div>
</div>
</section>
<section id="Connect-to-AKS-Cluster">
<h2 id="Connect-to-AKS-Cluster">Connect to AKS Cluster<a class="headerlink" href="#Connect-to-AKS-Cluster" title="Permalink to this heading">¶</a></h2>
<p>To configure kubectl to connect to Kubernetes cluster, run the following command</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>az<span class="w"> </span>aks<span class="w"> </span>get-credentials<span class="w"> </span>--resource-group<span class="w"> </span><span class="o">{</span>resource_group<span class="o">}</span><span class="w"> </span>--name<span class="w"> </span><span class="o">{</span>aks_name<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Let’s verify connection by listing the nodes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NAME                                STATUS   ROLES   AGE     VERSION
aks-agentpool-28613018-vmss000000   Ready    agent   28d     v1.19.9
aks-agentpool-28613018-vmss000001   Ready    agent   28d     v1.19.9
aks-agentpool-28613018-vmss000002   Ready    agent   28d     v1.19.9
aks-cpunodes-28613018-vmss000000    Ready    agent   28d     v1.19.9
aks-cpunodes-28613018-vmss000001    Ready    agent   28d     v1.19.9
aks-gpunodes-28613018-vmss000001    Ready    agent   5h27m   v1.19.9
</pre></div></div>
</div>
<p>Taint System node with <code class="docutils literal notranslate"><span class="pre">CriticalAddonsOnly</span></code> taint so it is available only for system workloads</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>-l<span class="w"> </span>kubernetes.azure.com/mode<span class="o">=</span>system<span class="w"> </span><span class="nv">CriticalAddonsOnly</span><span class="o">=</span>true:NoSchedule<span class="w"> </span>--overwrite
</pre></div>
</div>
</div>
</section>
<section id="Create-GPU-enabled-and-CPU-Node-Pools">
<h2 id="Create-GPU-enabled-and-CPU-Node-Pools">Create GPU enabled and CPU Node Pools<a class="headerlink" href="#Create-GPU-enabled-and-CPU-Node-Pools" title="Permalink to this heading">¶</a></h2>
<p>To create GPU enabled nodepool, will use fully configured AKS image that contains the NVIDIA device plugin for Kubenetes, see <a class="reference external" href="https://docs.microsoft.com/en-us/azure/aks/gpu-cluster#use-the-aks-specialized-gpu-image-preview">Use the AKS specialized GPU image (preview)</a>. Creating nodepools could take five or more minutes.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="err">!</span><span class="n">az</span> <span class="n">feature</span> <span class="n">register</span> <span class="o">--</span><span class="n">name</span> <span class="n">GPUDedicatedVHDPreview</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">ContainerService</span>
<span class="err">!</span><span class="n">az</span> <span class="n">feature</span> <span class="nb">list</span> <span class="o">-</span><span class="n">o</span> <span class="n">table</span> <span class="o">--</span><span class="n">query</span> <span class="s2">"[?contains(name, 'Microsoft.ContainerService/GPUDedicatedVHDPreview')].{Name:name,State:properties.state}"</span>
<span class="err">!</span><span class="n">az</span> <span class="n">provider</span> <span class="n">register</span> <span class="o">--</span><span class="n">namespace</span> <span class="n">Microsoft</span><span class="o">.</span><span class="n">ContainerService</span>
<span class="err">!</span><span class="n">az</span> <span class="n">extension</span> <span class="n">add</span> <span class="o">--</span><span class="n">name</span> <span class="n">aks</span><span class="o">-</span><span class="n">preview</span>
</pre></div>
</div>
</div>
</section>
<section id="Create-GPU-NodePool-with-GPU-taint">
<h2 id="Create-GPU-NodePool-with-GPU-taint">Create GPU NodePool with GPU taint<a class="headerlink" href="#Create-GPU-NodePool-with-GPU-taint" title="Permalink to this heading">¶</a></h2>
<p>For more information on Azure Nodepools <a class="reference external" href="https://docs.microsoft.com/en-us/azure/aks/use-multiple-node-pools">https://docs.microsoft.com/en-us/azure/aks/use-multiple-node-pools</a></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="nb">print</span> <span class="p">({</span><span class="n">aks_gpu_sku</span><span class="p">})</span>
<span class="err">!</span><span class="n">az</span> <span class="n">aks</span> <span class="n">nodepool</span> <span class="n">add</span> \
    <span class="o">--</span><span class="n">resource</span><span class="o">-</span><span class="n">group</span> <span class="p">{</span><span class="n">resource_group</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">cluster</span><span class="o">-</span><span class="n">name</span> <span class="p">{</span><span class="n">aks_name</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">name</span> <span class="p">{</span><span class="n">aks_gpupool</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">node</span><span class="o">-</span><span class="n">taints</span> <span class="n">nvidia</span><span class="o">.</span><span class="n">com</span><span class="o">=</span><span class="n">gpu</span><span class="p">:</span><span class="n">NoSchedule</span> \
    <span class="o">--</span><span class="n">node</span><span class="o">-</span><span class="n">count</span> <span class="mi">1</span> \
    <span class="o">--</span><span class="n">node</span><span class="o">-</span><span class="n">vm</span><span class="o">-</span><span class="n">size</span>  <span class="p">{</span><span class="n">aks_gpu_sku</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">aks</span><span class="o">-</span><span class="n">custom</span><span class="o">-</span><span class="n">headers</span> <span class="n">UseGPUDedicatedVHD</span><span class="o">=</span><span class="n">true</span><span class="p">,</span><span class="n">usegen2vm</span><span class="o">=</span><span class="n">true</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{
<span class="ansi-yellow-fg">The behavior of this command has been altered by the following extension: aks-preview</span>
<span class="ansi-red-intense-fg">Node pool gpunodes already exists, please try a different name, use 'aks nodepool list' to get current list of node pool</span>
CPU times: user 275 ms, sys: 79 ms, total: 354 ms
Wall time: 5.38 s
</pre></div></div>
</div>
</section>
<section id="Verify-GPU-is-available-on-Kubernetes-Node">
<h2 id="Verify-GPU-is-available-on-Kubernetes-Node">Verify GPU is available on Kubernetes Node<a class="headerlink" href="#Verify-GPU-is-available-on-Kubernetes-Node" title="Permalink to this heading">¶</a></h2>
<p>Now use the kubectl describe node command to confirm that the GPUs are schedulable. Under the Capacity section, for Standard_NC12 sku the GPU should list as <code class="docutils literal notranslate"><span class="pre">nvidia.com/gpu:</span> <span class="pre">2</span></code></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>kubectl<span class="w"> </span>describe<span class="w"> </span>node<span class="w"> </span>-l<span class="w"> </span><span class="nv">accelerator</span><span class="o">=</span>nvidia<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>nvidia<span class="w"> </span>-A<span class="w"> </span><span class="m">5</span><span class="w"> </span>-B<span class="w"> </span><span class="m">5</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Name:               aks-gpunodes-28613018-vmss000001
Roles:              agent
Labels:             accelerator=nvidia
                    agentpool=gpunodes
                    beta.kubernetes.io/arch=amd64
                    beta.kubernetes.io/instance-type=Standard_NC12
                    beta.kubernetes.io/os=linux
                    failure-domain.beta.kubernetes.io/region=eastus2
--
  cpu:                            12
  ephemeral-storage:              129900528Ki
  hugepages-1Gi:                  0
  hugepages-2Mi:                  0
  memory:                         115387540Ki
  nvidia.com/gpu:                 2
  pods:                           30
Allocatable:
  attachable-volumes-azure-disk:  48
  cpu:                            11780m
  ephemeral-storage:              119716326407
  hugepages-1Gi:                  0
  hugepages-2Mi:                  0
  memory:                         105854100Ki
  nvidia.com/gpu:                 2
  pods:                           30
System Info:
  Machine ID:                 db67bd967e1441febad873ba49d35adc
  System UUID:                f39ce4bc-11c6-8643-8a8a-dfb4998a0524
  Boot ID:                    eb926e42-d4e7-4760-b124-9b09c0e56c57
--
  memory                         275Mi (0%)  850Mi (0%)
  ephemeral-storage              0 (0%)      0 (0%)
  hugepages-1Gi                  0 (0%)      0 (0%)
  hugepages-2Mi                  0 (0%)      0 (0%)
  attachable-volumes-azure-disk  0           0
  nvidia.com/gpu                 0           0
Events:                          &lt;none&gt;
</pre></div></div>
</div>
</section>
<section id="Create-CPU-NodePool-for-running-regular-workloads">
<h2 id="Create-CPU-NodePool-for-running-regular-workloads">Create CPU NodePool for running regular workloads<a class="headerlink" href="#Create-CPU-NodePool-for-running-regular-workloads" title="Permalink to this heading">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="err">!</span><span class="n">az</span> <span class="n">aks</span> <span class="n">nodepool</span> <span class="n">add</span> \
  <span class="o">--</span><span class="n">resource</span><span class="o">-</span><span class="n">group</span> <span class="p">{</span><span class="n">resource_group</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">cluster</span><span class="o">-</span><span class="n">name</span> <span class="p">{</span><span class="n">aks_name</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">name</span> <span class="p">{</span><span class="n">aks_cpupool</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">enable</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">autoscaler</span> \
    <span class="o">--</span><span class="n">node</span><span class="o">-</span><span class="n">osdisk</span><span class="o">-</span><span class="nb">type</span> <span class="n">Ephemeral</span> \
    <span class="o">--</span><span class="nb">min</span><span class="o">-</span><span class="n">count</span> <span class="mi">1</span> \
    <span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="n">count</span> <span class="mi">3</span> \
    <span class="o">--</span><span class="n">node</span><span class="o">-</span><span class="n">vm</span><span class="o">-</span><span class="n">size</span> <span class="p">{</span><span class="n">aks_cpu_sku</span><span class="p">}</span>  \
    <span class="o">--</span><span class="n">node</span><span class="o">-</span><span class="n">osdisk</span><span class="o">-</span><span class="n">size</span> <span class="mi">128</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-yellow-fg">The behavior of this command has been altered by the following extension: aks-preview</span>
{
  "agentPoolType": "VirtualMachineScaleSets",
  "availabilityZones": null,
  "count": 3,
  "enableAutoScaling": true,
  "enableEncryptionAtHost": false,
  "enableFips": false,
  "enableNodePublicIp": false,
  "gpuInstanceProfile": null,
  "id": "/subscriptions/xxxx-xxxx-xxxx-xxxx-xxxxxx/resourcegroups/seldon/providers/Microsoft.ContainerService/managedClusters/modeltests/agentPools/cpunodes",
  "kubeletConfig": null,
  "kubeletDiskType": "OS",
  "linuxOsConfig": null,
  "maxCount": 3,
  "maxPods": 30,
  "minCount": 1,
  "mode": "User",
  "name": "cpunodes",
  "nodeImageVersion": "AKSUbuntu-1804gen2containerd-2021.05.08",
  "nodeLabels": null,
  "nodePublicIpPrefixId": null,
  "nodeTaints": null,
  "orchestratorVersion": "1.19.9",
  "osDiskSizeGb": 128,
  "osDiskType": "Ephemeral",
  "osSku": "Ubuntu",
  "osType": "Linux",
  "podSubnetId": null,
  "powerState": {
    "code": "Running"
  },
  "provisioningState": "Succeeded",
  "proximityPlacementGroupId": null,
  "resourceGroup": "seldon",
  "scaleSetEvictionPolicy": null,
  "scaleSetPriority": null,
  "spotMaxPrice": null,
  "tags": null,
  "type": "Microsoft.ContainerService/managedClusters/agentPools",
  "upgradeSettings": {
    "maxSurge": null
  },
  "vmSize": "Standard_F8s_v2",
  "vnetSubnetId": "/subscriptions/xxxxx-xxxx-xxxx-xxxxx-xxxxxx/resourceGroups/seldon/providers/Microsoft.Network/virtualNetworks/seldon-vnet/subnets/default"
}
CPU times: user 4.17 s, sys: 1.51 s, total: 5.68 s
Wall time: 2min 36s
</pre></div></div>
</div>
</section>
<section id="Verify-Taints-on-the-Kubernetes-nodes">
<h2 id="Verify-Taints-on-the-Kubernetes-nodes">Verify Taints on the Kubernetes nodes<a class="headerlink" href="#Verify-Taints-on-the-Kubernetes-nodes" title="Permalink to this heading">¶</a></h2>
<p>Verify that system pool and have the Taints <code class="docutils literal notranslate"><span class="pre">CriticalAddonsOnly</span></code> and <code class="docutils literal notranslate"><span class="pre">sku=gpu</span></code> respectively</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">'.items[].spec.taints'</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-bold">[
  </span><span class="ansi-bold">{
    </span><span class="ansi-blue-intense-fg ansi-bold">"effect"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"NoSchedule"</span><span class="ansi-bold">,
    </span><span class="ansi-blue-intense-fg ansi-bold">"key"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"CriticalAddonsOnly"</span><span class="ansi-bold">,
    </span><span class="ansi-blue-intense-fg ansi-bold">"value"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"true"</span><span class="ansi-bold">
  </span><span class="ansi-bold">}</span><span class="ansi-bold">
</span><span class="ansi-bold">]</span>
<span class="ansi-bold">[
  </span><span class="ansi-bold">{
    </span><span class="ansi-blue-intense-fg ansi-bold">"effect"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"NoSchedule"</span><span class="ansi-bold">,
    </span><span class="ansi-blue-intense-fg ansi-bold">"key"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"CriticalAddonsOnly"</span><span class="ansi-bold">,
    </span><span class="ansi-blue-intense-fg ansi-bold">"value"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"true"</span><span class="ansi-bold">
  </span><span class="ansi-bold">}</span><span class="ansi-bold">
</span><span class="ansi-bold">]</span>
<span class="ansi-bold">[
  </span><span class="ansi-bold">{
    </span><span class="ansi-blue-intense-fg ansi-bold">"effect"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"NoSchedule"</span><span class="ansi-bold">,
    </span><span class="ansi-blue-intense-fg ansi-bold">"key"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"CriticalAddonsOnly"</span><span class="ansi-bold">,
    </span><span class="ansi-blue-intense-fg ansi-bold">"value"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"true"</span><span class="ansi-bold">
  </span><span class="ansi-bold">}</span><span class="ansi-bold">
</span><span class="ansi-bold">]</span>
<span class="ansi-black-intense-fg ansi-bold">null</span>
<span class="ansi-black-intense-fg ansi-bold">null</span>
<span class="ansi-bold">[
  </span><span class="ansi-bold">{
    </span><span class="ansi-blue-intense-fg ansi-bold">"effect"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"NoSchedule"</span><span class="ansi-bold">,
    </span><span class="ansi-blue-intense-fg ansi-bold">"key"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"sku"</span><span class="ansi-bold">,
    </span><span class="ansi-blue-intense-fg ansi-bold">"value"</span><span class="ansi-bold">: </span><span class="ansi-green-fg">"gpu"</span><span class="ansi-bold">
  </span><span class="ansi-bold">}</span><span class="ansi-bold">
</span><span class="ansi-bold">]</span>
</pre></div></div>
</div>
</section>
</section>
<section id="Create-Storage-Account-for-training-data">
<h1 id="Create-Storage-Account-for-training-data">Create Storage Account for training data<a class="headerlink" href="#Create-Storage-Account-for-training-data" title="Permalink to this heading">¶</a></h1>
<p>In this section of the notebook, we’ll create an Azure blob storage that we’ll use throughout the tutorial. This object store will be used to store input images and save checkpoints. Use <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">cli</span></code> to create the account</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="err">!</span><span class="n">az</span> <span class="n">storage</span> <span class="n">account</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="p">{</span><span class="n">storage_account_name</span><span class="p">}</span> <span class="o">-</span><span class="n">g</span> <span class="p">{</span><span class="n">resource_group</span><span class="p">}</span> <span class="o">--</span><span class="n">query</span> <span class="s1">'provisioningState'</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
"Succeeded"
CPU times: user 674 ms, sys: 214 ms, total: 888 ms
Wall time: 22 s
</pre></div></div>
</div>
<p>Grab the keys of the storage account that was just created.We would need them for binding Kubernetes Persistent Volume. The –quote ‘[0].value’ part of the command simply means to select the value of the zero-th indexed of the set of keys.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">key</span> <span class="o">=</span> <span class="o">!</span>az<span class="w"> </span>storage<span class="w"> </span>account<span class="w"> </span>keys<span class="w"> </span>list<span class="w"> </span>--account-name<span class="w"> </span><span class="o">{</span>storage_account_name<span class="o">}</span><span class="w"> </span>-g<span class="w"> </span><span class="o">{</span>resource_group<span class="o">}</span><span class="w"> </span>--query<span class="w"> </span><span class="s1">'[0].value'</span><span class="w"> </span>-o<span class="w"> </span>tsv
</pre></div>
</div>
</div>
<p>The stdout from the command above is stored in a string array of 1. Select the element in the array.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">storage_account_key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># create storage container</span>

<span class="o">!</span>az<span class="w"> </span>storage<span class="w"> </span>container<span class="w"> </span>create<span class="w"> </span><span class="err">\</span>
    <span class="o">--</span><span class="n">account</span><span class="o">-</span><span class="n">name</span> <span class="p">{</span><span class="n">storage_account_name</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">account</span><span class="o">-</span><span class="n">key</span> <span class="p">{</span><span class="n">storage_account_key</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">name</span> <span class="p">{</span><span class="n">storage_container_name</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{
  "created": true
}

</pre></div></div>
</div>
</section>
<section id="Install-Kubernetes-Blob-CSI-Driver">
<h1 id="Install-Kubernetes-Blob-CSI-Driver">Install Kubernetes Blob CSI Driver<a class="headerlink" href="#Install-Kubernetes-Blob-CSI-Driver" title="Permalink to this heading">¶</a></h1>
<p><a class="reference external" href="https://github.com/kubernetes-sigs/blob-csi-driver">Azure Blob Storage CSI driver for Kubernetes</a> allows Kubernetes to access Azure Storage. We will deploy it using Helm3 package manager as described in the docs <a class="reference external" href="https://github.com/kubernetes-sigs/blob-csi-driver/tree/master/charts">https://github.com/kubernetes-sigs/blob-csi-driver/tree/master/charts</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>az<span class="w"> </span>aks<span class="w"> </span>get-credentials<span class="w"> </span>--resource-group<span class="w"> </span><span class="o">{</span>resource_group<span class="o">}</span><span class="w"> </span>--name<span class="w"> </span><span class="o">{</span>aks_name<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>blob-csi-driver<span class="w"> </span>https://raw.githubusercontent.com/kubernetes-sigs/blob-csi-driver/master/charts
<span class="o">!</span>helm<span class="w"> </span>install<span class="w"> </span>blob-csi-driver<span class="w"> </span>blob-csi-driver/blob-csi-driver<span class="w"> </span>--namespace<span class="w"> </span>kube-system<span class="w"> </span>--version<span class="w"> </span>v1.1.0
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
"blob-csi-driver" already exists with the same configuration, skipping
W0527 23:11:20.183604   13719 warnings.go:70] storage.k8s.io/v1beta1 CSIDriver is deprecated in v1.19+, unavailable in v1.22+; use storage.k8s.io/v1 CSIDriver
W0527 23:11:20.506450   13719 warnings.go:70] storage.k8s.io/v1beta1 CSIDriver is deprecated in v1.19+, unavailable in v1.22+; use storage.k8s.io/v1 CSIDriver
NAME: blob-csi-driver
LAST DEPLOYED: Thu May 27 23:11:19 2021
NAMESPACE: kube-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
The Azure Blob Storage CSI driver is getting deployed to your cluster.

To check Azure Blob Storage CSI driver pods status, please run:

  kubectl --namespace=kube-system get pods --selector="release=blob-csi-driver" --watch
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>kubectl<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="s2">"app.kubernetes.io/instance=blob-csi-driver"</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NAME                                   READY   STATUS    RESTARTS   AGE
csi-blob-controller-7b9db4967c-fbsm2   4/4     Running   0          22s
csi-blob-controller-7b9db4967c-hdglw   4/4     Running   0          22s
csi-blob-node-7tgl8                    3/3     Running   0          22s
csi-blob-node-89rkn                    3/3     Running   0          22s
csi-blob-node-nnhfh                    3/3     Running   0          22s
csi-blob-node-pb584                    3/3     Running   0          22s
csi-blob-node-q6z6t                    3/3     Running   0          22s
csi-blob-node-tq4mh                    3/3     Running   0          22s
</pre></div></div>
</div>
<section id="Create-Persistent-Volume-for-Azure-Blob">
<h2 id="Create-Persistent-Volume-for-Azure-Blob">Create Persistent Volume for Azure Blob<a class="headerlink" href="#Create-Persistent-Volume-for-Azure-Blob" title="Permalink to this heading">¶</a></h2>
<p>For more details on creating <code class="docutils literal notranslate"><span class="pre">PersistentVolume</span></code> using CSI driver refer to <a class="reference external" href="https://github.com/kubernetes-sigs/blob-csi-driver/blob/master/deploy/example/e2e_usage.md">https://github.com/kubernetes-sigs/blob-csi-driver/blob/master/deploy/example/e2e_usage.md</a></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create secret to access storage account</span>
<span class="o">!</span>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>azure-blobsecret<span class="w"> </span>--from-literal<span class="w"> </span><span class="nv">azurestorageaccountname</span><span class="o">={</span>storage_account_name<span class="o">}</span><span class="w"> </span>--from-literal<span class="w"> </span><span class="nv">azurestorageaccountkey</span><span class="o">=</span><span class="s2">"{storage_account_key}"</span><span class="w"> </span>--type<span class="o">=</span>Opaque
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
secret/azure-blobsecret created
</pre></div></div>
</div>
<p>Persistent Volume YAML definition is in <code class="docutils literal notranslate"><span class="pre">azure-blobfules-pv.yaml</span></code> with fields pointing to secret created above and containername we created in storage account:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">csi</span><span class="p">:</span>
<span class="w">  </span><span class="nt">driver</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blob.csi.azure.com</span>
<span class="w">  </span><span class="nt">readOnly</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">volumeHandle</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trainingdata</span><span class="w">  </span><span class="c1"># make sure this volumeid is unique in the cluster</span>
<span class="w">  </span><span class="nt">volumeAttributes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">containerName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">workerdata</span><span class="w"> </span><span class="c1"># !! Modify if changed in Notebook</span>
<span class="w">  </span><span class="nt">nodeStageSecretRef</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">azure-blobsecret</span>
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%writefile</span> azure-blobfuse-pv.yaml
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">PersistentVolume</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">pv</span><span class="o">-</span><span class="n">gptblob</span>

<span class="n">spec</span><span class="p">:</span>
  <span class="n">capacity</span><span class="p">:</span>
    <span class="n">storage</span><span class="p">:</span> <span class="mi">10</span><span class="n">Gi</span>
  <span class="n">accessModes</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">ReadWriteMany</span>
  <span class="n">persistentVolumeReclaimPolicy</span><span class="p">:</span> <span class="n">Retain</span>  <span class="c1"># "Delete" is not supported in static provisioning</span>
  <span class="n">csi</span><span class="p">:</span>
    <span class="n">driver</span><span class="p">:</span> <span class="n">blob</span><span class="o">.</span><span class="n">csi</span><span class="o">.</span><span class="n">azure</span><span class="o">.</span><span class="n">com</span>
    <span class="n">readOnly</span><span class="p">:</span> <span class="n">false</span>
    <span class="n">volumeHandle</span><span class="p">:</span> <span class="n">trainingdata</span>  <span class="c1"># make sure this volumeid is unique in the cluster</span>
    <span class="n">volumeAttributes</span><span class="p">:</span>
      <span class="n">containerName</span><span class="p">:</span> <span class="n">gpt2onnx</span> <span class="c1"># Modify if changed in Notebook</span>
    <span class="n">nodeStageSecretRef</span><span class="p">:</span>
      <span class="n">name</span><span class="p">:</span> <span class="n">azure</span><span class="o">-</span><span class="n">blobsecret</span>
      <span class="n">namespace</span><span class="p">:</span> <span class="n">default</span>
  <span class="n">mountOptions</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">-</span><span class="n">o</span> <span class="n">uid</span><span class="o">=</span><span class="mi">8888</span>     <span class="c1"># user in  Pod security context</span>
    <span class="o">-</span> <span class="o">-</span><span class="n">o</span> <span class="n">allow_other</span>

<span class="o">---</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">PersistentVolumeClaim</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">v1</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">pvc</span><span class="o">-</span><span class="n">gptblob</span>

<span class="n">spec</span><span class="p">:</span>
  <span class="n">accessModes</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">ReadWriteMany</span>
  <span class="n">resources</span><span class="p">:</span>
    <span class="n">requests</span><span class="p">:</span>
      <span class="n">storage</span><span class="p">:</span> <span class="mi">10</span><span class="n">Gi</span>
  <span class="n">volumeName</span><span class="p">:</span> <span class="n">pv</span><span class="o">-</span><span class="n">gptblob</span>
  <span class="n">storageClassName</span><span class="p">:</span> <span class="s2">""</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Overwriting azure-blobfuse-pv.yaml
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create PersistentVolume and PersistenVollumeClaim for container mounts</span>
<span class="o">!</span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w">  </span>azure-blobfuse-pv.yaml
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
persistentvolume/pv-gptblob created
persistentvolumeclaim/pvc-gptblob created
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Verify PVC is bound</span>
<span class="o">!</span>kubectl<span class="w"> </span>get<span class="w"> </span>pv,pvc
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
NAME                          CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS        CLAIM                 STORAGECLASS   REASON   AGE
persistentvolume/pv-blob      10Gi       RWX            Retain           Terminating   default/pvc-blob                              113m
persistentvolume/pv-gptblob   10Gi       RWX            Retain           Bound         default/pvc-gptblob                           18s

NAME                                STATUS        VOLUME       CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/pvc-blob      Terminating   pv-blob      10Gi       RWX                           113m
persistentvolumeclaim/pvc-gptblob   Bound         pv-gptblob   10Gi       RWX                           17s
</pre></div></div>
</div>
<p>In the end of this step you will have AKS cluster and Storage account in resource group. ALK cluster will have cpu and gpu nodepools in addition to system nodepool.</p>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="triton_gpt2_example_azure.html" title="Pretrained GPT2 Model Deployment Example"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> "Previous" </span> Pretrained GPT2 Model Deployment Example </span>
              </div>
            </a>
          
          
            <a href="feedback_reward_custom_metrics.html" title="Stateful Model Feedback Metrics Server"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> "Next" </span> Stateful Model Feedback Metrics Server </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2024, Seldon Technologies Ltd.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>